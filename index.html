<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Spotysafe — Sortez l'esprit tranquille</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --green: #00E87A;
    --green-dark: #00C065;
    --green-glow: rgba(0,232,122,0.2);
    --red: #FF3B5C;
    --orange: #FF8C00;
    --bg: #0A0A0F;
    --bg2: #111118;
    --bg3: #1A1A24;
    --card: #16161F;
    --border: rgba(255,255,255,0.07);
    --text: #F0F0F8;
    --muted: rgba(240,240,248,0.45);
    --accent: #00E87A;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  /* PHONE FRAME */
  .phone {
    width: 390px;
    height: 844px;
    background: var(--bg);
    border-radius: 54px;
    overflow-x: hidden;
    overflow-y: auto;
    scrollbar-width: none;
    position: relative;
    box-shadow: 0 0 0 12px #1C1C1E, 0 0 0 14px #2C2C2E, 0 40px 120px rgba(0,0,0,0.8), 0 0 60px rgba(0,232,122,0.06);
  }

  /* NOTCH */
  .notch {
    position: absolute;
    top: 0; left: 50%;
    transform: translateX(-50%);
    width: 126px; height: 34px;
    background: #0A0A0F;
    border-radius: 0 0 20px 20px;
    z-index: 100;
  }

  /* STATUS BAR */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 28px 0;
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    position: relative;
    z-index: 99;
  }
  .status-bar .time { font-size: 15px; font-weight: 700; }
  .status-icons { display: flex; gap: 6px; align-items: center; }
  .status-icons svg { opacity: 0.9; }

  /* SCREENS */
  .screen {
    position: absolute;
    top: 0; left: 0; right: 0;
    min-height: 100%;
    overflow-y: visible;
    overflow-x: hidden;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    scrollbar-width: none;
    transition: opacity 0.2s ease;
  }
  .screen::-webkit-scrollbar { display: none; }
  .screen.active {
    visibility: visible;
    opacity: 1;
    pointer-events: all;
  }

  /* ── SPLASH SCREEN ── */
  #splash {
    background: radial-gradient(ellipse at 50% 40%, rgba(0,232,122,0.15) 0%, transparent 70%), var(--bg);
  }
  #splash > div {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100%;
    padding-bottom: 40px;
  }
  .splash-logo {
    font-family: 'Syne', sans-serif;
    font-size: 52px;
    font-weight: 800;
    letter-spacing: -2px;
    color: var(--green);
    animation: pulse 2s ease-in-out infinite;
  }
  .splash-logo span { color: var(--text); }
  .splash-tagline {
    color: var(--muted);
    font-size: 14px;
    margin-top: 8px;
    letter-spacing: 0.5px;
  }
  .splash-orb {
    width: 180px; height: 180px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0,232,122,0.3) 0%, transparent 70%);
    position: absolute;
    animation: float 3s ease-in-out infinite;
    filter: blur(20px);
  }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }

  .role-cards {
    display: flex;
    flex-direction: column;
    gap: 14px;
    padding: 0 28px;
    width: 100%;
    margin-top: 48px;
    position: relative;
    z-index: 2;
  }
  .role-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 22px 24px;
    display: flex;
    align-items: center;
    gap: 18px;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .role-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(0,232,122,0.08) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.25s;
  }
  .role-card:active::before { opacity: 1; }
  .role-card:active { transform: scale(0.97); }
  .role-icon {
    width: 52px; height: 52px;
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }
  .role-icon.client { background: rgba(0,232,122,0.15); }
  .role-icon.bar { background: rgba(255,140,0,0.15); }
  .role-info { flex: 1; }
  .role-title {
    font-family: 'Syne', sans-serif;
    font-size: 17px;
    font-weight: 700;
    margin-bottom: 3px;
  }
  .role-desc { font-size: 13px; color: var(--muted); line-height: 1.4; }
  .role-arrow { color: var(--muted); font-size: 18px; }

  /* ── CLIENT SCREEN ── */
  #client { background: var(--bg); }
  
  .client-header {
    padding: 52px 24px 20px;
    background: linear-gradient(to bottom, rgba(0,232,122,0.05), transparent);
  }
  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .app-logo-small {
    font-family: 'Outfit', sans-serif;
    font-size: 22px;
    font-weight: 900;
    letter-spacing: -0.5px;
  }
  .app-logo-small .spoty    { color: rgba(240,240,248,0.65); font-weight: 300; }
  .app-logo-small .safe-txt { color: var(--green); font-weight: 800; text-transform: uppercase; letter-spacing: .02em; }

  /* ── ALERTES ── */
  .alert-threshold {
    padding: 8px 14px; background: var(--card); border: 1px solid var(--border);
    border-radius: 20px; font-size: 12px; font-weight: 600; color: var(--muted);
    cursor: pointer; transition: all .15s;
  }
  .alert-threshold.active { background: rgba(232,184,75,.12); border-color: #E8B84B; color: #E8B84B; }
  .alert-card {
    background: var(--card); border-radius: 14px; padding: 14px 16px;
    margin-bottom: 10px; display: flex; align-items: flex-start; gap: 12px;
    border-left: 3px solid transparent;
  }
  .alert-down     { border-left-color: #FF6B6B; }
  .alert-up       { border-left-color: var(--green); }
  .alert-critical { border-left-color: #FF3B3B; background: rgba(255,59,59,.05); }
  .alert-icon     { font-size: 22px; padding-top: 2px; flex-shrink: 0; }
  .alert-body     { flex: 1; }
  .alert-name     { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 3px; }
  .alert-detail   { font-size: 12px; color: var(--muted); }
  .alert-time     { font-size: 10px; color: var(--muted); margin-top: 4px; opacity: .7; }
  .alert-action   { font-size: 12px; color: var(--green); font-weight: 700; cursor: pointer; padding-top: 2px; white-space: nowrap; }
  .alert-tag      { display: inline-block; border-radius: 6px; padding: 2px 7px; font-size: 10px; font-weight: 800; margin-left: 6px; }
  .tag-down       { background: rgba(255,107,107,.15); color: #FF6B6B; }
  .tag-up         { background: rgba(0,200,120,.12); color: var(--green); }
  .tag-critical   { background: rgba(255,59,59,.15); color: #FF3B3B; }
  .watchlist-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 14px;
    padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;
  }
  .watchlist-score { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 15px; flex-shrink: 0; }

  /* ── SIGNALEMENT ── */
  .report-type-btn {
    background: var(--card); border: 1.5px solid var(--border); border-radius: 14px;
    padding: 14px 10px; text-align: center; font-size: 12px; font-weight: 600;
    color: var(--text); cursor: pointer; transition: all .15s;
  }
  .report-type-btn.active { border-color: var(--green); background: rgba(0,200,120,.08); color: var(--green); }
  .back-btn {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 8px 14px;
    font-size: 13px;
    color: var(--muted);
    cursor: pointer;
  }
  .back-btn:active { opacity: 0.7; }

  .location-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(0,232,122,0.1);
    border: 1px solid rgba(0,232,122,0.25);
    border-radius: 20px;
    padding: 8px 14px;
    font-size: 13px;
    color: var(--green);
    margin-bottom: 16px;
  }
  .location-dot {
    width: 7px; height: 7px;
    background: var(--green);
    border-radius: 50%;
    animation: blink 1.5s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 4px;
  }
  .section-sub { font-size: 13px; color: var(--muted); }

  /* MAP */
  .map-container {
    margin: 0 24px 20px;
    border-radius: 20px;
    overflow: hidden;
    height: 180px;
    background: var(--card);
    border: 1px solid var(--border);
    position: relative;
  }
  /* Leaflet overrides dark */
  .leaflet-tile-pane { filter: brightness(0.85) saturate(0.7); }
  .leaflet-control-attribution { display: none; }
  .leaflet-control-zoom { display: none; }
  .spotysafe-marker {
    background: #00E87A;
    color: #000;
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 800;
    padding: 4px 8px;
    border-radius: 10px;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,232,122,0.5);
    cursor: pointer;
  }
  .spotysafe-marker.orange {
    background: #FF8C00;
    box-shadow: 0 4px 12px rgba(255,140,0,0.5);
  }

  /* BAR CARDS */
  .bars-list { padding: 0 24px 96px; display: flex; flex-direction: column; gap: 14px; }

  .bar-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 18px 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .bar-card::after {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--green);
    border-radius: 0 2px 2px 0;
  }
  .bar-card:active { transform: scale(0.98); }
  .bar-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .bar-name {
    font-family: 'Syne', sans-serif;
    font-size: 17px;
    font-weight: 700;
  }
  .bar-type { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .score-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(0,232,122,0.1);
    border: 1px solid rgba(0,232,122,0.25);
    border-radius: 14px;
    padding: 8px 14px;
    min-width: 62px;
  }
  .score-badge.orange {
    background: rgba(255,140,0,0.1);
    border-color: rgba(255,140,0,0.25);
  }
  .score-num {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--green);
    line-height: 1;
  }
  .score-num.orange { color: var(--orange); }
  .score-label { font-size: 10px; color: var(--muted); margin-top: 2px; }

  .score-bar-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .score-bar-track {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    overflow: hidden;
  }
  .score-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--green-dark), var(--green));
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .score-bar-fill.orange {
    background: linear-gradient(90deg, #CC7000, var(--orange));
  }
  .score-pct { font-size: 12px; color: var(--muted); width: 32px; text-align: right; }

  .bar-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--muted);
  }
  .bar-meta-item { display: flex; align-items: center; gap: 4px; }

  .certif-pills {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .certif-pill {
    background: rgba(0,232,122,0.08);
    border: 1px solid rgba(0,232,122,0.15);
    border-radius: 8px;
    padding: 3px 9px;
    font-size: 11px;
    color: var(--green);
  }
  .certif-pill.warning {
    background: rgba(255,59,92,0.08);
    border-color: rgba(255,59,92,0.15);
    color: var(--red);
  }

  /* TAB BAR */
  .tab-bar {
    position: fixed;
    bottom: 0;
    width: 390px;
    height: 84px;
    background: rgba(10,10,15,0.97);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: none;
    align-items: flex-start;
    padding-top: 12px;
    z-index: 200;
    flex-shrink: 0;
  }
  .tab-bar.visible { display: flex; }
  .tab-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    padding: 4px 0;
  }
  .tab-icon { font-size: 22px; opacity: 0.4; display:flex; align-items:center; justify-content:center; width:28px; height:28px; transition: opacity .2s; }
  .tab-icon.active { opacity: 1; }
  .tab-txt { font-size: 10px; color: var(--muted); }
  .tab-txt.active { color: var(--green); }

  /* ── BAR OWNER SCREEN ── */
  #barowner { background: var(--bg); }

  .bar-header {
    padding: 52px 24px 24px;
    background: linear-gradient(to bottom, rgba(255,140,0,0.06), transparent);
  }
  .bar-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .establishment-name {
    font-family: 'Syne', sans-serif;
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 4px;
  }
  .establishment-sub { font-size: 13px; color: var(--muted); }

  /* BIG SCORE */
  .big-score-card {
    margin: 0 24px 20px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 28px 24px;
    position: relative;
    overflow: hidden;
  }
  .big-score-card::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 160px; height: 160px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,140,0,0.12) 0%, transparent 70%);
  }
  .score-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .big-score-num {
    font-family: 'Syne', sans-serif;
    font-size: 72px;
    font-weight: 800;
    color: var(--orange);
    line-height: 1;
  }
  .big-score-denom {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 600;
    color: var(--muted);
    align-self: flex-end;
    padding-bottom: 10px;
  }
  .score-ring {
    width: 90px; height: 90px;
    position: relative;
  }
  .score-ring svg { transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 8; }
  .ring-fill { fill: none; stroke: var(--orange); stroke-width: 8; stroke-linecap: round;
    stroke-dasharray: 226; stroke-dashoffset: 45; transition: stroke-dashoffset 1s ease; }
  .ring-label {
    position: absolute;
    inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-size: 18px; font-weight: 800;
    color: var(--orange);
  }

  .score-label-main {
    font-size: 13px; color: var(--muted); margin-bottom: 6px;
  }
  .score-trend {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(0,232,122,0.1);
    border: 1px solid rgba(0,232,122,0.2);
    border-radius: 10px;
    padding: 4px 10px;
    font-size: 12px;
    color: var(--green);
    font-weight: 600;
  }

  /* CRITERIA */
  .criteria-section { padding: 0 24px 20px; }
  .criteria-title {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 14px;
  }
  .criteria-list { display: flex; flex-direction: column; gap: 10px; }
  .criteria-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .criteria-item:active { transform: scale(0.98); }
  .criteria-icon {
    width: 40px; height: 40px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .ci-green { background: rgba(0,232,122,0.1); }
  .ci-orange { background: rgba(255,140,0,0.1); }
  .ci-red { background: rgba(255,59,92,0.1); }
  .criteria-info { flex: 1; }
  .criteria-name { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
  .criteria-bar-wrap { display: flex; align-items: center; gap: 8px; }
  .criteria-bar-track {
    flex: 1; height: 4px;
    background: rgba(255,255,255,0.06);
    border-radius: 2px; overflow: hidden;
  }
  .criteria-bar-fill {
    height: 100%; border-radius: 2px;
    background: var(--green);
  }
  .criteria-bar-fill.orange { background: var(--orange); }
  .criteria-bar-fill.red { background: var(--red); }
  .criteria-pct { font-size: 12px; color: var(--muted); }
  .criteria-status {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 8px;
    font-weight: 600;
  }
  .cs-ok { background: rgba(0,232,122,0.1); color: var(--green); }
  .cs-warn { background: rgba(255,140,0,0.1); color: var(--orange); }
  .cs-bad { background: rgba(255,59,92,0.1); color: var(--red); }

  /* ACTIONS */
  .actions-section { padding: 0 24px 96px; }
  .actions-title {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 14px;
  }
  .action-btn {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.2s;
  }
  .action-btn:active { transform: scale(0.98); opacity: 0.8; }
  .action-btn-icon {
    width: 44px; height: 44px;
    border-radius: 14px;
    background: rgba(0,232,122,0.1);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }
  .action-btn-icon.orange { background: rgba(255,140,0,0.1); }
  .action-btn-text { flex: 1; }
  .action-btn-title { font-size: 15px; font-weight: 500; }
  .action-btn-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .action-btn-arrow { color: var(--muted); }

  /* MODAL DETAIL BAR */
  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: none;
    align-items: flex-end;
  }
  .modal-overlay.open { display: flex; }
  .modal-sheet {
    width: 100%;
    background: var(--bg2);
    border-radius: 28px 28px 0 0;
    border-top: 1px solid var(--border);
    padding: 12px 24px 40px;
    max-height: 80%;
    overflow-y: auto;
  }
  .modal-sheet::-webkit-scrollbar { display: none; }
  .modal-handle {
    width: 36px; height: 4px;
    background: rgba(255,255,255,0.15);
    border-radius: 2px;
    margin: 0 auto 20px;
  }
  .modal-bar-name {
    font-family: 'Syne', sans-serif;
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 4px;
  }
  .modal-bar-addr { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
  .modal-score-big {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    background: var(--card);
    border-radius: 18px;
    padding: 16px 20px;
    border: 1px solid var(--border);
  }
  .modal-score-num {
    font-family: 'Syne', sans-serif;
    font-size: 48px;
    font-weight: 800;
    color: var(--green);
    line-height: 1;
  }
  .modal-score-num.orange { color: var(--orange); }
  .modal-score-info { flex: 1; }
  .modal-score-label { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
  .modal-score-bar-track {
    height: 8px;
    background: rgba(255,255,255,0.06);
    border-radius: 4px; overflow: hidden;
  }
  .modal-score-bar-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, var(--green-dark), var(--green));
  }
  .modal-score-bar-fill.orange {
    background: linear-gradient(90deg, #CC7000, var(--orange));
  }
  .modal-section-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 12px;
  }
  .modal-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .modal-detail-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px 14px;
  }
  .modal-detail-label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .modal-detail-value { font-size: 14px; font-weight: 600; }
  .modal-detail-value.green { color: var(--green); }
  .modal-detail-value.orange { color: var(--orange); }
  .modal-detail-value.red { color: var(--red); }
  .modal-cta {
    width: 100%;
    background: var(--green);
    color: #000;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    border: none;
    border-radius: 16px;
    padding: 17px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    margin-top: 8px;
    transition: all 0.2s;
  }
  .modal-cta:active { transform: scale(0.97); background: var(--green-dark); }

  /* TOAST */
  .toast {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px 20px;
    font-size: 13px;
    white-space: nowrap;
    z-index: 300;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Animations d'entrée */
  @keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .bar-card { animation: slideUp 0.4s ease both; }
  .bar-card:nth-child(1) { animation-delay: 0.1s; }
  .bar-card:nth-child(2) { animation-delay: 0.2s; }
  .bar-card:nth-child(3) { animation-delay: 0.3s; }

  /* PARTNERS SECTION */
  .partners-screen { display: none; padding: 52px 24px 100px; }
  .partners-screen.active { display: block; }

  .search-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 12px 16px;
    margin-bottom: 8px;
  }
  .search-bar input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    color: var(--text);
  }
  .search-bar input::placeholder { color: var(--muted); }
  .search-bar .search-icon { font-size: 18px; }

  .filter-pills {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
    margin-bottom: 20px;
    scrollbar-width: none;
  }
  .filter-pills::-webkit-scrollbar { display: none; }
  .filter-pill {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    white-space: nowrap;
  }
  .filter-pill.active {
    background: rgba(0,232,122,0.12);
    border-color: rgba(0,232,122,0.35);
    color: var(--green);
  }
  .filter-pill:active { transform: scale(0.95); }
  #clientMapFilters .filter-pill {
    white-space: normal;
    font-size: 11px;
    font-weight: 600;
    border-radius: 10px;
  }
  #clientMapFilters .filter-pill.active {
    font-weight: 700;
  }

  .partner-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 18px 20px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .partner-card:active { transform: scale(0.98); }
  .partner-card-top {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    margin-bottom: 12px;
  }
  .partner-logo {
    width: 52px; height: 52px;
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
    border: 1px solid var(--border);
  }
  .partner-info { flex: 1; }
  .partner-name {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 2px;
  }
  .partner-type { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  .partner-badges { display: flex; gap: 6px; flex-wrap: wrap; }
  .partner-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 600;
  }
  .pb-agréé { background: rgba(0,232,122,0.1); color: var(--green); border: 1px solid rgba(0,232,122,0.2); }
  .pb-local { background: rgba(74,158,255,0.1); color: #4A9EFF; border: 1px solid rgba(74,158,255,0.2); }
  .pb-rapide { background: rgba(255,140,0,0.1); color: var(--orange); border: 1px solid rgba(255,140,0,0.2); }
  .pb-certif { background: rgba(160,100,255,0.1); color: #A064FF; border: 1px solid rgba(160,100,255,0.2); }

  .partner-divider {
    height: 1px;
    background: var(--border);
    margin-bottom: 12px;
  }
  .partner-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .partner-meta-item { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
  .partner-price {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }
  .partner-price span { font-size: 11px; font-weight: 400; color: var(--muted); }

  .partner-services {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 14px;
  }
  .partner-service {
    background: var(--bg3);
    border-radius: 8px;
    padding: 4px 10px;
    font-size: 11px;
    color: var(--muted);
  }

  .partner-cta {
    display: flex;
    gap: 8px;
  }
  .partner-btn {
    flex: 1;
    padding: 11px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }
  .partner-btn:active { transform: scale(0.97); }
  .partner-btn-primary {
    background: var(--green);
    color: #000;
  }
  .partner-btn-secondary {
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
  }

  .partners-header { margin-bottom: 20px; }
  .partners-count { font-size: 13px; color: var(--muted); margin-top: 4px; }

  /* Owner sub-screens */
  .owner-sub { display: none; }
  .owner-sub.active { display: block; }

  /* Desktop hint */
  @media (min-width: 500px) {
    body { background: #070708; }
  }

  /* ── PIN ADMIN ── */
  .pin-dot {
    width: 14px; height: 14px; border-radius: 50%;
    border: 2px solid rgba(255,59,59,0.4);
    background: transparent;
    transition: all .15s;
  }
  .pin-dot.filled { background: #FF3B3B; border-color: #FF3B3B; box-shadow: 0 0 8px rgba(255,59,59,.4); }
  .pin-dot.error  { background: #FF3B3B; border-color: #FF3B3B; animation: shake .4s ease; }
  .pin-key {
    background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);
    border-radius: 14px; height: 60px; display: flex; align-items: center;
    justify-content: center; font-family: 'Syne',sans-serif; font-size: 22px;
    font-weight: 700; color: var(--white); cursor: pointer; transition: all .12s;
    user-select: none;
  }
  .pin-key:active { background: rgba(255,59,59,.15); border-color: rgba(255,59,59,.3); transform: scale(.94); }
  .pin-key-action { background: transparent; border-color: transparent; font-size: 13px !important; }
  @keyframes shake {
    0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)}
    40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)}
  }

  /* ── MODE SOIRÉE — style festif ── */
  .s-zone {
    padding: 8px 16px;
    background: rgba(255,255,255,.06);
    border: 1.5px solid rgba(255,255,255,.1);
    border-radius: 20px; font-size: 12px; font-weight: 700;
    color: rgba(255,255,255,.5); cursor: pointer;
    transition: all .2s; white-space: nowrap;
  }
  .s-zone.active {
    border-color: #C060FF; color: #fff;
    background: rgba(160,40,255,.25);
    box-shadow: 0 0 14px rgba(160,40,255,.3);
  }
  .s-vibe {
    background: rgba(255,255,255,.05);
    border: 1.5px solid rgba(255,255,255,.08);
    border-radius: 16px; padding: 14px 12px;
    display: flex; align-items: center; gap: 10px;
    cursor: pointer; transition: all .2s;
  }
  .s-vibe.active {
    border-color: #C060FF;
    background: rgba(160,40,255,.2);
    box-shadow: 0 0 18px rgba(160,40,255,.25);
  }
  .s-score {
    padding: 8px 16px;
    background: rgba(255,255,255,.05);
    border: 1.5px solid rgba(255,255,255,.08);
    border-radius: 20px; font-size: 12px; font-weight: 700;
    color: rgba(255,255,255,.45); cursor: pointer; transition: all .2s;
  }
  .s-score.active {
    border-color: #00C878; color: #00C878;
    background: rgba(0,200,120,.15);
    box-shadow: 0 0 14px rgba(0,200,120,.2);
  }
  .s-stop {
    display: flex; align-items: flex-start; gap: 14px;
    padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,.08);
    position: relative;
  }
  .s-stop:last-child { border-bottom: none; }
  .s-stop-num {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 900; flex-shrink: 0; margin-top: 2px;
  }
  .s-history-card {
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 16px; padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    cursor: pointer; margin-bottom: 8px;
    transition: background .2s;
  }
  .s-history-card:active { background: rgba(255,255,255,.09); }
  /* Anciennes classes rétrocompat */
  .soiree-zone  { display:none; }
  .soiree-vibe  { display:none; }
  .soiree-score { display:none; }
  .soiree-stop  { display:none; }
  .soiree-number {
    width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 12px; font-weight: 900; flex-shrink: 0;
    margin-top: 2px;
  }
  .soiree-connector {
    position: absolute; left: 13px; top: 42px; bottom: -14px; width: 2px;
    background: linear-gradient(to bottom, rgba(160,100,255,.4), transparent);
  }

</style>
</head>
<body>

<!-- PHONE FRAME -->
<div class="phone">
  <div class="notch"></div>

  <!-- STATUS BAR -->
  <div class="status-bar">
    <span class="time" id="clock">09:41</span>
    <div class="status-icons">
      <svg width="17" height="12" viewBox="0 0 17 12" fill="white">
        <rect x="0" y="3" width="3" height="9" rx="1" opacity="0.3"/>
        <rect x="4.5" y="2" width="3" height="10" rx="1" opacity="0.5"/>
        <rect x="9" y="0" width="3" height="12" rx="1" opacity="0.7"/>
        <rect x="13.5" y="0" width="3" height="12" rx="1"/>
      </svg>
      <svg width="16" height="12" viewBox="0 0 16 12" fill="white">
        <path d="M8 2.4C5.6 2.4 3.4 3.4 1.8 5L0 3.2C2.2 1.2 5 0 8 0s5.8 1.2 8 3.2L14.2 5C12.6 3.4 10.4 2.4 8 2.4z"/>
        <path d="M8 6.4c-1.4 0-2.6.6-3.5 1.5L3 6.4C4.3 5 6 4.2 8 4.2s3.7.8 5 2.2l-1.5 1.5C10.6 7 9.4 6.4 8 6.4z"/>
        <circle cx="8" cy="11" r="1.5"/>
      </svg>
      <svg width="25" height="12" viewBox="0 0 25 12" fill="white">
        <rect x="0" y="1" width="21" height="10" rx="3" stroke="white" stroke-width="1.5" fill="none" opacity="0.4"/>
        <rect x="22" y="4" width="3" height="4" rx="1" opacity="0.4"/>
        <rect x="1.5" y="2.5" width="16" height="7" rx="2" fill="white"/>
      </svg>
    </div>
  </div>

  <!-- ════════ SPLASH SCREEN ════════ -->
  <div class="screen active" id="splash">
    <div style="display:flex;flex-direction:column;align-items:center;padding:40px 28px 48px;min-height:100%;">
      <div class="splash-orb"></div>
      <div style="position:relative;z-index:2;text-align:center;margin-bottom:60px;">
        <div class="splash-logo" style="font-size:0"><svg width="208" height="52" viewBox="0 0 310 76" fill="none" xmlns="http://www.w3.org/2000/svg">
<defs>
  <linearGradient id="Lgo" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#F5D07A"/><stop offset="50%" stop-color="#E8B84B"/><stop offset="100%" stop-color="#C9962A"/></linearGradient>
  <linearGradient id="Lgf" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00C878" stop-opacity=".18"/><stop offset="100%" stop-color="#00C878" stop-opacity=".04"/></linearGradient>
  <filter id="Lgg"><feGaussianBlur stdDeviation="5"/></filter>
</defs>
<ellipse cx="35" cy="40" rx="28" ry="22" fill="#C9962A" opacity=".12" filter="url(#Lgg)"/>
<path d="M35 5 L62 38 L35 71 L8 38 Z" fill="url(#Lgf)"/>
<path d="M35 5 L62 38 L35 71 L8 38 Z" fill="none" stroke="url(#Lgo)" stroke-width="2.2"/>
<path d="M35 5 L35 38 M8 38 L62 38 M35 38 L35 71" stroke="url(#Lgo)" stroke-width=".6" opacity=".4"/>
<path d="M25 28 C25 24.7 27.7 22 31 22 L39 22 C42.3 22 45 24.7 45 28 C45 31.3 42.3 34 39 34 L31 34 C27.7 34 25 36.7 25 40 C25 43.3 27.7 46 31 46 L39 46 C42.3 46 45 43.3 45 40" stroke="#00C878" stroke-width="2.8" stroke-linecap="round" fill="none"/>
<circle cx="35" cy="7"  r="2.4" fill="url(#Lgo)"/>
<circle cx="35" cy="69" r="2"   fill="url(#Lgo)" opacity=".8"/>
<circle cx="10" cy="38" r="1.5" fill="url(#Lgo)" opacity=".6"/>
<circle cx="60" cy="38" r="1.5" fill="url(#Lgo)" opacity=".6"/>
<text x="77" y="44" font-family="Outfit,sans-serif" font-weight="900" font-size="34" letter-spacing="-1">
  <tspan fill="rgba(240,240,248,0.65)" font-weight="300">Spoty</tspan><tspan fill="#00C878" font-weight="900">SAFE</tspan>
</text>
<circle cx="170" cy="14" r="4.2" fill="url(#Lgo)"/>
</svg></div>
        <div class="splash-tagline" style="margin-top:12px;font-size:13px;letter-spacing:0.5px;">Parce que chaque sortie compte</div>
      </div>
      <div class="role-cards" style="margin-top:0;">

        <!-- CLIENT — Style B -->
        <div class="role-card" onclick="goTo('client')" style="border-color:rgba(0,200,120,0.2);">
          <div class="role-icon client" style="background:linear-gradient(135deg,#003d22,#005c34);border-radius:16px;">
            <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
              <path d="M14 3L5 8v5c0 5.5 3.8 10.7 9 12 5.2-1.3 9-6.5 9-12V8L14 3z"
                fill="rgba(0,200,120,.2)" stroke="#00C878" stroke-width="1.7"/>
              <path d="M10 14l3 3 5-5" stroke="#00C878" stroke-width="2.1"
                stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="role-info">
            <div class="role-title">Je suis un client</div>
            <div class="role-desc">Trouvez des bars sécurisés près de vous — pilote Tours &amp; Paris</div>
          </div>
          <div class="role-arrow" style="color:var(--green);">›</div>
        </div>

        <!-- GÉRANT — Style B -->
        <div class="role-card" onclick="goTo('barowner')" style="border-color:rgba(232,184,75,0.2);">
          <div class="role-icon bar" style="background:linear-gradient(135deg,#3d2e00,#5c4500);border-radius:16px;">
            <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
              <path d="M14 3l2.5 5H22l-4.1 3 1.6 5L14 13l-5.5 3 1.6-5L6 8h5.5z"
                fill="rgba(232,184,75,.25)" stroke="#E8B84B" stroke-width="1.6"/>
              <rect x="9" y="16" width="10" height="9" rx="2" stroke="#E8B84B" stroke-width="1.7"/>
              <path d="M11 16v-2.5a3 3 0 016 0V16" stroke="#E8B84B" stroke-width="1.7" stroke-linecap="round"/>
              <circle cx="14" cy="21" r="1.4" fill="#E8B84B"/>
            </svg>
          </div>
          <div class="role-info">
            <div class="role-title">Je gère un établissement</div>
            <div class="role-desc">Gratuit · Score public + badge vitrine certifié</div>
          </div>
          <div class="role-arrow" style="color:#E8B84B;">›</div>
        </div>

        <!-- PARENT — Style B -->
        <div class="role-card" onclick="goTo('parent')" style="border-color:rgba(160,100,255,0.25);">
          <div class="role-icon" style="background:linear-gradient(135deg,#1a003d,#2d0060);border-radius:16px;width:52px;height:52px;display:flex;align-items:center;justify-content:center;">
            <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
              <circle cx="10" cy="9" r="3.8" fill="rgba(160,100,255,.25)" stroke="#A064FF" stroke-width="1.7"/>
              <path d="M3 23c0-3.8 3-6.8 7-6.8" stroke="#A064FF" stroke-width="1.7" stroke-linecap="round"/>
              <circle cx="20" cy="11" r="2.8" stroke="#00C878" stroke-width="1.5"/>
              <path d="M25 16c-.6-2-2.6-3.3-4.5-2.8" stroke="#00C878" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M14 23c0-3.2 2.7-5.8 6-5.8S26 19.8 26 23" stroke="#00C878" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M14 15l2 2" stroke="#E8B84B" stroke-width="1.5" stroke-linecap="round"/>
              <circle cx="13.5" cy="15.5" r="1" fill="#E8B84B"/>
            </svg>
          </div>
          <div class="role-info">
            <div class="role-title">Je suis parent</div>
            <div class="role-desc">Suivez la position de votre enfant · Sachez s'il est dans un lieu sécurisé</div>
          </div>
          <div class="role-arrow" style="color:#A064FF;">›</div>
        </div>

      </div>

        <!-- ADMIN — Bouton discret -->
        <div style="padding:0 28px;margin-top:8px;text-align:center;">
          <div onclick="goTo('admin')"
            style="display:inline-flex;align-items:center;gap:7px;padding:7px 14px 7px 10px;
              background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);
              border-radius:20px;cursor:pointer;transition:all .2s;
              color:rgba(240,240,248,0.3);font-size:11px;font-weight:600;letter-spacing:.04em;"
            onmouseover="this.style.borderColor='rgba(255,59,59,0.2)';this.style.color='rgba(255,59,59,0.5)';"
            onmouseout="this.style.borderColor='rgba(255,255,255,0.07)';this.style.color='rgba(240,240,248,0.3)';">
            <svg width="12" height="12" viewBox="0 0 28 28" fill="none" style="opacity:.5;">
              <circle cx="10" cy="13" r="5.5" stroke="currentColor" stroke-width="2.2"/>
              <circle cx="10" cy="13" r="2" fill="currentColor"/>
              <path d="M14 15.5L23 20.5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
              <path d="M19.5 19v3M22.5 17.5v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Administration
          </div>
        </div>

      <div style="margin-top:24px;font-size:12px;color:rgba(240,240,248,0.25);text-align:center;line-height:1.5;">
        Données ERP • Certificats de sécurité<br>Gratuit pour les gérants · Transparent pour tous
      </div>
    </div>
  </div>

  <!-- ════════ ADMIN SCREEN ════════ -->
  <!-- ════════ ADMIN SCREEN — DESIGN INSTITUTIONNEL ════════ -->
  <div class="screen" id="admin" style="background:#080A0F;">

    <!-- ── HEADER INSTITUTIONNEL ── -->
    <div style="padding:20px 18px 0;border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:rgba(240,240,248,.22);letter-spacing:.16em;text-transform:uppercase;">SPOTYSAFE</div>
          <div style="width:1px;height:12px;background:rgba(255,255,255,.12);"></div>
          <div style="font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:rgba(240,240,248,.22);letter-spacing:.12em;">ADMINISTRATION</div>
          <div style="background:#FF3B3B;color:white;font-family:'DM Mono',monospace;font-size:8px;font-weight:700;letter-spacing:.14em;border-radius:2px;padding:2px 6px;">LIVE</div>
        </div>
        <div onclick="goTo('splash')" style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(240,240,248,.3);cursor:pointer;letter-spacing:.06em;">← EXIT</div>
      </div>
      <div style="display:flex;align-items:baseline;gap:12px;margin-top:10px;">
        <div style="font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:#F0F0F8;letter-spacing:-.5px;" id="adminDate">DIM 15 FÉV 2026</div>
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:rgba(240,240,248,.25);">Vue nationale consolidée</div>
      </div>
    </div>

    <div style="padding:0 18px 100px;overflow-y:auto;">

      <!-- ── TABLEAU KPIs PRINCIPAL ── -->
      <div style="border:1px solid rgba(255,255,255,.07);border-radius:0;margin-top:16px;overflow:hidden;">
        <!-- Ligne header tableau -->
        <div style="display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid rgba(255,255,255,.06);">
          <div style="padding:4px 12px;font-family:'DM Mono',monospace;font-size:8px;font-weight:600;color:rgba(240,240,248,.2);letter-spacing:.14em;border-right:1px solid rgba(255,255,255,.06);">REVENUS RÉCURRENTS</div>
          <div style="padding:4px 12px;font-family:'DM Mono',monospace;font-size:8px;font-weight:600;color:rgba(240,240,248,.2);letter-spacing:.14em;">UTILISATEURS ACTIFS</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid rgba(255,255,255,.06);">
          <div style="padding:14px 12px;border-right:1px solid rgba(255,255,255,.06);">
            <div style="font-family:'DM Mono',monospace;font-size:28px;font-weight:700;color:#00E87A;letter-spacing:-1px;line-height:1;">258 K€</div>
            <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:#00E87A;">▲ +34.2%</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:rgba(240,240,248,.2);">MoM</span>
            </div>
            <div style="margin-top:8px;height:1px;background:rgba(255,255,255,.06);position:relative;">
              <div style="position:absolute;top:0;left:0;height:100%;width:29%;background:#00E87A;"></div>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);margin-top:4px;">OBJ AN 1 · 885 K€ · 29%</div>
          </div>
          <div style="padding:14px 12px;">
            <div style="font-family:'DM Mono',monospace;font-size:28px;font-weight:700;color:#4A9EFF;letter-spacing:-1px;line-height:1;">4 821</div>
            <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:#4A9EFF;">▲ +12.3%</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:rgba(240,240,248,.2);">/sem</span>
            </div>
            <div style="margin-top:8px;height:1px;background:rgba(255,255,255,.06);position:relative;">
              <div style="position:absolute;top:0;left:0;height:100%;width:48%;background:#4A9EFF;"></div>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);margin-top:4px;">OBJ AN 1 · 10 000 · 48%</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid rgba(255,255,255,.06);">
          <div style="padding:4px 12px;font-family:'DM Mono',monospace;font-size:8px;font-weight:600;color:rgba(240,240,248,.2);letter-spacing:.14em;border-right:1px solid rgba(255,255,255,.06);">CONTRATS ERP</div>
          <div style="padding:4px 12px;font-family:'DM Mono',monospace;font-size:8px;font-weight:600;color:rgba(240,240,248,.2);letter-spacing:.14em;">SIGNALEMENTS</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;">
          <div style="padding:14px 12px;border-right:1px solid rgba(255,255,255,.06);">
            <div style="font-family:'DM Mono',monospace;font-size:28px;font-weight:700;color:#F5C842;letter-spacing:-1px;line-height:1;">1 247</div>
            <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:#F5C842;">▲ +89</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:rgba(240,240,248,.2);">ce mois</span>
            </div>
            <div style="display:flex;gap:0;margin-top:8px;height:1px;">
              <div style="width:59%;background:rgba(245,200,66,.3);"></div>
              <div style="width:41%;background:#F5C842;"></div>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);margin-top:4px;">FREE 743 · PRO 504</div>
          </div>
          <div style="padding:14px 12px;">
            <div style="font-family:'DM Mono',monospace;font-size:28px;font-weight:700;color:#FF6B6B;letter-spacing:-1px;line-height:1;">312</div>
            <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:#00E87A;">✓ 214</span>
              <span style="font-family:'DM Mono',monospace;font-size:9px;color:#F5C842;">⧖ 98</span>
            </div>
            <div style="display:flex;gap:0;margin-top:8px;height:1px;">
              <div style="width:69%;background:#00E87A;"></div>
              <div style="width:31%;background:#F5C842;"></div>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);margin-top:4px;">RÉSOLUS 69% · EN COURS 31%</div>
          </div>
        </div>
      </div>

      <!-- ── LIGNE MÉTRIQUES SECONDAIRES ── -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;margin-top:8px;border:1px solid rgba(255,255,255,.07);overflow:hidden;">
        <div style="padding:10px 12px;border-right:1px solid rgba(255,255,255,.06);text-align:center;">
          <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);letter-spacing:.1em;margin-bottom:5px;">CERTIF.</div>
          <div style="font-family:'DM Mono',monospace;font-size:20px;font-weight:700;color:#B47FFF;">18</div>
          <div style="font-family:'DM Mono',monospace;font-size:7px;color:rgba(180,127,255,.5);margin-top:2px;">partenaires</div>
        </div>
        <div style="padding:10px 12px;border-right:1px solid rgba(255,255,255,.06);text-align:center;">
          <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);letter-spacing:.1em;margin-bottom:5px;">SCORE MOY.</div>
          <div style="font-family:'DM Mono',monospace;font-size:20px;font-weight:700;color:#00E87A;">79.4</div>
          <div style="font-family:'DM Mono',monospace;font-size:7px;color:rgba(0,232,122,.4);margin-top:2px;">▲ +2 pts/mois</div>
        </div>
        <div style="padding:10px 12px;text-align:center;">
          <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);letter-spacing:.1em;margin-bottom:5px;">ALERTES P.</div>
          <div style="font-family:'DM Mono',monospace;font-size:20px;font-weight:700;color:#FF6B9D;">891</div>
          <div style="font-family:'DM Mono',monospace;font-size:7px;color:rgba(255,107,157,.4);margin-top:2px;">ce mois</div>
        </div>
      </div>

      <!-- ── GRAPHE REVENUS ── -->
      <div style="margin-top:16px;border:1px solid rgba(255,255,255,.07);padding:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;color:rgba(240,240,248,.3);letter-spacing:.14em;">REVENUS MENSUELS (K€)</div>
          <div style="display:flex;gap:4px;">
            <div class="admin-period active" onclick="setAdminPeriod(this,'6m')" data-period="6m" style="font-family:'DM Mono',monospace;font-size:8px;padding:3px 8px;border-radius:2px;cursor:pointer;background:rgba(0,232,122,.12);color:#00E87A;font-weight:600;border:1px solid rgba(0,232,122,.25);letter-spacing:.06em;">6M</div>
            <div class="admin-period" onclick="setAdminPeriod(this,'12m')" data-period="12m" style="font-family:'DM Mono',monospace;font-size:8px;padding:3px 8px;border-radius:2px;cursor:pointer;background:transparent;color:rgba(240,240,248,.25);font-weight:600;border:1px solid rgba(255,255,255,.07);letter-spacing:.06em;">12M</div>
          </div>
        </div>
        <canvas id="adminRevenueChart" height="80" style="width:100%;display:block;"></canvas>
        <div style="display:flex;justify-content:space-around;font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);margin-top:6px;letter-spacing:.04em;" id="adminChartLabels"></div>
      </div>

      <!-- ── RÉPARTITION GÉO ── -->
      <div style="margin-top:8px;border:1px solid rgba(255,255,255,.07);padding:14px;">
        <div style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;color:rgba(240,240,248,.3);letter-spacing:.14em;margin-bottom:10px;">RÉPARTITION GÉOGRAPHIQUE</div>
        <div id="geoList"></div>
      </div>

      <!-- ── TYPES ERP ── -->
      <div style="margin-top:8px;border:1px solid rgba(255,255,255,.07);padding:14px;">
        <div style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;color:rgba(240,240,248,.3);letter-spacing:.14em;margin-bottom:10px;">CONTRATS PAR TYPE ERP</div>
        <div id="contractTypes"></div>
      </div>

      <!-- ── ALERTES SYSTÈME ── -->
      <div style="margin-top:8px;border:1px solid rgba(255,59,59,.18);padding:14px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <div style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;color:rgba(240,240,248,.3);letter-spacing:.14em;">ALERTES SYSTÈME</div>
          <div style="background:rgba(255,59,59,.15);color:#FF3B3B;font-family:'DM Mono',monospace;font-size:8px;font-weight:700;border-radius:2px;padding:2px 6px;letter-spacing:.08em;">2 CRITIQUES</div>
        </div>
        <div id="sysAlerts"></div>
      </div>

      <!-- ── ACTIVITÉ RÉCENTE ── -->
      <div style="margin-top:8px;border:1px solid rgba(255,255,255,.07);padding:14px;">
        <div style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;color:rgba(240,240,248,.3);letter-spacing:.14em;margin-bottom:10px;">ACTIVITÉ RÉCENTE</div>
        <div id="adminActivity"></div>
      </div>

      <!-- ── ACTIONS ADMIN ── -->
      <div style="margin-top:16px;">
        <div style="font-family:'DM Mono',monospace;font-size:9px;font-weight:600;color:rgba(240,240,248,.3);letter-spacing:.14em;margin-bottom:8px;">ACTIONS</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
          <div onclick="adminAction('export')" style="border:1px solid rgba(255,255,255,.08);padding:12px;cursor:pointer;background:rgba(255,255,255,.02);">
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(240,240,248,.6);font-weight:600;margin-bottom:3px;">EXPORT PDF</div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);">Rapport mensuel</div>
          </div>
          <div onclick="adminAction('notify')" style="border:1px solid rgba(255,255,255,.08);padding:12px;cursor:pointer;background:rgba(255,255,255,.02);">
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(240,240,248,.6);font-weight:600;margin-bottom:3px;">NOTIFICATION</div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);">Push tous users</div>
          </div>
          <div onclick="adminAction('audit')" style="border:1px solid rgba(255,255,255,.08);padding:12px;cursor:pointer;background:rgba(255,255,255,.02);">
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(240,240,248,.6);font-weight:600;margin-bottom:3px;">AUDIT ERP</div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);">Contrôle manuel</div>
          </div>
          <div onclick="adminAction('partner')" style="border:1px solid rgba(255,255,255,.08);padding:12px;cursor:pointer;background:rgba(255,255,255,.02);">
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(240,240,248,.6);font-weight:600;margin-bottom:3px;">PARTENAIRE</div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);">Ajouter certif.</div>
          </div>
          <div onclick="adminAction('promo')" style="border:1px solid rgba(255,255,255,.08);padding:12px;cursor:pointer;background:rgba(255,255,255,.02);">
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:rgba(240,240,248,.6);font-weight:600;margin-bottom:3px;">CODE PROMO</div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(240,240,248,.2);">Accès gratuit</div>
          </div>
          <div onclick="adminAction('logs')" style="border:1px solid rgba(255,59,59,.2);padding:12px;cursor:pointer;background:rgba(255,59,59,.03);">
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:#FF3B3B;font-weight:600;margin-bottom:3px;">LOGS SÉCURITÉ</div>
            <div style="font-family:'DM Mono',monospace;font-size:8px;color:rgba(255,59,59,.4);">Accès & connexions</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ════════ CLIENT SCREEN ════════ -->
  <div class="screen" id="client">
    <div class="client-header">
      <div class="header-top">
        <div class="app-logo-small"><span class="spoty">Spoty</span><span class="safe-txt">SAFE</span></div>
        <div class="back-btn" onclick="goTo('splash')">← Retour</div>
      </div>
      <div class="location-pill" id="locationPill">
        <div class="location-dot"></div>
        <span id="locationText">Localisation en cours…</span>
      </div>
      <div class="section-title">Bars près de vous</div>
      <div class="section-sub" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span>7 établissements • Tours &amp; Paris — Pilote bêta</span>
        <div onclick="openSoireeMode()" style="display:flex;align-items:center;gap:5px;background:linear-gradient(135deg,#6030CC,#A064FF);color:white;border-radius:20px;padding:5px 12px 5px 10px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 2px 12px rgba(160,100,255,.3);flex-shrink:0;">✨ Soirée</div>
      </div>
      <!-- Filtres score/distance -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;padding:8px 0 4px;" id="clientMapFilters">
        <div class="filter-pill active" onclick="applyMapFilter('tous',this)" style="text-align:center;padding:6px 4px;">Tous</div>
        <div class="filter-pill" onclick="applyMapFilter('top',this)" style="text-align:center;padding:6px 4px;">✅ &gt;85</div>
        <div class="filter-pill" onclick="applyMapFilter('warning',this)" style="text-align:center;padding:6px 4px;">⚠️ Risque</div>
        <div class="filter-pill" onclick="applyMapFilter('tours',this)" style="text-align:center;padding:6px 4px;">📍 Tours</div>
        <div class="filter-pill" onclick="applyMapFilter('paris',this)" style="text-align:center;padding:6px 4px;">🗼 Paris</div>
        <div class="filter-pill" onclick="applyMapFilter('open',this)" style="text-align:center;padding:6px 4px;">🕐 Ouvert</div>
      </div>
    </div>

    <!-- MAP LEAFLET -->
    <div class="map-container" id="mapContainer">
      <div id="leafletMap" style="width:100%;height:100%;"></div>
    </div>

    <!-- BARS LIST -->
    <div class="bars-list">

      <!-- Bar 1 -->
      <div class="bar-card" data-idx="0" onclick="openModal(0)">
        <div class="bar-card-top">
          <div>
            <div class="bar-name">Le Vieux Murier</div>
            <div class="bar-type">Bar — 12 Place Plumereau</div>
          </div>
          <div class="score-badge">
            <div class="score-num">82</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill" style="width:82%"></div></div>
          <div class="score-pct">82%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 320m</div>
          <div class="bar-meta-item">🕐 Ouvert</div>
          <div class="bar-meta-item">👥 ~40 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill">✓ Issues secours</div>
          <div class="certif-pill warning">⚠ Détecteurs</div>
        </div>
      </div>

      <!-- Bar 2 -->
      <div class="bar-card" style="border-color:rgba(255,140,0,0.2);" data-idx="1" onclick="openModal(1)">
        <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--orange);border-radius:0 2px 2px 0;"></div>
        <div class="bar-card-top">
          <div>
            <div class="bar-name">Bar du Centre</div>
            <div class="bar-type">Bar brasserie — 5 Rue Colbert</div>
          </div>
          <div class="score-badge orange">
            <div class="score-num orange">78</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill orange" style="width:78%"></div></div>
          <div class="score-pct">78%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 150m</div>
          <div class="bar-meta-item">🕐 Ouvert</div>
          <div class="bar-meta-item">👥 ~80 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill warning">⚠ Issues secours</div>
          <div class="certif-pill warning">⚠ Éclairage</div>
        </div>
      </div>

      <!-- Bar 3 -->
      <div class="bar-card" data-idx="2" onclick="openModal(2)">
        <div class="bar-card-top">
          <div>
            <div class="bar-name">La Guinguette</div>
            <div class="bar-type">Bar concert — 8 Quai du Portillon</div>
          </div>
          <div class="score-badge">
            <div class="score-num">85</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill" style="width:85%"></div></div>
          <div class="score-pct">85%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 480m</div>
          <div class="bar-meta-item">🕐 Ouvert</div>
          <div class="bar-meta-item">👥 ~120 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill">✓ Issues secours</div>
          <div class="certif-pill">✓ Détecteurs</div>
        </div>
      </div>

    </div>

    <!-- SECTION PARIS -->
    <div style="padding:20px 24px 8px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
        <div class="section-title" style="margin:0;">Paris — Bêta</div>
        <div style="background:rgba(232,184,75,0.12);border:1px solid rgba(232,184,75,0.3);color:#E8B84B;font-size:9px;font-weight:700;padding:3px 8px;border-radius:100px;letter-spacing:.04em;">🟡 PILOTE PARIS</div>
      </div>
      <div class="section-sub">4 établissements • Marais &amp; Oberkampf · accès bêta</div>
    </div>
    <div class="bars-list">

      <!-- Paris 1 — Le Marais -->
      <div class="bar-card" data-idx="3" onclick="openModal(3)">
        <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:#E8B84B;border-radius:0 2px 2px 0;"></div>
        <div style="position:absolute;top:10px;right:10px;background:rgba(232,184,75,0.12);border:1px solid rgba(232,184,75,0.3);color:#E8B84B;font-size:8px;font-weight:700;padding:2px 7px;border-radius:100px;">🗼 Paris</div>
        <div class="bar-card-top" style="padding-right:60px;">
          <div>
            <div class="bar-name">Le Marais Social Club</div>
            <div class="bar-type">Bar cocktails — 18 Rue de Bretagne, 3e</div>
          </div>
          <div class="score-badge">
            <div class="score-num">91</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill" style="width:91%"></div></div>
          <div class="score-pct">91%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 Paris 3e</div>
          <div class="bar-meta-item">🕐 Ouvert</div>
          <div class="bar-meta-item">👥 ~60 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill">✓ Issues secours</div>
          <div class="certif-pill">✓ Détecteurs</div>
        </div>
      </div>

      <!-- Paris 2 — Oberkampf -->
      <div class="bar-card" style="border-color:rgba(255,140,0,0.2);" data-idx="4" onclick="openModal(4)">
        <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--orange);border-radius:0 2px 2px 0;"></div>
        <div style="position:absolute;top:10px;right:10px;background:rgba(232,184,75,0.12);border:1px solid rgba(232,184,75,0.3);color:#E8B84B;font-size:8px;font-weight:700;padding:2px 7px;border-radius:100px;">🗼 Paris</div>
        <div class="bar-card-top" style="padding-right:60px;">
          <div>
            <div class="bar-name">Café Oberkampf</div>
            <div class="bar-type">Bar concert — 3 Rue Oberkampf, 11e</div>
          </div>
          <div class="score-badge orange">
            <div class="score-num orange">74</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill orange" style="width:74%"></div></div>
          <div class="score-pct">74%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 Paris 11e</div>
          <div class="bar-meta-item">🕐 Ouvert</div>
          <div class="bar-meta-item">👥 ~150 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill warning">⚠ Issues secours</div>
          <div class="certif-pill warning">⚠ Registre</div>
        </div>
      </div>

      <!-- Paris 3 — République -->
      <div class="bar-card" data-idx="5" onclick="openModal(5)">
        <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:#E8B84B;border-radius:0 2px 2px 0;"></div>
        <div style="position:absolute;top:10px;right:10px;background:rgba(232,184,75,0.12);border:1px solid rgba(232,184,75,0.3);color:#E8B84B;font-size:8px;font-weight:700;padding:2px 7px;border-radius:100px;">🗼 Paris</div>
        <div class="bar-card-top" style="padding-right:60px;">
          <div>
            <div class="bar-name">Bar République</div>
            <div class="bar-type">Brasserie — 42 Bd du Temple, 3e</div>
          </div>
          <div class="score-badge">
            <div class="score-num">88</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill" style="width:88%"></div></div>
          <div class="score-pct">88%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 Paris 3e</div>
          <div class="bar-meta-item">🕐 Ouvert</div>
          <div class="bar-meta-item">👥 ~200 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill">✓ Issues secours</div>
          <div class="certif-pill">✓ Éclairage</div>
        </div>
      </div>

      <!-- Paris 4 — Bastille -->
      <div class="bar-card" style="border-color:rgba(255,140,0,0.2);" data-idx="6" onclick="openModal(6)">
        <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--orange);border-radius:0 2px 2px 0;"></div>
        <div style="position:absolute;top:10px;right:10px;background:rgba(232,184,75,0.12);border:1px solid rgba(232,184,75,0.3);color:#E8B84B;font-size:8px;font-weight:700;padding:2px 7px;border-radius:100px;">🗼 Paris</div>
        <div class="bar-card-top" style="padding-right:60px;">
          <div>
            <div class="bar-name">La Scène Bastille</div>
            <div class="bar-type">Bar PMU — 7 Rue de la Roquette, 11e</div>
          </div>
          <div class="score-badge orange">
            <div class="score-num orange">71</div>
            <div class="score-label">/100</div>
          </div>
        </div>
        <div class="score-bar-wrap">
          <div class="score-bar-track"><div class="score-bar-fill orange" style="width:71%"></div></div>
          <div class="score-pct">71%</div>
        </div>
        <div class="bar-meta">
          <div class="bar-meta-item">📍 Paris 11e</div>
          <div class="bar-meta-item">🕐 Fermé</div>
          <div class="bar-meta-item">👥 ~90 pers.</div>
        </div>
        <div class="certif-pills">
          <div class="certif-pill">✓ Extincteurs</div>
          <div class="certif-pill warning">⚠ Détecteurs</div>
          <div class="certif-pill warning">⚠ Éclairage</div>
        </div>
      </div>

    </div>

    <!-- MODAL DETAIL -->
    <div class="modal-overlay" id="detailModal" onclick="closeModal(event)">
      <div class="modal-sheet" id="modalContent">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div class="modal-handle" style="margin:0;"></div>
          <button onclick="closeModal()" style="background:rgba(255,255,255,0.08);border:none;color:var(--text);font-size:13px;padding:6px 14px;border-radius:10px;cursor:pointer;">✕ Fermer</button>
        </div>
        <div class="modal-bar-name" id="modalName">–</div>
        <div class="modal-bar-addr" id="modalAddr">–</div>
        <div class="modal-score-big">
          <div class="modal-score-num" id="modalScore">–</div>
          <div class="modal-score-info">
            <div class="modal-score-label">Score de sécurité ERP</div>
            <div class="modal-score-bar-track">
              <div class="modal-score-bar-fill" id="modalBar" style="width:0%"></div>
            </div>
          </div>
        </div>
        <div class="modal-section-title">Détails du certificat</div>
        <div class="modal-detail-grid" id="modalGrid"></div>
        <button class="modal-cta" onclick="navigate()">
          🗺️ Y aller
        </button>
        <button class="modal-cta" style="background:var(--card);color:var(--text);border:1px solid var(--border);margin-top:10px;" onclick="showToast('⭐ Ajouté à vos favoris !')">
          ⭐ Sauvegarder
        </button>
        <button class="modal-cta" style="background:transparent;color:var(--muted);border:none;margin-top:6px;font-size:14px;" onclick="closeModal()">
          ← Retour à la carte
        </button>
      </div>
    </div>

  </div>

  <!-- ── CLIENT SUB-SCREENS ── -->

  <!-- CARTE (déjà affichée via client-header + map + bars-list = vue par défaut) -->
  <div id="clientSubMap" class="client-sub active"></div>

  <!-- FAVORIS -->
  <div id="clientSubFavorites" class="client-sub" style="display:none;padding:0 24px 100px;">
    <div style="padding:16px 0 12px;display:flex;justify-content:space-between;align-items:center;">
      <div class="section-title" style="margin:0;">Mes favoris</div>
      <div style="font-size:11px;color:var(--muted);" id="favCount">0 bar</div>
    </div>
    <div id="favList"></div>
    <div id="favEmpty" style="text-align:center;padding:60px 0;color:var(--muted);">
      <div style="font-size:48px;margin-bottom:12px;">⭐</div>
      <div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:6px;">Aucun favori</div>
      <div style="font-size:12px;">Appuyez sur ⭐ dans la fiche d'un bar pour le sauvegarder</div>
    </div>
  </div>

  <!-- RECHERCHE -->
  <div id="clientSubSearch" class="client-sub" style="display:none;padding:0 24px 100px;">
    <div style="padding:16px 0 12px;">
      <div class="section-title" style="margin:0 0 12px;">Rechercher</div>
      <div class="search-bar">
        <span class="search-icon">🔍</span>
        <input type="text" id="clientSearchInput" placeholder="Nom, adresse, ville…" oninput="doClientSearch()" style="font-size:14px;">
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;" id="searchFilters">
        <div class="filter-pill active" onclick="setSearchFilter('tous',this)">Tous</div>
        <div class="filter-pill" onclick="setSearchFilter('top',this)">Score > 85</div>
        <div class="filter-pill" onclick="setSearchFilter('tours',this)">Tours</div>
        <div class="filter-pill" onclick="setSearchFilter('paris',this)">Paris</div>
      </div>
    </div>
    <div id="searchResults"></div>
    <div id="searchEmpty" style="text-align:center;padding:40px 0;color:var(--muted);display:none;">
      <div style="font-size:36px;margin-bottom:10px;">🔍</div>
      <div style="font-size:13px;">Aucun résultat pour cette recherche</div>
    </div>
  </div>

  <!-- PROFIL -->
  <div id="clientSubProfile" class="client-sub" style="display:none;padding:0 24px 100px;">
    <div style="padding:16px 0 20px;">
      <div class="section-title" style="margin:0 0 4px;">Mon profil</div>
      <div style="font-size:12px;color:var(--muted);">Utilisateur Spotysafe</div>
    </div>
    <!-- Avatar -->
    <div style="text-align:center;margin-bottom:24px;">
      <div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,rgba(0,200,120,0.2),rgba(0,200,120,0.05));border:2px solid rgba(0,200,120,0.3);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 10px;">👤</div>
      <div style="font-size:15px;font-weight:700;color:var(--text);">Utilisateur</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;">Membre depuis fév. 2026</div>
    </div>
    <!-- Stats perso -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;">
      <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-size:22px;font-weight:900;color:var(--green);" id="profileFavCount">0</div>
        <div style="font-size:9px;color:var(--muted);margin-top:3px;">Favoris</div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-size:22px;font-weight:900;color:var(--text);" id="profileScanCount">7</div>
        <div style="font-size:9px;color:var(--muted);margin-top:3px;">Fiches vues</div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-size:22px;font-weight:900;color:#E8B84B;">84</div>
        <div style="font-size:9px;color:var(--muted);margin-top:3px;">Score moy.</div>
      </div>
    </div>
    <!-- Alertes -->
    <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">ALERTES VOISINAGE</div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px;" id="alertList">
      <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:flex-start;">
        <div style="font-size:18px;margin-top:2px;">🔔</div>
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--text);">Le Vieux Murier a amélioré son score</div>
          <div style="font-size:10px;color:var(--green);margin-top:2px;">+5 points → 82/100 · il y a 2 jours</div>
        </div>
      </div>
      <div style="padding:14px 16px;display:flex;gap:12px;align-items:flex-start;">
        <div style="font-size:18px;margin-top:2px;">⚠️</div>
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--text);">Café Oberkampf : point en attente</div>
          <div style="font-size:10px;color:var(--orange);margin-top:2px;">Issues de secours · il y a 5 jours</div>
        </div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">PARAMÈTRES</div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;">
      <div onclick="showToast('🔔 Notifications activées')" style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;">
        <span style="font-size:13px;color:var(--text);">Notifications de score</span>
        <span style="font-size:11px;color:var(--green);font-weight:700;">Activées</span>
      </div>
      <div onclick="showToast('📍 Rayon mis à jour')" style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;">
        <span style="font-size:13px;color:var(--text);">Rayon d'alerte</span>
        <span style="font-size:11px;color:var(--muted);">500m ›</span>
      </div>
    </div>
  </div>


  <!-- ════════ PARENT SCREEN ════════ -->
  <div class="screen" id="parent">
    <div class="client-header" style="padding-bottom:8px;">
      <div class="header-top">
        <div class="app-logo-small"><span class="spoty">Spoty</span><span class="safe-txt">SAFE</span></div>
        <div class="back-btn" onclick="goTo('splash')">← Retour</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
        <div class="section-title" style="margin:0;">Je suis parent</div>
        <div style="background:rgba(160,100,255,0.15);border:1px solid rgba(160,100,255,0.35);color:#A064FF;font-size:9px;font-weight:700;padding:3px 8px;border-radius:100px;letter-spacing:.04em;">🔒 CONSENTEMENT REQUIS</div>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Suivi activé uniquement avec l'accord de votre enfant</div>
    </div>

    <!-- ONGLETS PARENT -->
    <div style="display:flex;border-bottom:1px solid var(--border);margin:0 24px 0;">
      <div id="ptab-live" onclick="switchParentTab('live')" style="flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:700;color:#A064FF;border-bottom:2px solid #A064FF;cursor:pointer;">📍 En direct</div>
      <div id="ptab-history" onclick="switchParentTab('history')" style="flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:600;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;">🕐 Historique</div>
      <div id="ptab-settings" onclick="switchParentTab('settings')" style="flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:600;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;">⚙️ Réglages</div>
    </div>

    <!-- SUB : EN DIRECT -->
    <div id="psub-live" style="padding:16px 24px 100px;">

      <!-- Profil enfant -->
      <div style="display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:16px;">
        <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,rgba(160,100,255,0.25),rgba(160,100,255,0.05));border:2px solid rgba(160,100,255,0.4);display:flex;align-items:center;justify-content:center;font-size:22px;">🧑</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Léa</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">Mis à jour il y a <span id="lastUpdate">2 min</span></div>
        </div>
        <div style="text-align:right;">
          <div id="childOnline" style="display:flex;align-items:center;gap:5px;justify-content:flex-end;">
            <div style="width:7px;height:7px;border-radius:50%;background:#00C878;animation:pulse-dot 1.5s infinite;"></div>
            <span style="font-size:11px;color:var(--green);font-weight:700;">En ligne</span>
          </div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px;">Batterie 78%</div>
        </div>
      </div>

      <!-- Statut sécurité -->
      <div id="safetyCard" style="border-radius:16px;padding:18px;margin-bottom:16px;background:linear-gradient(135deg,rgba(0,200,120,0.12),rgba(0,200,120,0.04));border:1px solid rgba(0,200,120,0.35);">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
          <div style="font-size:32px;" id="safetyIcon">✅</div>
          <div>
            <div style="font-size:13px;font-weight:800;color:var(--green);" id="safetyTitle">LIEU SÉCURISÉ</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;" id="safetySubtitle">Score Spotysafe ≥ 85/100 · Vérifié</div>
          </div>
          <div style="margin-left:auto;text-align:center;">
            <div style="font-size:26px;font-weight:900;" id="safetyScore" class="kpi-green">91</div>
            <div style="font-size:8px;color:var(--muted);">/100</div>
          </div>
        </div>
        <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px 12px;">
          <div style="font-size:12px;font-weight:700;color:var(--text);" id="currentVenue">📍 Le Marais Social Club</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;" id="currentAddr">18 Rue de Bretagne, Paris 3e</div>
          <div style="display:flex;gap:12px;margin-top:8px;">
            <span style="font-size:10px;color:var(--green);">✓ Extincteurs OK</span>
            <span style="font-size:10px;color:var(--green);">✓ Issues OK</span>
            <span style="font-size:10px;color:var(--green);">✓ Détecteurs OK</span>
          </div>
        </div>
      </div>

      <!-- Mini carte -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px;">
        <canvas id="parentMapCanvas" width="320" height="140" style="width:100%;height:140px;display:block;"></canvas>
        <div style="padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:11px;color:var(--muted);">Paris 3e · Rue de Bretagne</div>
          <div onclick="showToast('🗺️ Navigation lancée')" style="background:rgba(160,100,255,0.15);border:1px solid rgba(160,100,255,0.3);color:#A064FF;font-size:10px;font-weight:700;padding:5px 12px;border-radius:100px;cursor:pointer;">Y aller ›</div>
        </div>
      </div>

      <!-- Actions rapides -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
        <div onclick="showToast('📱 Message envoyé à Léa')" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;">
          <div style="font-size:22px;margin-bottom:6px;">💬</div>
          <div style="font-size:11px;font-weight:700;color:var(--text);">Envoyer message</div>
        </div>
        <div onclick="showToast('📞 Appel lancé vers Léa')" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;">
          <div style="font-size:22px;margin-bottom:6px;">📞</div>
          <div style="font-size:11px;font-weight:700;color:var(--text);">Appeler</div>
        </div>
      </div>

      <!-- Simulateur : changer le lieu -->
      <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">SIMULER UN DÉPLACEMENT</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div onclick="simulateLocation(0)" class="sim-loc-btn" style="background:var(--card);border:1px solid rgba(0,200,120,0.3);border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-size:12px;font-weight:700;color:var(--text);">Le Marais Social Club · Paris 3e</div><div style="font-size:10px;color:var(--green);margin-top:2px;">Score 91/100 ✅ Sécurisé</div></div>
          <div style="font-size:16px;">›</div>
        </div>
        <div onclick="simulateLocation(1)" class="sim-loc-btn" style="background:var(--card);border:1px solid rgba(255,140,0,0.3);border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-size:12px;font-weight:700;color:var(--text);">Café Oberkampf · Paris 11e</div><div style="font-size:10px;color:var(--orange);margin-top:2px;">Score 74/100 ⚠️ Non certifié</div></div>
          <div style="font-size:16px;">›</div>
        </div>
        <div onclick="simulateLocation(2)" class="sim-loc-btn" style="background:var(--card);border:1px solid rgba(0,200,120,0.3);border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-size:12px;font-weight:700;color:var(--text);">La Guinguette · Tours</div><div style="font-size:10px;color:var(--green);margin-top:2px;">Score 85/100 ✅ Sécurisé</div></div>
          <div style="font-size:16px;">›</div>
        </div>
      </div>
    </div>

    <!-- SUB : HISTORIQUE -->
    <div id="psub-history" style="display:none;padding:16px 24px 100px;">
      <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:12px;">LIEUX VISITÉS — 7 DERNIERS JOURS</div>
      <div style="display:flex;flex-direction:column;gap:2px;">

        <div style="font-size:10px;color:var(--muted);font-weight:700;padding:8px 0 4px;letter-spacing:.04em;">AUJOURD'HUI</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px 14px;display:flex;gap:12px;align-items:center;">
          <div style="width:36px;height:36px;border-radius:10px;background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);display:flex;align-items:center;justify-content:center;font-size:16px;">✅</div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:700;color:var(--text);">Le Marais Social Club</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Paris 3e · 22h14 → En cours · Score 91</div>
          </div>
          <div style="font-size:13px;font-weight:900;color:var(--green);">91</div>
        </div>

        <div style="font-size:10px;color:var(--muted);font-weight:700;padding:12px 0 4px;letter-spacing:.04em;">HIER</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px 14px;display:flex;gap:12px;align-items:center;margin-bottom:2px;">
          <div style="width:36px;height:36px;border-radius:10px;background:rgba(255,140,0,0.1);border:1px solid rgba(255,140,0,0.3);display:flex;align-items:center;justify-content:center;font-size:16px;">⚠️</div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:700;color:var(--text);">Café Oberkampf</div>
            <div style="font-size:10px;color:var(--orange);margin-top:2px;">Paris 11e · 21h02→23h45 · Score 74 ⚠️</div>
          </div>
          <div style="font-size:13px;font-weight:900;color:var(--orange);">74</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px 14px;display:flex;gap:12px;align-items:center;">
          <div style="width:36px;height:36px;border-radius:10px;background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);display:flex;align-items:center;justify-content:center;font-size:16px;">✅</div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:700;color:var(--text);">Bar République</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Paris 3e · 18h30→20h15 · Score 88</div>
          </div>
          <div style="font-size:13px;font-weight:900;color:var(--green);">88</div>
        </div>

        <div style="font-size:10px;color:var(--muted);font-weight:700;padding:12px 0 4px;letter-spacing:.04em;">VENDREDI 14 FÉV.</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px 14px;display:flex;gap:12px;align-items:center;">
          <div style="width:36px;height:36px;border-radius:10px;background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);display:flex;align-items:center;justify-content:center;font-size:16px;">✅</div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:700;color:var(--text);">Le Vieux Murier</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Tours · 20h00→01h30 · Score 82</div>
          </div>
          <div style="font-size:13px;font-weight:900;color:var(--green);">82</div>
        </div>

        <!-- Résumé semaine -->
        <div style="margin-top:16px;background:rgba(160,100,255,0.08);border:1px solid rgba(160,100,255,0.2);border-radius:12px;padding:14px;">
          <div style="font-size:11px;color:#A064FF;font-weight:700;margin-bottom:8px;">📊 RÉSUMÉ DE LA SEMAINE</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;">
            <div><div style="font-size:20px;font-weight:900;color:var(--green);">3</div><div style="font-size:9px;color:var(--muted);">Lieux sécurisés</div></div>
            <div><div style="font-size:20px;font-weight:900;color:var(--orange);">1</div><div style="font-size:9px;color:var(--muted);">À surveiller</div></div>
            <div><div style="font-size:20px;font-weight:900;color:var(--text);">84</div><div style="font-size:9px;color:var(--muted);">Score moyen</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SUB : RÉGLAGES -->
    <div id="psub-settings" style="display:none;padding:16px 24px 100px;">
      <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:12px;">PROFIL SUIVI</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px;">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-size:13px;font-weight:700;color:var(--text);">Léa</div><div style="font-size:10px;color:var(--muted);">Consentement donné le 12/02/2026</div></div>
          <div style="background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);color:var(--green);font-size:9px;font-weight:700;padding:4px 8px;border-radius:100px;">✓ Actif</div>
        </div>
        <div onclick="showToast('📱 Lien envoyé à Léa')" style="padding:14px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
          <span style="font-size:13px;color:var(--text);">Ajouter un autre enfant</span>
          <span style="font-size:16px;color:var(--muted);">+</span>
        </div>
      </div>

      <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:12px;">ALERTES</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px;">
        <div onclick="showToast('⚙️ Seuil mis à jour')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;">
          <div>
            <div style="font-size:13px;color:var(--text);">Alerte si lieu non certifié</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Score &lt; 85/100</div>
          </div>
          <div style="background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);color:var(--green);font-size:9px;font-weight:700;padding:4px 8px;border-radius:100px;">Activée</div>
        </div>
        <div onclick="showToast('⚙️ Paramètre mis à jour')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;">
          <div>
            <div style="font-size:13px;color:var(--text);">Notification d'arrivée</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Quand l'enfant entre dans un ERP</div>
          </div>
          <div style="background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);color:var(--green);font-size:9px;font-weight:700;padding:4px 8px;border-radius:100px;">Activée</div>
        </div>
        <div onclick="showToast('⚙️ Heure de retour mise à jour')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;">
          <div>
            <div style="font-size:13px;color:var(--text);">Heure de retour attendue</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">Alerte si dépassée</div>
          </div>
          <span style="font-size:12px;color:var(--muted);">01h00 ›</span>
        </div>
      </div>

      <!-- Consentement info -->
      <div style="background:rgba(160,100,255,0.08);border:1px solid rgba(160,100,255,0.2);border-radius:12px;padding:14px 16px;">
        <div style="font-size:11px;color:#A064FF;font-weight:700;margin-bottom:6px;">🔒 RESPECT DE LA VIE PRIVÉE</div>
        <div style="font-size:11px;color:var(--muted);line-height:1.6;">Le suivi est <strong style="color:var(--text);">toujours soumis au consentement explicite</strong> de l'enfant. Il peut le désactiver à tout moment depuis son profil. La localisation n'est partagée qu'avec le parent autorisé.</div>
      </div>
    </div>

    <!-- Tab bar parent -->
    <div class="tab-bar visible" id="tabParent">
      <div class="tab-item" onclick="switchParentTab('live')">
        <div class="tab-icon active" id="ptabLiveIcon">📍</div>
        <div class="tab-txt active" id="ptabLiveTxt">En direct</div>
      </div>
      <div class="tab-item" onclick="switchParentTab('history')">
        <div class="tab-icon" id="ptabHistoryIcon">🕐</div>
        <div class="tab-txt" id="ptabHistoryTxt">Historique</div>
      </div>
      <div class="tab-item" onclick="switchParentTab('settings')">
        <div class="tab-icon" id="ptabSettingsIcon">⚙️</div>
        <div class="tab-txt" id="ptabSettingsTxt">Réglages</div>
      </div>
    </div>
  </div>

  <!-- ════════ BAR OWNER SCREEN ════════ -->
  <div class="screen" id="barowner">

    <!-- SUB: ACCUEIL -->
    <div class="owner-sub active" id="ownerHome">
    <div class="bar-header">
      <div class="bar-header-top">
        <div class="app-logo-small"><span class="spoty">Spoty</span><span class="safe-txt">SAFE</span></div>
        <div class="back-btn" onclick="goTo('splash')">← Retour</div>
      </div>
      <div class="establishment-name">Bar du Centre</div>
      <div class="establishment-sub">5 Rue Colbert • Tours • ERP Type N • 3e catégorie</div>
    </div>

    <!-- BIG SCORE -->
    <div class="big-score-card">
      <div class="score-row">
        <div>
          <div class="score-label-main">Score global de sécurité</div>
          <div style="display:flex;align-items:baseline;gap:4px;">
            <div class="big-score-num" id="animatedScore">0</div>
            <div class="big-score-denom">/100</div>
          </div>
          <div class="score-trend">↑ +3 pts ce trimestre</div>
        </div>
        <div class="score-ring">
          <svg width="90" height="90" viewBox="0 0 90 90">
            <circle class="ring-bg" cx="45" cy="45" r="36"/>
            <circle class="ring-fill" cx="45" cy="45" r="36"/>
          </svg>
          <div class="ring-label">78</div>
        </div>
      </div>
      <div class="score-bar-track" style="height:8px;">
        <div class="score-bar-fill orange" style="width:78%;height:100%;border-radius:4px;"></div>
      </div>
    </div>

    <!-- CRITERIA -->
    <div class="criteria-section">
      <div class="criteria-title">Détail par critère</div>
      <div class="criteria-list">

        <div class="criteria-item">
          <div class="criteria-icon ci-green">🔥</div>
          <div class="criteria-info">
            <div class="criteria-name">Extincteurs & systèmes anti-incendie</div>
            <div class="criteria-bar-wrap">
              <div class="criteria-bar-track"><div class="criteria-bar-fill" style="width:95%"></div></div>
              <div class="criteria-pct">95%</div>
            </div>
          </div>
          <div class="criteria-status cs-ok">✓ OK</div>
        </div>

        <div class="criteria-item">
          <div class="criteria-icon ci-orange">🚪</div>
          <div class="criteria-info">
            <div class="criteria-name">Issues de secours</div>
            <div class="criteria-bar-wrap">
              <div class="criteria-bar-track"><div class="criteria-bar-fill orange" style="width:70%"></div></div>
              <div class="criteria-pct">70%</div>
            </div>
          </div>
          <div class="criteria-status cs-warn">⚠ Action</div>
        </div>

        <div class="criteria-item">
          <div class="criteria-icon ci-orange">💡</div>
          <div class="criteria-info">
            <div class="criteria-name">Éclairage de sécurité</div>
            <div class="criteria-bar-wrap">
              <div class="criteria-bar-track"><div class="criteria-bar-fill orange" style="width:65%"></div></div>
              <div class="criteria-pct">65%</div>
            </div>
          </div>
          <div class="criteria-status cs-warn">⚠ Action</div>
        </div>

        <div class="criteria-item">
          <div class="criteria-icon ci-green">📋</div>
          <div class="criteria-info">
            <div class="criteria-name">Affichages réglementaires</div>
            <div class="criteria-bar-wrap">
              <div class="criteria-bar-track"><div class="criteria-bar-fill" style="width:90%"></div></div>
              <div class="criteria-pct">90%</div>
            </div>
          </div>
          <div class="criteria-status cs-ok">✓ OK</div>
        </div>

        <div class="criteria-item">
          <div class="criteria-icon ci-green">🏗️</div>
          <div class="criteria-info">
            <div class="criteria-name">Structure & matériaux</div>
            <div class="criteria-bar-wrap">
              <div class="criteria-bar-track"><div class="criteria-bar-fill" style="width:85%"></div></div>
              <div class="criteria-pct">85%</div>
            </div>
          </div>
          <div class="criteria-status cs-ok">✓ OK</div>
        </div>

        <div class="criteria-item">
          <div class="criteria-icon ci-red">🔔</div>
          <div class="criteria-info">
            <div class="criteria-name">Détecteurs de fumée</div>
            <div class="criteria-bar-wrap">
              <div class="criteria-bar-track"><div class="criteria-bar-fill red" style="width:40%"></div></div>
              <div class="criteria-pct">40%</div>
            </div>
          </div>
          <div class="criteria-status cs-bad">✗ Urgent</div>
        </div>

      </div>
    </div>

    <!-- ACTIONS -->
    <div class="actions-section">
      <div class="actions-title">Actions recommandées</div>

      <div class="action-btn" onclick="showToast('📅 Prise de rendez-vous ouverte')">
        <div class="action-btn-icon">📅</div>
        <div class="action-btn-text">
          <div class="action-btn-title">Planifier une inspection</div>
          <div class="action-btn-sub">Prochaine visite recommandée : mars 2026</div>
        </div>
        <div class="action-btn-arrow">›</div>
      </div>

      <div class="action-btn" onclick="showToast('📤 Rapport envoyé à la commission')">
        <div class="action-btn-icon orange">📤</div>
        <div class="action-btn-text">
          <div class="action-btn-title">Envoyer mon dossier</div>
          <div class="action-btn-sub">Commission de sécurité d'Indre-et-Loire</div>
        </div>
        <div class="action-btn-arrow">›</div>
      </div>

      <div class="action-btn" onclick="showToast('📜 Certificat téléchargé')">
        <div class="action-btn-icon">📜</div>
        <div class="action-btn-text">
          <div class="action-btn-title">Télécharger mon certificat</div>
          <div class="action-btn-sub">Valide jusqu'au 12 septembre 2026</div>
        </div>
        <div class="action-btn-arrow">›</div>
      </div>

      <div class="action-btn" onclick="showToast('👁️ Aperçu de votre fiche publique')">
        <div class="action-btn-icon">👁️</div>
        <div class="action-btn-text">
          <div class="action-btn-title">Voir ma fiche publique</div>
          <div class="action-btn-sub">Ce que voient vos clients sur Spotysafe</div>
        </div>
        <div class="action-btn-arrow">›</div>
      </div>
    </div>

  </div>

  <!-- ═══════════════════════════════════════════
       SOUS-ÉCRAN ALERTES SCORE
  ═══════════════════════════════════════════ -->
  <div id="clientSubAlerts" class="client-sub" style="display:none;padding:0 20px 100px;">

    <div style="padding:20px 0 8px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--text);">Mes alertes score</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Soyez notifié dès qu'un score change</div>
    </div>

    <!-- Bascule globale alertes -->
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px 18px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:14px;font-weight:700;color:var(--text);">Alertes activées</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Notifications push en temps réel</div>
      </div>
      <div id="alertMasterToggle" onclick="toggleMasterAlert()" style="width:44px;height:24px;background:var(--green);border-radius:12px;position:relative;cursor:pointer;transition:background .2s;">
        <div style="position:absolute;top:3px;right:3px;width:18px;height:18px;background:white;border-radius:50%;transition:right .2s;" id="alertToggleKnob"></div>
      </div>
    </div>

    <!-- Seuil d'alerte -->
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px 18px;margin-bottom:20px;">
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px;">Seuil d'alerte</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <div class="alert-threshold active" data-val="10" onclick="setThreshold(this)">±10 pts</div>
        <div class="alert-threshold" data-val="5"  onclick="setThreshold(this)">±5 pts</div>
        <div class="alert-threshold" data-val="1"  onclick="setThreshold(this)">Moindre changement</div>
      </div>
    </div>

    <!-- Titre liste alertes récentes -->
    <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;">Alertes récentes</div>

    <!-- Alerte 1 — baisse -->
    <div class="alert-card alert-down">
      <div class="alert-icon">📉</div>
      <div class="alert-body">
        <div class="alert-name">Le Vieux Murier <span class="alert-tag tag-down">−9 pts</span></div>
        <div class="alert-detail">Score passé de <b>91</b> → <b>82</b> après contrôle</div>
        <div class="alert-time">Il y a 2h · Tours</div>
      </div>
      <div class="alert-action" onclick="openModal(0)">Voir →</div>
    </div>

    <!-- Alerte 2 — hausse -->
    <div class="alert-card alert-up">
      <div class="alert-icon">📈</div>
      <div class="alert-body">
        <div class="alert-name">Café Promenade <span class="alert-tag tag-up">+12 pts</span></div>
        <div class="alert-detail">Score passé de <b>71</b> → <b>83</b> après audit</div>
        <div class="alert-time">Hier · Tours</div>
      </div>
      <div class="alert-action" onclick="openModal(2)">Voir →</div>
    </div>

    <!-- Alerte 3 — baisse critique -->
    <div class="alert-card alert-critical">
      <div class="alert-icon">🚨</div>
      <div class="alert-body">
        <div class="alert-name">Chez Marcel <span class="alert-tag tag-critical">Score critique</span></div>
        <div class="alert-detail">Score tombé à <b>48</b> — certification suspendue</div>
        <div class="alert-time">Il y a 3j · Paris</div>
      </div>
      <div class="alert-action" onclick="openModal(5)">Voir →</div>
    </div>

    <!-- Mes établissements surveillés -->
    <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin:20px 0 10px;">Établissements surveillés</div>

    <div id="watchlistContainer">
      <!-- généré dynamiquement par renderWatchlist() -->
    </div>

    <div onclick="switchClientTab('map')" style="margin-top:12px;padding:14px;background:rgba(0,200,120,0.07);border:1px dashed rgba(0,200,120,0.3);border-radius:14px;text-align:center;font-size:13px;color:var(--green);cursor:pointer;">
      + Ajouter un établissement à surveiller
    </div>

  </div>

  <!-- ═══════════════════════════════════════════
       SOUS-ÉCRAN SIGNALEMENT CITOYEN
  ═══════════════════════════════════════════ -->
  <div id="clientSubReport" class="client-sub" style="display:none;padding:0 20px 100px;">

    <div style="padding:20px 0 8px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--text);">Signalement citoyen</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Signalez un problème de sécurité observé</div>
    </div>

    <!-- Étapes du formulaire -->
    <div id="reportStep1">

      <!-- Sélection établissement -->
      <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;">1 · Quel établissement ?</div>

      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:4px 6px;margin-bottom:16px;">
        <input id="reportSearch" type="text" placeholder="Rechercher un établissement…"
          oninput="filterReportBars(this.value)"
          style="width:100%;background:none;border:none;outline:none;padding:12px 10px;font-size:14px;color:var(--text);font-family:'DM Sans',sans-serif;" />
      </div>

      <div id="reportBarList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;"></div>

      <!-- Type de problème -->
      <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;">2 · Type de problème</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;" id="reportTypeGrid">
        <div class="report-type-btn active" data-type="extincteur" onclick="selectReportType(this)">
          <div style="font-size:22px;margin-bottom:4px;">🧯</div>
          <div>Extincteur</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Manquant / expiré</div>
        </div>
        <div class="report-type-btn" data-type="sortie" onclick="selectReportType(this)">
          <div style="font-size:22px;margin-bottom:4px;">🚪</div>
          <div>Sortie secours</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Bloquée / absente</div>
        </div>
        <div class="report-type-btn" data-type="eclairage" onclick="selectReportType(this)">
          <div style="font-size:22px;margin-bottom:4px;">💡</div>
          <div>Éclairage sécurité</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Défaillant / absent</div>
        </div>
        <div class="report-type-btn" data-type="affichage" onclick="selectReportType(this)">
          <div style="font-size:22px;margin-bottom:4px;">📋</div>
          <div>Affichage</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Plans évacuation</div>
        </div>
        <div class="report-type-btn" data-type="surcharge" onclick="selectReportType(this)">
          <div style="font-size:22px;margin-bottom:4px;">👥</div>
          <div>Surcharge</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Capacité dépassée</div>
        </div>
        <div class="report-type-btn" data-type="autre" onclick="selectReportType(this)">
          <div style="font-size:22px;margin-bottom:4px;">⚠️</div>
          <div>Autre</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Préciser ci-dessous</div>
        </div>
      </div>

      <!-- Photo + description -->
      <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;">3 · Photo & description</div>

      <!-- Zone photo -->
      <div id="photoZone" onclick="simulatePhotoCapture()"
        style="background:var(--card);border:2px dashed var(--border);border-radius:16px;padding:28px 20px;text-align:center;cursor:pointer;margin-bottom:12px;transition:border-color .2s;"
        onmouseover="this.style.borderColor='var(--green)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:8px;">📷</div>
        <div style="font-size:13px;color:var(--text);font-weight:600;">Prendre une photo</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">Ou appuyer pour sélectionner depuis la galerie</div>
      </div>

      <!-- Prévisualisation photo (cachée par défaut) -->
      <div id="photoPreview" style="display:none;position:relative;margin-bottom:12px;border-radius:16px;overflow:hidden;">
        <div style="background:linear-gradient(135deg,#1a2a1a,#0d1f0d);height:140px;display:flex;align-items:center;justify-content:center;border-radius:16px;border:1px solid rgba(0,200,120,0.2);">
          <div style="text-align:center;">
            <div style="font-size:36px;">🧯</div>
            <div style="font-size:11px;color:var(--green);margin-top:6px;">Photo ajoutée ✓</div>
          </div>
        </div>
        <div onclick="removePhoto()" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:white;border-radius:20px;padding:4px 10px;font-size:11px;cursor:pointer;">✕ Supprimer</div>
      </div>

      <textarea id="reportDesc" placeholder="Décrivez le problème observé… (optionnel)"
        style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;font-size:13px;color:var(--text);font-family:'DM Sans',sans-serif;resize:none;height:80px;outline:none;margin-bottom:16px;box-sizing:border-box;"></textarea>

      <!-- Anonymat -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
        <div id="anonToggle" onclick="toggleAnon()" style="width:36px;height:20px;background:var(--green);border-radius:10px;position:relative;cursor:pointer;flex-shrink:0;">
          <div id="anonKnob" style="position:absolute;top:2px;right:2px;width:16px;height:16px;background:white;border-radius:50%;transition:right .2s;"></div>
        </div>
        <div>
          <div style="font-size:13px;color:var(--text);font-weight:600;">Signalement anonyme</div>
          <div style="font-size:11px;color:var(--muted);">Votre identité ne sera pas communiquée au gérant</div>
        </div>
      </div>

      <!-- Bouton envoyer -->
      <button onclick="submitReport()" id="reportSubmitBtn"
        style="width:100%;padding:16px;background:var(--green);color:#07080F;border:none;border-radius:16px;font-size:15px;font-weight:800;font-family:'Syne',sans-serif;cursor:pointer;letter-spacing:.03em;transition:opacity .2s;">
        Envoyer le signalement
      </button>

      <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:12px;line-height:1.5;">
        Votre signalement sera traité par notre équipe.<br>Un certificateur Apave/Bureau Veritas sera alerté si nécessaire.
      </div>
    </div>

    <!-- Confirmation envoi -->
    <div id="reportStep2" style="display:none;text-align:center;padding:40px 20px;">
      <div style="font-size:64px;margin-bottom:16px;animation:pulse 1.5s ease-in-out 3;">✅</div>
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--text);margin-bottom:8px;">Signalement envoyé !</div>
      <div style="font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:28px;">
        Merci pour votre vigilance citoyenne.<br>
        Notre équipe va examiner votre signalement<br>sous <b style="color:var(--green);">48h maximum</b>.
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:24px;text-align:left;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">RÉCAPITULATIF</div>
        <div id="reportSummary" style="font-size:13px;color:var(--text);line-height:1.8;"></div>
      </div>
      <div style="display:flex;gap:10px;">
        <button onclick="resetReport()" style="flex:1;padding:14px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:14px;font-size:13px;font-weight:700;cursor:pointer;">
          Nouveau signalement
        </button>
        <button onclick="switchClientTab('map')" style="flex:1;padding:14px;background:var(--green);color:#07080F;border:none;border-radius:14px;font-size:13px;font-weight:800;cursor:pointer;">
          Retour carte
        </button>
      </div>
    </div>

    <!-- Historique signalements -->
    <div id="reportHistory" style="margin-top:24px;">
      <div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;">Mes signalements</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:flex-start;">
          <div style="font-size:20px;padding-top:2px;">🧯</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:var(--text);">Le Vieux Murier</div>
            <div style="font-size:11px;color:var(--muted);">Extincteur absent dans les toilettes</div>
            <div style="font-size:10px;color:var(--muted);margin-top:3px;">Il y a 5 jours</div>
          </div>
          <div style="background:rgba(232,184,75,0.15);color:#E8B84B;border-radius:8px;padding:4px 8px;font-size:10px;font-weight:700;white-space:nowrap;">En cours</div>
        </div>
        <div style="padding:14px 16px;display:flex;gap:12px;align-items:flex-start;">
          <div style="font-size:20px;padding-top:2px;">🚪</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:var(--text);">Bar Oberkampf</div>
            <div style="font-size:11px;color:var(--muted);">Sortie de secours bloquée par cartons</div>
            <div style="font-size:10px;color:var(--muted);margin-top:3px;">Il y a 12 jours</div>
          </div>
          <div style="background:rgba(0,200,120,0.12);color:var(--green);border-radius:8px;padding:4px 8px;font-size:10px;font-weight:700;white-space:nowrap;">✓ Résolu</div>
        </div>
      </div>
    </div>

  </div>

  <!-- TAB BAR CLIENT -->
  <div class="tab-bar" id="tabClient">
    <div class="tab-item" onclick="switchClientTab('map')">
      <div class="tab-icon active" id="ctabMap"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><path d="M11 2C7.7 2 5 4.7 5 8c0 4.5 6 12 6 12s6-7.5 6-12c0-3.3-2.7-6-6-6z" stroke="#00C878" stroke-width="1.7" fill="rgba(0,200,120,.18)"/><circle cx="11" cy="8" r="2" fill="#00C878"/></svg></div>
      <div class="tab-txt active" id="ctabMapTxt" style="color:#00C878;">Carte</div>
    </div>
    <div class="tab-item" onclick="switchClientTab('favorites')">
      <div class="tab-icon" id="ctabFavorites" style="opacity:.4;"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><path d="M11 18s-8-5.3-8-10a5 5 0 0110 0 5 5 0 0110 0c0 4.7-8 10-8 10z" stroke="#FF6B8A" stroke-width="1.7" stroke-linejoin="round" fill="rgba(255,107,138,.12)"/></svg></div>
      <div class="tab-txt" id="ctabFavoritesTxt">Favoris</div>
    </div>
    <div class="tab-item" onclick="switchClientTab('search')">
      <div class="tab-icon" id="ctabSearch" style="opacity:.4;"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><circle cx="10" cy="10" r="5.5" stroke="#3B82F6" stroke-width="1.7" fill="rgba(59,130,246,.12)"/><path d="M14.5 14.5l4 4" stroke="#3B82F6" stroke-width="1.9" stroke-linecap="round"/></svg></div>
      <div class="tab-txt" id="ctabSearchTxt">Chercher</div>
    </div>
    <div class="tab-item" onclick="switchClientTab('alerts')" style="position:relative;">
      <div class="tab-icon" id="ctabAlerts" style="opacity:.4;"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><path d="M11 3a6 6 0 016 6v4l2 2H3l2-2V9a6 6 0 016-6z" stroke="#E8B84B" stroke-width="1.7" stroke-linejoin="round" fill="rgba(232,184,75,.12)"/><path d="M9 17a2 2 0 004 0" stroke="#E8B84B" stroke-width="1.6"/><circle cx="11" cy="3" r="1.5" fill="#E8B84B"/></svg></div>
      <div class="tab-txt" id="ctabAlertsTxt">Alertes</div>
      <div id="alertBadge" style="position:absolute;top:6px;right:14px;background:#E8B84B;color:#07080F;border-radius:10px;font-size:9px;font-weight:900;padding:1px 5px;display:none;">3</div>
    </div>
    <div class="tab-item" onclick="switchClientTab('report')">
      <div class="tab-icon" id="ctabReport" style="opacity:.4;"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><rect x="3" y="3" width="16" height="12" rx="2.5" stroke="#FF6B6B" stroke-width="1.7" fill="rgba(255,107,107,.1)"/><circle cx="11" cy="9" r="2.8" stroke="#FF6B6B" stroke-width="1.5"/><path d="M7 19h8M11 15v4" stroke="#FF6B6B" stroke-width="1.6" stroke-linecap="round"/></svg></div>
      <div class="tab-txt" id="ctabReportTxt">Signaler</div>
    </div>
    <div class="tab-item" onclick="switchClientTab('profile')">
      <div class="tab-icon" id="ctabProfile" style="opacity:.4;"><svg width="22" height="22" viewBox="0 0 22 22" fill="none"><circle cx="11" cy="8" r="3.8" stroke="#A064FF" stroke-width="1.7" fill="rgba(160,100,255,.12)"/><path d="M3 21c0-4.4 3.6-8 8-8s8 3.6 8 8" stroke="#A064FF" stroke-width="1.7" stroke-linecap="round"/></svg></div>
      <div class="tab-txt" id="ctabProfileTxt">Profil</div>
    </div>
  </div>

  <!-- TAB BAR BAR OWNER -->
  <div class="tab-bar" id="tabBar">
    <div class="tab-item" onclick="switchOwnerTab('home')">
      <div class="tab-icon active" id="ownerTabHome">🏠</div>
      <div class="tab-txt active" id="ownerTabHomeTxt">Accueil</div>
    </div>
    <div class="tab-item" onclick="switchOwnerTab('analytics')">
      <div class="tab-icon" id="ownerTabAnalytics">📊</div>
      <div class="tab-txt" id="ownerTabAnalyticsTxt">Stats</div>
    </div>
    <div class="tab-item" onclick="switchOwnerTab('partners')">
      <div class="tab-icon" id="ownerTabPartners">🤝</div>
      <div class="tab-txt" id="ownerTabPartnersTxt">Partenaires</div>
    </div>
    <div class="tab-item" onclick="switchOwnerTab('docs')">
      <div class="tab-icon" id="ownerTabDocs">📋</div>
      <div class="tab-txt" id="ownerTabDocsTxt">Documents</div>
    </div>
    <div class="tab-item" onclick="switchOwnerTab('settings')">
      <div class="tab-icon" id="ownerTabSettings">⚙️</div>
      <div class="tab-txt" id="ownerTabSettingsTxt">Réglages</div>
    </div>
    </div><!-- /ownerHome -->

    <!-- SUB: PARTENAIRES -->
    <div class="owner-sub" id="ownerPartners">
      <div class="partners-screen active">
        <div style="padding-top:8px;" class="header-top">
          <div>
            <div class="section-title">Partenaires agréés</div>
            <div class="partners-count" id="partnersCount">7 organismes • Tours, Paris & France</div>
          </div>
          <div class="back-btn" onclick="switchOwnerTab('home')">← Retour</div>
        </div>

        <!-- SEARCH -->
        <div class="search-bar" style="margin-top:16px;">
          <span class="search-icon">🔍</span>
          <input type="text" id="partnerSearch" placeholder="Nom, ville, spécialité…" oninput="filterPartners()">
        </div>

        <!-- FILTERS -->
        <div class="filter-pills">
          <div class="filter-pill active" onclick="setFilter('tous', this)">Tous</div>
          <div class="filter-pill" onclick="setFilter('bureau', this)">Bureau de contrôle</div>
          <div class="filter-pill" onclick="setFilter('securite', this)">Sécurité incendie</div>
          <div class="filter-pill" onclick="setFilter('erp', this)">Spé. ERP</div>
          <div class="filter-pill" onclick="setFilter('rapide', this)">Intervention rapide</div>
        </div>

        <!-- LISTE -->
        <div id="partnersList"></div>
      </div>
    </div><!-- /ownerPartners -->

    <!-- SUB: DOCUMENTS -->
    <div class="owner-sub" id="ownerDocs">
      <div style="padding:16px 24px 0;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div class="section-title" style="margin:0;">Certification & Documents</div>
          <div class="back-btn" onclick="switchOwnerTab('home')">← Retour</div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:20px;">Bar du Centre • Tours</div>
      </div>

      <!-- Badge actuel -->
      <div style="margin:0 24px 16px;">
        <div id="badgeSilver" style="background:linear-gradient(135deg,rgba(192,192,192,0.12),rgba(192,192,192,0.04));border:1px solid rgba(192,192,192,0.35);border-radius:16px;padding:18px;">
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px;">
            <div style="font-size:48px;">🥈</div>
            <div style="flex:1;">
              <div style="font-size:11px;color:#A8A8A8;font-weight:700;letter-spacing:.06em;margin-bottom:4px;">✓ BADGE ACTIF</div>
              <div style="font-size:16px;font-weight:800;color:var(--text);">SpotySAFE Silver</div>
              <div style="font-size:11px;color:var(--muted);margin-top:3px;">Auto-déclaration • Visible sur votre fiche</div>
            </div>
          </div>
          <div style="background:rgba(0,0,0,0.15);border-radius:10px;padding:12px;margin-bottom:14px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">Le badge <strong style="color:var(--text);">Silver</strong> atteste que vous avez déclaré posséder les équipements de sécurité obligatoires. Il est visible sur votre fiche client et améliore votre visibilité dans les recherches.</div>
            <div style="font-size:10px;color:var(--muted);margin-top:8px;font-style:italic;">💡 Passez au badge <strong style="color:#E8B84B;">Gold</strong> en téléchargeant vos certificats d'organismes agréés pour un score vérifié officiel.</div>
          </div>
          <button onclick="goToBadgeUpgrade()" style="width:100%;background:linear-gradient(135deg,#E8B84B,#D4A030);color:#000;border:none;border-radius:10px;padding:12px;font-size:13px;font-weight:700;cursor:pointer;">🏆 Passer au badge Gold</button>
        </div>

        <div id="badgeGold" style="display:none;background:linear-gradient(135deg,rgba(232,184,75,0.15),rgba(232,184,75,0.05));border:1px solid rgba(232,184,75,0.4);border-radius:16px;padding:18px;">
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px;">
            <div style="font-size:48px;">🥇</div>
            <div style="flex:1;">
              <div style="font-size:11px;color:#E8B84B;font-weight:700;letter-spacing:.06em;margin-bottom:4px;">✅ BADGE VÉRIFIÉ</div>
              <div style="font-size:16px;font-weight:800;color:var(--text);">SpotySAFE Gold</div>
              <div style="font-size:11px;color:var(--muted);margin-top:3px;">Certificats vérifiés • Score officiel 82/100</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
            <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px;">
              <div style="font-size:9px;color:var(--muted);margin-bottom:2px;">Certificat Apave</div>
              <div style="font-size:11px;font-weight:700;color:var(--text);">✓ Actif</div>
            </div>
            <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px;">
              <div style="font-size:9px;color:var(--muted);margin-bottom:2px;">Valide jusqu'au</div>
              <div style="font-size:11px;font-weight:700;color:var(--text);">14/06/2026</div>
            </div>
          </div>
          <button onclick="showToast('📥 Certificat téléchargé')" style="width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:11px;font-size:12px;font-weight:600;cursor:pointer;">📥 Télécharger mon certificat</button>
        </div>
      </div>

      <!-- Upgrade flow (hidden initialement) -->
      <div id="uploadFlow" style="display:none;margin:0 24px 100px;">
        <div style="background:rgba(232,184,75,0.08);border:1px solid rgba(232,184,75,0.25);border-radius:12px;padding:16px;margin-bottom:16px;">
          <div style="font-size:12px;font-weight:700;color:#E8B84B;margin-bottom:8px;">🎯 DÉBLOQUEZ LE BADGE GOLD</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.6;">Téléchargez vos certificats d'organismes agréés (Apave, Bureau Veritas, Socotec...) pour obtenir un <strong style="color:var(--text);">score vérifié officiel</strong>. Votre badge Gold augmente votre visibilité de <strong style="color:#E8B84B;">+47%</strong> et votre taux de conversion de <strong style="color:#E8B84B;">+23%</strong>.</div>
        </div>

        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">DOCUMENTS À FOURNIR</div>
        
        <!-- Checklist documents -->
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px;">
          
          <!-- Doc 1 : Certificat conformité -->
          <div class="upload-doc-item" data-doc="conformite">
            <div style="display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);">
              <div class="upload-checkbox">☐</div>
              <div style="flex:1;">
                <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">1. Certificat de conformité ERP</div>
                <div style="font-size:10px;color:var(--muted);line-height:1.5;margin-bottom:8px;">Document délivré par un organisme agréé (Apave, Bureau Veritas, Socotec...) attestant de la conformité globale de votre établissement aux normes de sécurité.</div>
                <div style="font-size:9px;color:#E8B84B;background:rgba(232,184,75,0.1);border:1px solid rgba(232,184,75,0.2);border-radius:6px;padding:6px 8px;display:inline-block;">💡 Ce document est le plus important — il génère 70% de votre score</div>
              </div>
            </div>
            <div style="padding:12px 16px;background:rgba(0,0,0,0.02);border-bottom:1px solid var(--border);">
              <input type="file" id="uploadConformite" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="handleUpload('conformite', this)">
              <button onclick="document.getElementById('uploadConformite').click()" style="background:var(--green);color:#000;border:none;border-radius:8px;padding:9px 14px;font-size:11px;font-weight:700;cursor:pointer;width:100%;">📤 Télécharger le certificat</button>
            </div>
          </div>

          <!-- Doc 2 : Registre sécurité -->
          <div class="upload-doc-item" data-doc="registre">
            <div style="display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);">
              <div class="upload-checkbox">☐</div>
              <div style="flex:1;">
                <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">2. Registre de sécurité</div>
                <div style="font-size:10px;color:var(--muted);line-height:1.5;margin-bottom:8px;">Registre tenu à jour avec les contrôles périodiques des équipements (extincteurs, alarme incendie, éclairage de secours...)</div>
                <div style="font-size:9px;color:var(--muted);font-style:italic;">Optionnel mais recommandé • Améliore votre score de +5 à +8 points</div>
              </div>
            </div>
            <div style="padding:12px 16px;background:rgba(0,0,0,0.02);border-bottom:1px solid var(--border);">
              <input type="file" id="uploadRegistre" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="handleUpload('registre', this)">
              <button onclick="document.getElementById('uploadRegistre').click()" style="background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:9px 14px;font-size:11px;font-weight:600;cursor:pointer;width:100%;">📤 Télécharger le registre</button>
            </div>
          </div>

          <!-- Doc 3 : Attestation extincteurs -->
          <div class="upload-doc-item" data-doc="extincteurs">
            <div style="display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);">
              <div class="upload-checkbox">☐</div>
              <div style="flex:1;">
                <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">3. Attestation contrôle extincteurs</div>
                <div style="font-size:10px;color:var(--muted);line-height:1.5;margin-bottom:8px;">Certificat de vérification annuelle des extincteurs par un organisme agréé (contrôle obligatoire tous les ans)</div>
                <div style="font-size:9px;color:var(--muted);font-style:italic;">Optionnel • Améliore votre score de +3 à +5 points</div>
              </div>
            </div>
            <div style="padding:12px 16px;background:rgba(0,0,0,0.02);border-bottom:1px solid var(--border);">
              <input type="file" id="uploadExtincteurs" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="handleUpload('extincteurs', this)">
              <button onclick="document.getElementById('uploadExtincteurs').click()" style="background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:9px 14px;font-size:11px;font-weight:600;cursor:pointer;width:100%;">📤 Télécharger l'attestation</button>
            </div>
          </div>

          <!-- Doc 4 : Assurance RC -->
          <div class="upload-doc-item" data-doc="assurance">
            <div style="display:flex;align-items:flex-start;gap:12px;padding:14px 16px;">
              <div class="upload-checkbox">☐</div>
              <div style="flex:1;">
                <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;">4. Attestation assurance RC</div>
                <div style="font-size:10px;color:var(--muted);line-height:1.5;margin-bottom:8px;">Attestation d'assurance responsabilité civile en cours de validité</div>
                <div style="font-size:9px;color:var(--muted);font-style:italic;">Optionnel • Améliore votre score de +2 à +4 points</div>
              </div>
            </div>
            <div style="padding:12px 16px;background:rgba(0,0,0,0.02);">
              <input type="file" id="uploadAssurance" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="handleUpload('assurance', this)">
              <button onclick="document.getElementById('uploadAssurance').click()" style="background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:9px 14px;font-size:11px;font-weight:600;cursor:pointer;width:100%;">📤 Télécharger l'attestation</button>
            </div>
          </div>
        </div>

        <!-- Progression -->
        <div id="uploadProgress" style="display:none;background:rgba(0,200,120,0.08);border:1px solid rgba(0,200,120,0.25);border-radius:12px;padding:14px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <div style="font-size:11px;color:var(--green);font-weight:700;flex:1;">DOCUMENTS TÉLÉCHARGÉS</div>
            <div style="font-size:13px;font-weight:800;color:var(--green);"><span id="uploadCount">0</span>/4</div>
          </div>
          <div style="background:rgba(0,0,0,0.15);border-radius:6px;height:6px;overflow:hidden;">
            <div id="uploadBar" style="width:0%;height:100%;background:var(--green);transition:width .3s;"></div>
          </div>
        </div>

        <!-- Bouton validation -->
        <button id="validateBtn" onclick="validateDocuments()" disabled style="width:100%;background:var(--card);color:var(--muted);border:1px solid var(--border);border-radius:10px;padding:13px;font-size:13px;font-weight:700;cursor:not-allowed;margin-bottom:16px;">🔒 Valider mes documents</button>

        <!-- Info délai -->
        <div style="background:rgba(160,100,255,0.08);border:1px solid rgba(160,100,255,0.2);border-radius:12px;padding:14px;">
          <div style="font-size:11px;color:#A064FF;font-weight:700;margin-bottom:6px;">⏱️ DÉLAI DE VÉRIFICATION</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.6;">Une fois vos documents validés, notre équipe les vérifie sous <strong style="color:var(--text);">48h ouvrées</strong>. Vous recevrez une notification dès que votre badge Gold sera actif.</div>
        </div>
      </div>

      <!-- Documents téléchargés (si badge Silver actif) -->
      <div id="silverDocs" style="margin:0 24px 100px;">
        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">MES DOCUMENTS AUTO-DÉCLARÉS</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;">
          <div style="font-size:11px;color:var(--muted);text-align:center;padding:20px 0;">
            <div style="font-size:32px;margin-bottom:8px;">📋</div>
            <div>Aucun document téléchargé</div>
            <div style="font-size:10px;margin-top:4px;">Cliquez sur "Passer au badge Gold" ci-dessus pour ajouter vos certificats officiels</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SUB: ANALYTICS -->
    <div class="owner-sub" id="ownerAnalytics">
      <div style="padding:16px 24px 0;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div class="section-title" style="margin:0;">Statistiques de consultation</div>
          <div class="back-btn" onclick="switchOwnerTab('home')">← Retour</div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:16px;">Bar du Centre • Tours — 30 derniers jours</div>
      </div>

      <!-- KPIs -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 24px 16px;">
        <div style="background:linear-gradient(135deg,rgba(0,200,120,0.12),rgba(0,200,120,0.04));border:1px solid rgba(0,200,120,0.25);border-radius:14px;padding:14px;">
          <div style="font-size:10px;color:var(--green);font-weight:700;letter-spacing:.05em;margin-bottom:6px;">VUES FICHE</div>
          <div style="font-size:28px;font-weight:900;color:var(--text);line-height:1;" class="kpi-vues">847</div>
          <div style="font-size:10px;color:var(--green);margin-top:4px;">↑ +23% vs mois préc.</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(232,184,75,0.12),rgba(232,184,75,0.04));border:1px solid rgba(232,184,75,0.25);border-radius:14px;padding:14px;">
          <div style="font-size:10px;color:var(--gold, #E8B84B);font-weight:700;letter-spacing:.05em;margin-bottom:6px;">SCANS QR</div>
          <div style="font-size:28px;font-weight:900;color:var(--text);line-height:1;" class="kpi-scans">134</div>
          <div style="font-size:10px;color:var(--gold, #E8B84B);margin-top:4px;">↑ +41% vs mois préc.</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;">
          <div style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.05em;margin-bottom:6px;">SCORE MOYEN VU</div>
          <div style="font-size:28px;font-weight:900;color:var(--text);line-height:1;">82<span style="font-size:14px;color:var(--muted)">/100</span></div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">Stable ce mois</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;">
          <div style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.05em;margin-bottom:6px;">CLASSEMENT LOCAL</div>
          <div style="font-size:28px;font-weight:900;color:var(--text);line-height:1;">#2<span style="font-size:14px;color:var(--muted)">/7</span></div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">Bars du centre-ville</div>
        </div>
      </div>

      <!-- Graphe visites 30j -->
      <div style="margin:0 24px 16px;">
        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">VISITES PAR JOUR — 30 DERNIERS JOURS</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;">
          <canvas id="analyticsChart" width="270" height="100" style="width:100%;height:100px;"></canvas>
        </div>
      </div>

      <!-- Sélecteur période -->
      <div style="padding:0 24px;margin-bottom:16px;display:flex;gap:8px;">
        <div id="period7"  onclick="setPeriod(7)"  style="background:var(--card);border:1px solid var(--border);border-radius:100px;padding:5px 12px;font-size:11px;color:var(--muted);cursor:pointer;">7j</div>
        <div id="period30" onclick="setPeriod(30)" style="background:rgba(0,200,120,0.15);border:1px solid rgba(0,200,120,0.4);border-radius:100px;padding:5px 12px;font-size:11px;color:var(--green);font-weight:700;cursor:pointer;">30j</div>
        <div id="period90" onclick="setPeriod(90)" style="background:var(--card);border:1px solid var(--border);border-radius:100px;padding:5px 12px;font-size:11px;color:var(--muted);cursor:pointer;">90j</div>
      </div>

      <!-- Sources de trafic -->
      <div style="margin:0 24px 16px;">
        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">SOURCES DE CONSULTATION</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;">
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
            <div style="font-size:18px;">📱</div>
            <div style="flex:1;">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="font-size:12px;font-weight:600;color:var(--text);">Application Spotysafe</span>
                <span style="font-size:12px;font-weight:700;color:var(--green);">58%</span>
              </div>
              <div style="background:var(--border);border-radius:4px;height:4px;"><div style="width:58%;height:100%;background:var(--green);border-radius:4px;"></div></div>
            </div>
          </div>
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
            <div style="font-size:18px;">🔷</div>
            <div style="flex:1;">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="font-size:12px;font-weight:600;color:var(--text);">Scan QR badge vitrine</span>
                <span style="font-size:12px;font-weight:700;color:#E8B84B;">16%</span>
              </div>
              <div style="background:var(--border);border-radius:4px;height:4px;"><div style="width:16%;height:100%;background:#E8B84B;border-radius:4px;"></div></div>
            </div>
          </div>
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
            <div style="font-size:18px;">🗺️</div>
            <div style="flex:1;">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="font-size:12px;font-weight:600;color:var(--text);">Google Maps</span>
                <span style="font-size:12px;font-weight:700;color:#3B9EFF;">18%</span>
              </div>
              <div style="background:var(--border);border-radius:4px;height:4px;"><div style="width:18%;height:100%;background:#3B9EFF;border-radius:4px;"></div></div>
            </div>
          </div>
          <div style="padding:12px 16px;display:flex;align-items:center;gap:12px;">
            <div style="font-size:18px;">🌐</div>
            <div style="flex:1;">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="font-size:12px;font-weight:600;color:var(--text);">Recherche web directe</span>
                <span style="font-size:12px;font-weight:700;color:var(--muted);">8%</span>
              </div>
              <div style="background:var(--border);border-radius:4px;height:4px;"><div style="width:8%;height:100%;background:var(--muted);border-radius:4px;"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Conseil -->
      <div style="margin:0 24px 100px;">
        <div style="background:rgba(0,200,120,0.06);border:1px solid rgba(0,200,120,0.2);border-radius:12px;padding:14px 16px;">
          <div style="font-size:11px;color:var(--green);font-weight:700;margin-bottom:6px;">💡 CONSEIL SPOTYSAFE</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.6;">Votre score de 82/100 vous place dans le <strong style="color:var(--text);">top 30%</strong> des bars de Tours. Corriger le point "Détecteurs fumée" vous ferait gagner <strong style="color:var(--green);">+8 points</strong> et passer en top 10%.</div>
        </div>
      </div>

      <!-- Comparatif concurrents -->
      <div style="margin:0 24px 16px;">
        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">COMPARATIF — VOS 3 CONCURRENTS LES PLUS PROCHES</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;">
          <!-- Vous -->
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(0,200,120,0.05);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-size:12px;font-weight:700;color:var(--green);">📍 Vous — Bar du Centre</span>
              <span style="font-size:14px;font-weight:900;color:var(--green);">82</span>
            </div>
            <div style="background:var(--border);border-radius:4px;height:5px;"><div style="width:82%;height:100%;background:var(--green);border-radius:4px;"></div></div>
          </div>
          <!-- Concurrent 1 -->
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-size:12px;font-weight:600;color:var(--text);">Le Vieux Murier <span style="color:var(--muted);font-size:10px;">· 170m</span></span>
              <span style="font-size:14px;font-weight:900;color:var(--text);">82</span>
            </div>
            <div style="background:var(--border);border-radius:4px;height:5px;"><div style="width:82%;height:100%;background:rgba(255,255,255,0.3);border-radius:4px;"></div></div>
          </div>
          <!-- Concurrent 2 -->
          <div style="padding:12px 16px;border-bottom:1px solid var(--border);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-size:12px;font-weight:600;color:var(--text);">La Guinguette <span style="color:var(--muted);font-size:10px;">· 330m</span></span>
              <span style="font-size:14px;font-weight:900;color:var(--green);">85 ↑</span>
            </div>
            <div style="background:var(--border);border-radius:4px;height:5px;"><div style="width:85%;height:100%;background:var(--green);border-radius:4px;"></div></div>
          </div>
          <!-- Concurrent 3 -->
          <div style="padding:12px 16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-size:12px;font-weight:600;color:var(--text);">Le Petit Zinc <span style="color:var(--muted);font-size:10px;">· 420m</span></span>
              <span style="font-size:14px;font-weight:900;color:var(--orange);">71</span>
            </div>
            <div style="background:var(--border);border-radius:4px;height:5px;"><div style="width:71%;height:100%;background:var(--orange);border-radius:4px;"></div></div>
          </div>
        </div>
      </div>

      <!-- Score historique 12 mois -->
      <div style="margin:0 24px 16px;">
        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">ÉVOLUTION DU SCORE — 12 DERNIERS MOIS</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;">
          <canvas id="scoreHistoryChart" width="270" height="80" style="width:100%;height:80px;"></canvas>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <span style="font-size:9px;color:var(--muted);">Fév 2025</span>
            <span style="font-size:9px;color:var(--muted);">Août 2025</span>
            <span style="font-size:9px;color:var(--green);font-weight:700;">Fév 2026</span>
          </div>
        </div>
      </div>

      <!-- Export rapport -->
      <div style="margin:0 24px 100px;">
        <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-bottom:10px;">RAPPORT MENSUEL</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--text);">Rapport Janvier 2026</div>
              <div style="font-size:10px;color:var(--muted);margin-top:2px;">847 vues · 134 scans · score moyen 82</div>
            </div>
            <div style="font-size:24px;">📊</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="showToast('📥 Rapport PDF téléchargé')" style="flex:1;background:rgba(0,200,120,0.12);border:1px solid rgba(0,200,120,0.3);color:var(--green);border-radius:10px;padding:10px;font-size:11px;font-weight:700;cursor:pointer;">📥 Télécharger PDF</button>
            <button onclick="showToast('📧 Rapport envoyé par email')" style="flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px;font-size:11px;font-weight:600;cursor:pointer;">📧 Envoyer email</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SUB: RÉGLAGES -->
    <div class="owner-sub" id="ownerSettings">
      <div class="header-top" style="padding-top:8px;">
        <div><div class="section-title">Réglages</div></div>
        <div class="back-btn" onclick="switchOwnerTab('home')">← Retour</div>
      </div>
      <div style="padding:40px 24px;text-align:center;color:var(--muted);">
        <div style="font-size:48px;margin-bottom:16px;">⚙️</div>
        <div style="font-size:13px;">Gérez votre profil et vos préférences</div>
      </div>
    </div>

  </div>


  <!-- ════════ SOIRÉE SÉCURISÉE ════════ -->
  <div class="screen" id="soiree" style="background:linear-gradient(160deg,#12002A 0%,#1A0038 35%,#0D001F 65%,#1C0035 100%);">

    <!-- Halos déco (position:absolute pour rester dans le phone) -->
    <div style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;overflow:hidden;z-index:0;">
      <div style="position:absolute;top:5%;left:10%;width:200px;height:200px;background:radial-gradient(circle,rgba(160,40,255,.22) 0%,transparent 70%);border-radius:50%;"></div>
      <div style="position:absolute;top:38%;right:-30px;width:140px;height:140px;background:radial-gradient(circle,rgba(255,60,180,.15) 0%,transparent 70%);border-radius:50%;"></div>
      <div style="position:absolute;bottom:20%;left:15%;width:100px;height:100px;background:radial-gradient(circle,rgba(100,200,255,.1) 0%,transparent 70%);border-radius:50%;"></div>
    </div>

    <div style="position:relative;z-index:1;padding-bottom:100px;">

      <!-- Header -->
      <div style="padding:24px 20px 0;display:flex;align-items:flex-start;justify-content:space-between;">
        <div>
          <div style="font-size:10px;font-weight:700;color:rgba(200,160,255,.5);letter-spacing:.18em;text-transform:uppercase;margin-bottom:6px;">Ce soir on sort 🌙</div>
          <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:900;color:#fff;line-height:1.15;letter-spacing:-.5px;">Soirée<br><span style="background:linear-gradient(90deg,#C060FF,#FF60C0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Sécurisée</span> ✨</div>
          <div style="font-size:11px;color:rgba(200,160,255,.45);margin-top:6px;">Bars certifiés · Bonne ambiance garantie</div>
        </div>
        <div onclick="goTo('client')" style="background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:7px 14px;font-size:11px;color:rgba(255,255,255,.5);cursor:pointer;margin-top:4px;flex-shrink:0;">← Retour</div>
      </div>

      <!-- Divider lumineux -->
      <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(160,40,255,.5),rgba(255,60,180,.4),transparent);margin:16px 0 20px;"></div>

      <div style="padding:0 20px;">

        <!-- WHERE YOU AT ? -->
        <div style="font-size:10px;font-weight:800;color:rgba(200,160,255,.55);letter-spacing:.16em;text-transform:uppercase;margin-bottom:10px;">📍 T'es où ce soir ?</div>
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;" id="soireeZones">
          <div class="s-zone active" data-zone="tours" onclick="selectSoireeZone(this)">📍 Tours Centre</div>
          <div class="s-zone" data-zone="marais" onclick="selectSoireeZone(this)">🗼 Le Marais</div>
          <div class="s-zone" data-zone="oberkampf" onclick="selectSoireeZone(this)">🎸 Oberkampf</div>
          <div class="s-zone" data-zone="bastille" onclick="selectSoireeZone(this)">🔥 Bastille</div>
        </div>

        <!-- VIBE CHECK -->
        <div style="font-size:10px;font-weight:800;color:rgba(200,160,255,.55);letter-spacing:.16em;text-transform:uppercase;margin-bottom:10px;">🎭 Vibe check</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;" id="soireeVibes">
          <div class="s-vibe active" data-vibe="detente" onclick="selectVibe(this)">
            <span style="font-size:20px;">🍷</span>
            <div><div style="font-size:12px;font-weight:800;color:#fff;">Détendu</div><div style="font-size:10px;color:rgba(255,255,255,.4);">Chill &amp; talk</div></div>
          </div>
          <div class="s-vibe" data-vibe="festif" onclick="selectVibe(this)">
            <span style="font-size:20px;">🎉</span>
            <div><div style="font-size:12px;font-weight:800;color:#fff;">On se lâche</div><div style="font-size:10px;color:rgba(255,255,255,.4);">Full energy</div></div>
          </div>
          <div class="s-vibe" data-vibe="cocktail" onclick="selectVibe(this)">
            <span style="font-size:20px;">🍸</span>
            <div><div style="font-size:12px;font-weight:800;color:#fff;">Cocktails</div><div style="font-size:10px;color:rgba(255,255,255,.4);">Classy vibes</div></div>
          </div>
          <div class="s-vibe" data-vibe="live" onclick="selectVibe(this)">
            <span style="font-size:20px;">🎵</span>
            <div><div style="font-size:12px;font-weight:800;color:#fff;">Live music</div><div style="font-size:10px;color:rgba(255,255,255,.4);">Son à fond</div></div>
          </div>
        </div>

        <!-- SCORE MIN -->
        <div style="font-size:10px;font-weight:800;color:rgba(200,160,255,.55);letter-spacing:.16em;text-transform:uppercase;margin-bottom:10px;">🛡️ Niveau sécu minimum</div>
        <div style="display:flex;gap:8px;margin-bottom:24px;" id="soireeScores">
          <div class="s-score" data-min="70" onclick="selectSoireeScore(this)">≥ 70 OK</div>
          <div class="s-score active" data-min="80" onclick="selectSoireeScore(this)">≥ 80 ✓</div>
          <div class="s-score" data-min="90" onclick="selectSoireeScore(this)">≥ 90 🔒</div>
        </div>

        <!-- CTA -->
        <button onclick="generateItinerary()" style="width:100%;padding:16px;background:linear-gradient(135deg,#8020E0,#C040FF,#FF40C0);color:white;border:none;border-radius:18px;font-size:15px;font-weight:900;font-family:'Syne',sans-serif;cursor:pointer;box-shadow:0 6px 28px rgba(160,40,255,.4),0 0 0 1px rgba(255,255,255,.08);margin-bottom:24px;">
          ✨ Lance ma soirée !
        </button>

        <!-- RÉSULTATS -->
        <div id="soireeResults" style="display:none;">
          <div id="soireeHeadline" style="text-align:center;margin-bottom:18px;">
            <div style="font-size:26px;margin-bottom:6px;">🔥</div>
            <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:900;color:#fff;letter-spacing:-.3px;" id="soireeResultTitle">Ta soirée est prête !</div>
            <div style="font-size:11px;color:rgba(200,160,255,.6);margin-top:4px;" id="soireeResultSub">3 spots validés · Score moyen 87/100</div>
          </div>

          <div id="soireeItinerary" style="margin-bottom:18px;"></div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
            <button onclick="shareItinerary()" style="padding:13px;background:rgba(255,255,255,.07);color:#fff;border:1px solid rgba(255,255,255,.12);border-radius:14px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;">
              📤 Partager
            </button>
            <button onclick="generateItinerary()" style="padding:13px;background:rgba(160,40,255,.2);color:#C060FF;border:1px solid rgba(160,40,255,.35);border-radius:14px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;">
              🔀 Reshuffle
            </button>
          </div>

          <div style="background:rgba(0,200,120,.07);border:1px solid rgba(0,200,120,.18);border-radius:14px;padding:13px 15px;display:flex;gap:10px;align-items:center;margin-bottom:24px;">
            <div style="font-size:20px;flex-shrink:0;">🛡️</div>
            <div>
              <div style="font-size:12px;font-weight:800;color:#00C878;margin-bottom:2px;">100% certifiés Spotysafe</div>
              <div style="font-size:10px;color:rgba(255,255,255,.35);line-height:1.5;">Audités Apave / BV — t'as plus qu'à profiter 🎉</div>
            </div>
          </div>
        </div>

        <!-- HISTORIQUE -->
        <div style="font-size:10px;font-weight:800;color:rgba(200,160,255,.55);letter-spacing:.16em;text-transform:uppercase;margin-bottom:12px;">📅 Tes dernières sorties</div>
        <div class="s-history-card" onclick="replaySoiree(0)">
          <div style="font-size:20px;">🎉</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:#fff;">Tours Centre · 3 bars</div>
            <div style="font-size:11px;color:rgba(255,255,255,.35);margin-top:2px;">Score moyen 86 · il y a 5 jours</div>
          </div>
          <div style="font-size:16px;color:rgba(255,255,255,.2);">›</div>
        </div>
        <div class="s-history-card" onclick="replaySoiree(1)">
          <div style="font-size:20px;">🍷</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;color:#fff;">Le Marais · 4 bars</div>
            <div style="font-size:11px;color:rgba(255,255,255,.35);margin-top:2px;">Score moyen 91 · il y a 12 jours</div>
          </div>
          <div style="font-size:16px;color:rgba(255,255,255,.2);">›</div>
        </div>

      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

</div>

<script>
// ── DATA ──
const bars = [
  {
    name: "Le Vieux Murier",
    addr: "12 Place Plumereau, Tours",
    score: 82,
    type: "Bar • ERP Type N • 5e catégorie",
    capacity: "40 personnes",
    distance: "320m",
    lastInspection: "14 juin 2025",
    nextInspection: "juin 2026",
    scoreClass: "",
    lat: 47.3953, lng: 0.6831,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"✓ Conformes",cls:"green"},
      {label:"Détecteurs fumée",value:"⚠ Partiel",cls:"orange"},
      {label:"Éclairage sécu.",value:"✓ Conforme",cls:"green"},
      {label:"Affichages",value:"✓ Conformes",cls:"green"},
      {label:"Dernière visite",value:"juin 2025",cls:""},
    ]
  },
  {
    name: "Bar du Centre",
    addr: "5 Rue Colbert, Tours",
    score: 78,
    type: "Bar brasserie • ERP Type N • 3e catégorie",
    capacity: "80 personnes",
    distance: "150m",
    lastInspection: "3 mars 2025",
    nextInspection: "mars 2026",
    scoreClass: "orange",
    lat: 47.3935, lng: 0.6862,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"⚠ Action req.",cls:"orange"},
      {label:"Détecteurs fumée",value:"✗ Urgent",cls:"red"},
      {label:"Éclairage sécu.",value:"⚠ Partiel",cls:"orange"},
      {label:"Affichages",value:"✓ Conformes",cls:"green"},
      {label:"Dernière visite",value:"mars 2025",cls:""},
    ]
  },
  {
    name: "La Guinguette",
    addr: "8 Quai du Portillon, Tours",
    score: 85,
    type: "Bar concert • ERP Type L • 2e catégorie",
    capacity: "120 personnes",
    distance: "480m",
    lastInspection: "22 sept. 2025",
    nextInspection: "sept. 2026",
    scoreClass: "",
    lat: 47.3928, lng: 0.6820,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"✓ Conformes",cls:"green"},
      {label:"Détecteurs fumée",value:"✓ Conformes",cls:"green"},
      {label:"Éclairage sécu.",value:"✓ Conforme",cls:"green"},
      {label:"Affichages",value:"✓ Conformes",cls:"green"},
      {label:"Dernière visite",value:"sept. 2025",cls:""},
    ]
  },
  {
    name: "Le Marais Social Club",
    addr: "18 Rue de Bretagne, Paris 3e",
    score: 91,
    type: "Bar cocktails • ERP Type N • 5e catégorie",
    capacity: "60 personnes",
    distance: "Paris — Pilote bêta",
    lastInspection: "8 nov. 2025",
    nextInspection: "nov. 2026",
    scoreClass: "",
    lat: 48.8627, lng: 2.3597,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"✓ Conformes",cls:"green"},
      {label:"Détecteurs fumée",value:"✓ Conformes",cls:"green"},
      {label:"Éclairage sécu.",value:"✓ Conforme",cls:"green"},
      {label:"Affichages",value:"✓ Conformes",cls:"green"},
      {label:"Dernière visite",value:"nov. 2025",cls:""},
    ]
  },
  {
    name: "Café Oberkampf",
    addr: "3 Rue Oberkampf, Paris 11e",
    score: 74,
    type: "Bar concert • ERP Type L • 3e catégorie",
    capacity: "150 personnes",
    distance: "Paris — Pilote bêta",
    lastInspection: "5 oct. 2025",
    nextInspection: "oct. 2026",
    scoreClass: "orange",
    lat: 48.8651, lng: 2.3748,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"⚠ Action req.",cls:"orange"},
      {label:"Détecteurs fumée",value:"✓ Conformes",cls:"green"},
      {label:"Éclairage sécu.",value:"✓ Conforme",cls:"green"},
      {label:"Registre sécu.",value:"⚠ Incomplet",cls:"orange"},
      {label:"Dernière visite",value:"oct. 2025",cls:""},
    ]
  },
  {
    name: "Bar République",
    addr: "42 Bd du Temple, Paris 3e",
    score: 88,
    type: "Brasserie • ERP Type N • 2e catégorie",
    capacity: "200 personnes",
    distance: "Paris — Pilote bêta",
    lastInspection: "15 janv. 2026",
    nextInspection: "janv. 2027",
    scoreClass: "",
    lat: 48.8641, lng: 2.3623,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"✓ Conformes",cls:"green"},
      {label:"Détecteurs fumée",value:"✓ Conformes",cls:"green"},
      {label:"Éclairage sécu.",value:"✓ Conforme",cls:"green"},
      {label:"Affichages",value:"✓ Conformes",cls:"green"},
      {label:"Dernière visite",value:"janv. 2026",cls:""},
    ]
  },
  {
    name: "La Scène Bastille",
    addr: "7 Rue de la Roquette, Paris 11e",
    score: 71,
    type: "Bar PMU • ERP Type N • 5e catégorie",
    capacity: "90 personnes",
    distance: "Paris — Pilote bêta",
    lastInspection: "2 déc. 2025",
    nextInspection: "déc. 2026",
    scoreClass: "orange",
    lat: 48.8535, lng: 2.3710,
    details: [
      {label:"Extincteurs",value:"✓ Conformes",cls:"green"},
      {label:"Issues secours",value:"✓ Conformes",cls:"green"},
      {label:"Détecteurs fumée",value:"⚠ Partiel",cls:"orange"},
      {label:"Éclairage sécu.",value:"⚠ Action req.",cls:"orange"},
      {label:"Affichages",value:"✓ Conformes",cls:"green"},
      {label:"Dernière visite",value:"déc. 2025",cls:""},
    ]
  }
];
function goTo(screen) {
  // Masquer tous les écrans
  document.querySelector('.phone').scrollTop = 0;
  document.querySelectorAll('.screen').forEach(function(s) {
    s.classList.remove('active');
  });
  // Masquer toutes les tab bars
  document.querySelectorAll('.tab-bar').forEach(function(t) {
    t.classList.remove('visible');
  });
  // Afficher l'écran cible
  var target = document.getElementById(screen);
  if (target) {
    target.classList.add('active');
    target.scrollTop = 0;
  }
  // Afficher la bonne tab bar
  if (screen === 'client') {
    document.getElementById('tabClient').classList.add('visible');
    initGeolocation();
  }
  if (screen === 'barowner') {
    document.getElementById('tabBar').classList.add('visible');
    animateScore();
  }
  if (screen === 'admin') {
    if (adminUnlocked) {
      initAdminDashboard();
    } else {
      showAdminPin();
      return; // Ne pas changer de screen — le PIN s'affiche en overlay
    }
  }
}

// ── MAP LEAFLET ──
var leafletMap = null;

function buildMap() {
  if (leafletMap) { leafletMap.invalidateSize(); return; }

  leafletMap = L.map('leafletMap', {
    center: [47.3941, 0.6848],
    zoom: 15,
    zoomControl: false,
    attributionControl: false,
    dragging: true,
    scrollWheelZoom: false
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(leafletMap);

  var barCoords = [
    { lat: 47.3953, lng: 0.6831, idx: 0, score: 82, name: 'Le Vieux Murier', cls: '' },
    { lat: 47.3935, lng: 0.6862, idx: 1, score: 78, name: 'Bar du Centre', cls: 'orange' },
    { lat: 47.3928, lng: 0.6820, idx: 2, score: 85, name: 'La Guinguette', cls: '' },
  ];

  barCoords.forEach(function(b) {
    var icon = L.divIcon({
      className: '',
      html: '<div class="spotysafe-marker ' + b.cls + '">' + b.score + ' • ' + b.name + '</div>',
      iconAnchor: [0, 20]
    });
    L.marker([b.lat, b.lng], { icon: icon })
      .addTo(leafletMap)
      .on('click', function() { window.openModal(b.idx); });
  });

  var userIcon = L.divIcon({
    className: '',
    html: '<div style="width:14px;height:14px;background:#4A9EFF;border-radius:50%;border:3px solid white;box-shadow:0 0 0 5px rgba(74,158,255,0.25);"></div>',
    iconAnchor: [7, 7]
  });
  L.marker([47.3941, 0.6848], { icon: userIcon }).addTo(leafletMap);
}

function loadLeafletThenMap() {
  if (typeof L !== 'undefined') {
    buildMap();
    return;
  }
  var script = document.createElement('script');
  script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  script.onload = function() { buildMap(); };
  script.onerror = function() { 
    document.getElementById('leafletMap').innerHTML = 
      '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(255,255,255,0.3);font-size:13px;">📡 Carte non disponible hors ligne</div>';
  };
  document.head.appendChild(script);
}

// ── GEOLOCATION ──
function initGeolocation() {
  var pill = document.getElementById('locationPill');
  var txt = document.getElementById('locationText');

  loadLeafletThenMap();

  if (!navigator.geolocation) {
    txt.textContent = 'Tours — Pilote bêta';
    return;
  }

  txt.textContent = 'Localisation en cours…';

  navigator.geolocation.getCurrentPosition(
    function(pos) {
      txt.textContent = pos.coords.latitude.toFixed(4) + '°N, ' + pos.coords.longitude.toFixed(4) + '°E • Tours';
      pill.style.background = 'rgba(0,232,122,0.15)';
      if (leafletMap) leafletMap.panTo([pos.coords.latitude, pos.coords.longitude]);
    },
    function() { txt.textContent = 'Tours — Pilote bêta'; },
    { timeout: 5000, maximumAge: 60000 }
  );
}

// ── MODAL ──
var currentBarIdx = 0;

window.openModal = function openModal(idx) {
  currentBarIdx = idx;
  var bar = bars[idx];
  document.getElementById('modalName').textContent = bar.name;
  document.getElementById('modalAddr').textContent = bar.addr + ' • ' + bar.type;

  var scoreEl = document.getElementById('modalScore');
  scoreEl.textContent = bar.score;
  scoreEl.className = 'modal-score-num' + (bar.scoreClass ? ' ' + bar.scoreClass : '');

  var barFill = document.getElementById('modalBar');
  barFill.style.width = bar.score + '%';
  barFill.className = 'modal-score-bar-fill' + (bar.scoreClass ? ' ' + bar.scoreClass : '');

  var grid = document.getElementById('modalGrid');
  grid.innerHTML = bar.details.map(function(d) {
    return '<div class="modal-detail-item"><div class="modal-detail-label">' + d.label + '</div><div class="modal-detail-value ' + d.cls + '">' + d.value + '</div></div>';
  }).join('');

  // Masquer la carte, afficher le modal
  document.getElementById('mapContainer').style.display = 'none';
  document.getElementById('detailModal').classList.add('open');
}

function closeModal(e) {
  if (!e || e.target === document.getElementById('detailModal')) {
    document.getElementById('detailModal').classList.remove('open');
    // Réafficher la carte
    document.getElementById('mapContainer').style.display = 'block';
    // Forcer Leaflet à recalculer la taille
    if (leafletMap) {
      setTimeout(function() { leafletMap.invalidateSize(); }, 50);
    }
  }
}

// ── SCORE ANIMATION ──
function animateScore() {
  const el = document.getElementById('animatedScore');
  let current = 0;
  const target = 78;
  const duration = 1200;
  const step = target / (duration / 16);

  const timer = setInterval(() => {
    current = Math.min(current + step, target);
    el.textContent = Math.round(current);
    if (current >= target) clearInterval(timer);
  }, 16);
}

// ── TOAST ──
// ── Upload documents functions ──
var uploadedDocs = { conformite: false, registre: false, extincteurs: false, assurance: false };

function goToBadgeUpgrade() {
  document.getElementById('badgeSilver').style.display = 'none';
  document.getElementById('silverDocs').style.display = 'none';
  document.getElementById('uploadFlow').style.display = 'block';
  showToast('📄 Téléchargez vos certificats pour débloquer le badge Gold');
}

function handleUpload(docType, input) {
  if (!input.files || !input.files[0]) return;
  
  var file = input.files[0];
  var maxSize = 10 * 1024 * 1024; // 10 MB
  
  if (file.size > maxSize) {
    showToast('❌ Fichier trop volumineux (max 10 MB)');
    input.value = '';
    return;
  }
  
  // Valider le type
  var allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    showToast('❌ Format non supporté (PDF, JPG ou PNG uniquement)');
    input.value = '';
    return;
  }
  
  // Marquer comme uploadé
  uploadedDocs[docType] = true;
  
  // Mettre à jour la checkbox
  var item = document.querySelector('.upload-doc-item[data-doc="' + docType + '"]');
  if (item) {
    var checkbox = item.querySelector('.upload-checkbox');
    checkbox.textContent = '✓';
    checkbox.style.color = 'var(--green)';
    checkbox.style.fontWeight = '900';
  }
  
  updateUploadProgress();
  showToast('✅ ' + file.name + ' téléchargé');
}

function updateUploadProgress() {
  var count = Object.values(uploadedDocs).filter(Boolean).length;
  var progress = document.getElementById('uploadProgress');
  var countEl = document.getElementById('uploadCount');
  var bar = document.getElementById('uploadBar');
  var validateBtn = document.getElementById('validateBtn');
  
  if (count > 0) {
    progress.style.display = 'block';
    countEl.textContent = count;
    bar.style.width = (count / 4 * 100) + '%';
    
    // Activer le bouton si au moins le certificat de conformité est uploadé
    if (uploadedDocs.conformite) {
      validateBtn.disabled = false;
      validateBtn.style.background = 'linear-gradient(135deg,#E8B84B,#D4A030)';
      validateBtn.style.color = '#000';
      validateBtn.style.cursor = 'pointer';
      validateBtn.style.borderColor = '#E8B84B';
      validateBtn.innerHTML = '🏆 Valider et obtenir le badge Gold';
    }
  }
}

function validateDocuments() {
  if (!uploadedDocs.conformite) {
    showToast('❌ Le certificat de conformité est obligatoire');
    return;
  }
  
  // Simulation validation
  showToast('📤 Documents envoyés pour vérification...');
  
  setTimeout(function() {
    // Masquer l'upload flow
    document.getElementById('uploadFlow').style.display = 'none';
    document.getElementById('silverDocs').style.display = 'none';
    
    // Afficher le badge Gold
    document.getElementById('badgeSilver').style.display = 'none';
    document.getElementById('badgeGold').style.display = 'block';
    
    showToast('🎉 Badge Gold activé ! Vos documents ont été vérifiés.');
    
    // Scroll to top
    document.querySelector('.phone').scrollTop = 0;
  }, 1500);
}

// ── Existing functions below ──
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2800);
}

// ── NAVIGATION GPS ──
function navigate() {
  var bar = bars[currentBarIdx];
  var lat = bar.lat;
  var lng = bar.lng;
  var name = encodeURIComponent(bar.name);
  var addr = encodeURIComponent(bar.addr);

  // Détection iPhone/iOS → Apple Maps
  var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  var isMac = /Mac/.test(navigator.userAgent) && navigator.maxTouchPoints > 0;

  if (isIOS || isMac) {
    // Apple Maps — ouvre l'app native Maps sur iPhone
    window.location.href = 'maps://maps.apple.com/?daddr=' + lat + ',' + lng + '&dirflg=w&q=' + name;
  } else {
    // Google Maps pour Android/Desktop
    window.open('https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng + '&destination_place_name=' + name + '&travelmode=walking', '_blank');
  }
}

// ── PARTENAIRES ──
var activeFilter = 'tous';

var partners = [
  {
    name: "UMIH — Union des Métiers",
    type: "Fédération professionnelle CHR",
    logo: "🏛",
    logoColor: "#1A1A3A",
    badges: ["pb-agréé", "pb-local", "pb-certif"],
    badgeLabels: ["✓ Partenaire officiel", "🤝 30 000 gérants", "CHR France"],
    tags: ["fédération", "erp"],
    rating: 4.9, reviews: 312,
    delay: "Contact immédiat",
    price: "Partenaire officiel",
    city: "Tours (37) & France",
    phone: "umih.fr",
    services: ["Réseau 30 000 gérants", "Accompagnement réglementaire", "Événements CHR", "Veille législative"],
    desc: "Premier partenaire Spotysafe. L'UMIH référence Spotysafe auprès de ses 30 000 adhérents gérants de bars, restaurants et hôtels en France."
  },
  {
    name: "France Boissons (Heineken)",
    type: "Distributeur CHR national",
    logo: "🍺",
    logoColor: "#1A2A1A",
    badges: ["pb-agréé", "pb-rapide"],
    badgeLabels: ["✓ Distribution nationale", "200K établissements"],
    tags: ["distribution", "erp"],
    rating: 4.7, reviews: 198,
    delay: "Tournée hebdomadaire",
    price: "Co-distribution",
    city: "France entière",
    phone: "franceboissons.com",
    services: ["Distribution nationale CHR", "200 000 établissements/semaine", "Présentation Spotysafe en tournée", "Commission apporteur d'affaires"],
    desc: "Réseau de distribution Heineken présent chez 200 000 établissements CHR chaque semaine. Les commerciaux France Boissons présentent Spotysafe lors de leurs tournées."
  },
  {
    name: "Apave Centre-Val de Loire",
    type: "Bureau de contrôle agréé",
    logo: "🏢",
    logoColor: "#1A3A6A",
    badges: ["pb-agréé", "pb-local", "pb-certif"],
    badgeLabels: ["✓ Agréé Préfecture", "📍 Tours", "ERP certifié"],
    tags: ["bureau", "erp"],
    rating: 4.8, reviews: 124,
    delay: "Sous 5 jours",
    price: "À partir de 380€",
    city: "Tours (37)",
    phone: "02 47 XX XX XX",
    services: ["Visite de sécurité ERP", "Rapport commission", "Suivi annuel", "Certification incendie"],
    desc: "Bureau de contrôle référence en région Centre. Intervient sur tous types d'ERP jusqu'à la 1ère catégorie."
  },
  {
    name: "Bureau Veritas Centre",
    type: "Bureau de contrôle & certification",
    logo: "✅",
    logoColor: "#1A2A3A",
    badges: ["pb-agréé", "pb-certif"],
    badgeLabels: ["✓ Agréé Préfecture", "ERP certifié"],
    tags: ["bureau", "erp", "securite"],
    rating: 4.9, reviews: 201,
    delay: "Sous 10 jours",
    price: "À partir de 450€",
    city: "Orléans (45)",
    phone: "02 38 XX XX XX",
    services: ["Contrôle réglementaire ERP", "Commission de sécurité", "Audit complet", "Rapport officiel"],
    desc: "Leader mondial du contrôle. Rapport reconnu par toutes les commissions de sécurité de la région."
  },
  {
    name: "Socotec Indre-et-Loire",
    type: "Organisme de prévention sécurité",
    logo: "🔬",
    logoColor: "#1A1A2E",
    badges: ["pb-agréé", "pb-rapide", "pb-certif"],
    badgeLabels: ["✓ Agréé Ministère", "⚡ Rapide", "ERP certifié"],
    tags: ["bureau", "erp", "rapide"],
    rating: 4.6, reviews: 89,
    delay: "Sous 48h",
    price: "À partir de 290€",
    city: "Tours (37)",
    phone: "02 47 XX XX XX",
    services: ["Audit sécurité ERP", "Mise en conformité", "Formation SSI", "Certification"],
    desc: "Interventions rapides garanties sous 48h. Spécialiste des bars, restaurants et ERP de type N et L."
  },
  {
    name: "Sécuritas Protection",
    type: "Conseil en sécurité incendie",
    logo: "🛡️",
    logoColor: "#1A2A1A",
    badges: ["pb-agréé", "pb-local"],
    badgeLabels: ["✓ Agréé", "📍 Tours"],
    tags: ["securite"],
    rating: 4.5, reviews: 67,
    delay: "Sous 7 jours",
    price: "À partir de 250€",
    city: "Tours (37)",
    phone: "02 47 XX XX XX",
    services: ["Installation extincteurs", "Détection incendie", "Éclairage sécurité", "Formation évacuation"],
    desc: "Spécialiste de l'installation et maintenance des équipements de sécurité incendie. Contrats d'entretien annuels."
  },
  {
    name: "SafeConsult Tours",
    type: "Cabinet conseil ERP indépendant",
    logo: "💼",
    logoColor: "#2A1A1A",
    badges: ["pb-local", "pb-rapide"],
    badgeLabels: ["📍 Tours", "⚡ Rapide"],
    tags: ["erp", "rapide"],
    rating: 4.7, reviews: 43,
    delay: "Sous 3 jours",
    price: "À partir de 180€",
    city: "Tours (37)",
    phone: "02 47 XX XX XX",
    services: ["Pré-audit ERP", "Accompagnement dossier", "Conseil mise en conformité", "Préparation visite"],
    desc: "Cabinet indépendant spécialisé bars et restaurants. Préparez votre dossier avant la commission officielle."
  }
];

function renderPartners(list) {
  var container = document.getElementById('partnersList');
  if (!list || list.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px 0;color:var(--muted);"><div style="font-size:36px;margin-bottom:12px;">🔍</div><div>Aucun partenaire trouvé</div></div>';
    return;
  }
  document.getElementById('partnersCount').textContent = list.length + ' organisme' + (list.length > 1 ? 's' : '') + ' • Tours, Paris & France';
  container.innerHTML = list.map(function(p, i) {
    return '<div class="partner-card" id="pcard' + i + '">' +
      '<div class="partner-card-top">' +
        '<div class="partner-logo" style="background:' + p.logoColor + ';">' + p.logo + '</div>' +
        '<div class="partner-info">' +
          '<div class="partner-name">' + p.name + '</div>' +
          '<div class="partner-type">' + p.type + '</div>' +
          '<div class="partner-badges">' +
            p.badges.map(function(b, bi) {
              return '<span class="partner-badge ' + b + '">' + p.badgeLabels[bi] + '</span>';
            }).join('') +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="partner-divider"></div>' +
      '<div class="partner-meta">' +
        '<div class="partner-meta-item">⭐ ' + p.rating + ' <span style="color:rgba(255,255,255,0.2)">(' + p.reviews + ' avis)</span></div>' +
        '<div class="partner-meta-item">📍 ' + p.city + '</div>' +
        '<div class="partner-meta-item">⏱ ' + p.delay + '</div>' +
      '</div>' +
      '<div class="partner-services">' +
        p.services.map(function(s) { return '<span class="partner-service">' + s + '</span>'; }).join('') +
      '</div>' +
      '<div style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.5;">' + p.desc + '</div>' +
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
        '<div class="partner-price">' + p.price + ' <span>/ évaluation</span></div>' +
      '</div>' +
      '<div class="partner-cta">' +
        '<button class="partner-btn partner-btn-primary" onclick="contactPartner(\' + p.name + \')">📞 Contacter</button>' +
        '<button class="partner-btn partner-btn-secondary" onclick="showToast(\'Devis envoy\u00e9 \' + p.name)">💬 Devis</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function filterPartners() {
  var search = document.getElementById('partnerSearch').value.toLowerCase();
  var filtered = partners.filter(function(p) {
    var matchFilter = activeFilter === 'tous' || p.tags.indexOf(activeFilter) !== -1;
    var matchSearch = search === '' ||
      p.name.toLowerCase().indexOf(search) !== -1 ||
      p.type.toLowerCase().indexOf(search) !== -1 ||
      p.city.toLowerCase().indexOf(search) !== -1 ||
      p.services.some(function(s) { return s.toLowerCase().indexOf(search) !== -1; });
    return matchFilter && matchSearch;
  });
  renderPartners(filtered);
}

function setFilter(filter, el) {
  activeFilter = filter;
  document.querySelectorAll('.filter-pill').forEach(function(p) { p.classList.remove('active'); });
  el.classList.add('active');
  filterPartners();
}

function contactPartner(name) {
  showToast('📞 Appel vers ' + name.split(' ')[0] + '…');
}

// ── OWNER TAB NAVIGATION ──
function switchOwnerTab(tab) {
  document.querySelectorAll('.owner-sub').forEach(function(s) { s.classList.remove('active'); });
  var tabs = ['Home', 'Analytics', 'Partners', 'Docs', 'Settings'];
  tabs.forEach(function(t) {
    var icon = document.getElementById('ownerTab' + t);
    var txt  = document.getElementById('ownerTab' + t + 'Txt');
    if (icon) icon.classList.remove('active');
    if (txt)  { txt.classList.remove('active'); txt.style.color = ''; }
  });
  var map = {
    'home':      { sub: 'ownerHome',      tab: 'Home' },
    'analytics': { sub: 'ownerAnalytics', tab: 'Analytics' },
    'partners':  { sub: 'ownerPartners',  tab: 'Partners' },
    'docs':      { sub: 'ownerDocs',      tab: 'Docs' },
    'settings':  { sub: 'ownerSettings',  tab: 'Settings' }
  };
  if (map[tab]) {
    var el   = document.getElementById(map[tab].sub);
    if (el)   el.classList.add('active');
    var icon = document.getElementById('ownerTab' + map[tab].tab);
    var txt  = document.getElementById('ownerTab' + map[tab].tab + 'Txt');
    if (icon) icon.classList.add('active');
    if (txt)  { txt.classList.add('active'); txt.style.color = 'var(--green)'; }
    if (tab === 'partners') renderPartners(partners);
    if (tab === 'analytics') { setTimeout(function(){ drawChart(); drawScoreHistory(); }, 80); }
    document.getElementById('barowner').scrollTop = 0;
  }
}

// ── CLIENT NAVIGATION ──
var currentClientTab = 'map';
// PIN Admin — déclaration globale (utilisé dans goTo avant le bloc PIN)
var adminUnlocked   = false;
var pinCurrent      = '';
var pinCorrect      = '240226';
var pinAttemptCount = 0;
var pinMaxAttempts  = 3;
var pinLocked       = false;
var favorites = [];
var searchFilter = 'tous';

function switchClientTab(tab) {
  currentClientTab = tab;
  var tabs = ['Map','Favorites','Search','Alerts','Report','Profile'];
  tabs.forEach(function(t) {
    var ic = document.getElementById('ctab'+t);
    var tx = document.getElementById('ctab'+t+'Txt');
    if (ic) { ic.classList.remove('active'); ic.style.opacity='0.4'; }
    if (tx) { tx.classList.remove('active'); tx.style.color = ''; }
  });
  var ic = document.getElementById('ctab'+ tab.charAt(0).toUpperCase()+tab.slice(1));
  var tx = document.getElementById('ctab'+ tab.charAt(0).toUpperCase()+tab.slice(1)+'Txt');
  if (ic) { ic.classList.add('active'); ic.style.opacity='1'; }
  var tabColors = {map:'#00C878',favorites:'#FF6B8A',search:'#3B82F6',alerts:'#E8B84B',report:'#FF6B6B',profile:'#A064FF'};
  if (tx) { tx.classList.add('active'); tx.style.color = tabColors[tab] || 'var(--green)'; }

  var header = document.querySelector('#client .client-header');

  // Masquer tous les sub-screens client
  ['clientSubFavorites','clientSubSearch','clientSubProfile','clientSubAlerts','clientSubReport'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  if (tab === 'map') {
    if (header) header.style.display = '';
    document.getElementById('mapContainer') && (document.getElementById('mapContainer').style.display = '');
    document.querySelectorAll('#client .bars-list').forEach(function(el){ el.style.display=''; });
    document.querySelectorAll('#client .section-title, #client .section-sub').forEach(function(el){ el.style.display=''; });
  } else {
    if (header) header.style.display = 'none';
    document.getElementById('mapContainer') && (document.getElementById('mapContainer').style.display = 'none');
    document.querySelectorAll('#client .bars-list').forEach(function(el){ el.style.display='none'; });
    var sub = document.getElementById('clientSub' + tab.charAt(0).toUpperCase()+tab.slice(1));
    if (sub) sub.style.display = '';
    if (tab === 'favorites') renderFavorites();
    if (tab === 'search')    { doClientSearch(); }
    if (tab === 'profile')   { document.getElementById('profileFavCount').textContent = favorites.length; }
    if (tab === 'alerts')    { renderWatchlist(); var b=document.getElementById('alertBadge'); if(b) b.style.display='none'; }
    if (tab === 'report')    { renderReportBarList(); }
  }
}

// ── FAVORIS ──
function toggleFavorite(idx) {
  var pos = favorites.indexOf(idx);
  if (pos === -1) {
    favorites.push(idx);
    showToast('⭐ ' + bars[idx].name + ' ajouté aux favoris');
  } else {
    favorites.splice(pos, 1);
    showToast('🗑 Retiré des favoris');
  }
  renderFavorites();
}

function renderFavorites() {
  var list = document.getElementById('favList');
  var empty = document.getElementById('favEmpty');
  var count = document.getElementById('favCount');
  if (!list) return;
  if (favorites.length === 0) {
    list.innerHTML = '';
    if (empty) empty.style.display = '';
    if (count) count.textContent = '0 bar';
    return;
  }
  if (empty) empty.style.display = 'none';
  if (count) count.textContent = favorites.length + ' bar' + (favorites.length > 1 ? 's' : '');
  list.innerHTML = favorites.map(function(idx) {
    var b = bars[idx];
    var cls = b.scoreClass === 'orange' ? 'orange' : '';
    return '<div class="bar-card" onclick="openModal('+idx+')" style="position:relative;">' +
      '<div style="position:absolute;top:10px;right:10px;cursor:pointer;font-size:16px;" onclick="event.stopPropagation();toggleFavorite('+idx+')">⭐</div>' +
      '<div class="bar-card-top" style="padding-right:36px;">' +
        '<div><div class="bar-name">'+b.name+'</div><div class="bar-type">'+b.addr+'</div></div>' +
        '<div class="score-badge '+cls+'"><div class="score-num '+cls+'">'+b.score+'</div><div class="score-label">/100</div></div>' +
      '</div>' +
      '<div class="score-bar-wrap"><div class="score-bar-track"><div class="score-bar-fill '+cls+'" style="width:'+b.score+'%"></div></div><div class="score-pct">'+b.score+'%</div></div>' +
    '</div>';
  }).join('');
}

// ── RECHERCHE ──
function setSearchFilter(f, el) {
  searchFilter = f;
  document.querySelectorAll('#searchFilters .filter-pill').forEach(function(p){ p.classList.remove('active'); });
  el.classList.add('active');
  doClientSearch();
}

function doClientSearch() {
  var q = (document.getElementById('clientSearchInput').value || '').toLowerCase().trim();
  var results = bars.filter(function(b) {
    var matchQ = !q || b.name.toLowerCase().includes(q) || b.addr.toLowerCase().includes(q) || b.type.toLowerCase().includes(q);
    var matchF = searchFilter === 'tous' ? true
      : searchFilter === 'top'   ? b.score >= 85
      : searchFilter === 'tours' ? b.addr.toLowerCase().includes('tours')
      : searchFilter === 'paris' ? b.addr.toLowerCase().includes('paris')
      : true;
    return matchQ && matchF;
  });

  var container = document.getElementById('searchResults');
  var empty = document.getElementById('searchEmpty');
  if (!container) return;

  if (results.length === 0) {
    container.innerHTML = '';
    if (empty) empty.style.display = '';
    return;
  }
  if (empty) empty.style.display = 'none';

  // Trier par score décroissant
  results.sort(function(a,b){ return b.score - a.score; });

  container.innerHTML = results.map(function(b) {
    var idx = bars.indexOf(b);
    var cls = b.scoreClass === 'orange' ? 'orange' : '';
    var isFav = favorites.indexOf(idx) !== -1;
    return '<div class="bar-card" onclick="openModal('+idx+')" style="position:relative;">' +
      '<div style="position:absolute;top:10px;right:10px;cursor:pointer;font-size:15px;" onclick="event.stopPropagation();toggleFavorite('+idx+')">'+(isFav?'⭐':'☆')+'</div>' +
      '<div class="bar-card-top" style="padding-right:36px;">' +
        '<div><div class="bar-name">'+b.name+'</div><div class="bar-type">'+b.addr+'</div></div>' +
        '<div class="score-badge '+cls+'"><div class="score-num '+cls+'">'+b.score+'</div><div class="score-label">/100</div></div>' +
      '</div>' +
      '<div class="score-bar-wrap"><div class="score-bar-track"><div class="score-bar-fill '+cls+'" style="width:'+b.score+'%"></div></div><div class="score-pct">'+b.score+'%</div></div>' +
      '<div style="font-size:10px;color:var(--muted);margin-top:6px;">'+b.type+'</div>' +
    '</div>';
  }).join('');
}

// ── PARENT MODULE ──
var parentCurrentTab = 'live';

var parentLocations = [
  { name:'Le Marais Social Club', addr:'18 Rue de Bretagne, Paris 3e', score:91, safe:true,
    dot:{x:0.55,y:0.42}, color:'#00C878' },
  { name:'Café Oberkampf',        addr:'3 Rue Oberkampf, Paris 11e',   score:74, safe:false,
    dot:{x:0.72,y:0.55}, color:'#FF8C00' },
  { name:'La Guinguette',         addr:'8 Quai du Portillon, Tours',   score:85, safe:true,
    dot:{x:0.30,y:0.65}, color:'#00C878' }
];
var parentCurrentLoc = 0;

function switchParentTab(tab) {
  parentCurrentTab = tab;
  ['live','history','settings'].forEach(function(t) {
    var sub  = document.getElementById('psub-'+t);
    var tabEl= document.getElementById('ptab-'+t);
    var icon = document.getElementById('ptabIcon' in window ? 'ptab'+t.charAt(0).toUpperCase()+t.slice(1)+'Icon' : '');
    var txt  = document.getElementById('ptab'+t.charAt(0).toUpperCase()+t.slice(1)+'Txt');
    if (sub)  sub.style.display  = t===tab ? '' : 'none';
    if (tabEl){
      tabEl.style.color       = t===tab ? '#A064FF' : 'var(--muted)';
      tabEl.style.borderBottom= t===tab ? '2px solid #A064FF' : '2px solid transparent';
      tabEl.style.fontWeight  = t===tab ? '700' : '600';
    }
    // tab bar bottom icons
    var bi = document.getElementById('ptab'+t.charAt(0).toUpperCase()+t.slice(1)+'Icon');
    var bt = document.getElementById('ptab'+t.charAt(0).toUpperCase()+t.slice(1)+'Txt');
    if (bi) { bi.classList.toggle('active', t===tab); }
    if (bt) { bt.classList.toggle('active', t===tab); bt.style.color = t===tab ? '#A064FF' : ''; }
  });
  if (tab === 'live') setTimeout(drawParentMap, 80);
}

function simulateLocation(idx) {
  parentCurrentLoc = idx;
  var loc = parentLocations[idx];
  var card = document.getElementById('safetyCard');
  var icon = document.getElementById('safetyIcon');
  var title= document.getElementById('safetyTitle');
  var sub  = document.getElementById('safetySubtitle');
  var score= document.getElementById('safetyScore');
  var venue= document.getElementById('currentVenue');
  var addr = document.getElementById('currentAddr');
  var upd  = document.getElementById('lastUpdate');

  if (loc.safe) {
    card.style.background = 'linear-gradient(135deg,rgba(0,200,120,0.12),rgba(0,200,120,0.04))';
    card.style.borderColor= 'rgba(0,200,120,0.35)';
    icon.textContent  = '✅';
    title.textContent = 'LIEU SÉCURISÉ';
    title.style.color = 'var(--green)';
    sub.textContent   = 'Score Spotysafe ≥ 85/100 · Vérifié';
    score.style.color = 'var(--green)';
  } else {
    card.style.background = 'linear-gradient(135deg,rgba(255,140,0,0.12),rgba(255,140,0,0.04))';
    card.style.borderColor= 'rgba(255,140,0,0.4)';
    icon.textContent  = '⚠️';
    title.textContent = 'LIEU NON CERTIFIÉ';
    title.style.color = 'var(--orange)';
    sub.textContent   = 'Score Spotysafe < 85/100 · Vérification recommandée';
    score.style.color = 'var(--orange)';
  }
  score.textContent = loc.score;
  venue.textContent = '📍 ' + loc.name;
  addr.textContent  = loc.addr;
  upd.textContent   = 'À l\'instant';
  if (!loc.safe) showToast('⚠️ Alerte : Léa est dans un lieu non certifié !');
  else showToast('✅ Léa est dans un lieu sécurisé');
  drawParentMap();
}

function drawParentMap() {
  var canvas = document.getElementById('parentMapCanvas');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width  = rect.width  * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = rect.height;
  var loc = parentLocations[parentCurrentLoc];

  // Fond carte simplifié
  ctx.fillStyle = '#0D0D18'; ctx.fillRect(0,0,W,H);

  // Rues simulées
  ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=6;
  [[0,H*0.35,W,H*0.35],[0,H*0.65,W,H*0.65],[W*0.25,0,W*0.25,H],[W*0.6,0,W*0.6,H],[W*0.45,0,W*0.45,H]].forEach(function(l){
    ctx.beginPath(); ctx.moveTo(l[0],l[1]); ctx.lineTo(l[2],l[3]); ctx.stroke();
  });
  ctx.strokeStyle='rgba(255,255,255,0.04)'; ctx.lineWidth=3;
  [[0,H*0.5,W,H*0.5],[W*0.15,0,W*0.15,H],[W*0.75,0,W*0.75,H]].forEach(function(l){
    ctx.beginPath(); ctx.moveTo(l[0],l[1]); ctx.lineTo(l[2],l[3]); ctx.stroke();
  });

  // Zone de rayon autour de la position
  var px = loc.dot.x * W, py = loc.dot.y * H;
  var rg = ctx.createRadialGradient(px,py,0,px,py,50);
  rg.addColorStop(0, loc.safe ? 'rgba(0,200,120,0.18)' : 'rgba(255,140,0,0.18)');
  rg.addColorStop(1, 'transparent');
  ctx.fillStyle = rg; ctx.beginPath(); ctx.arc(px,py,50,0,Math.PI*2); ctx.fill();

  // Point de position enfant
  ctx.beginPath(); ctx.arc(px,py,10,0,Math.PI*2);
  ctx.fillStyle = loc.color; ctx.fill();
  ctx.strokeStyle = '#07080A'; ctx.lineWidth=2; ctx.stroke();
  // Icône enfant
  ctx.fillStyle='#fff'; ctx.font='bold 10px sans-serif'; ctx.textAlign='center';
  ctx.fillText('🧑', px, py+4);

  // Label lieu
  ctx.fillStyle='rgba(10,10,20,0.85)';
  var lw = ctx.measureText(loc.name).width + 16;
  ctx.roundRect ? ctx.roundRect(px-lw/2, py-30, lw, 16, 4) : ctx.rect(px-lw/2,py-30,lw,16);
  ctx.fill();
  ctx.fillStyle=loc.color; ctx.font='bold 9px sans-serif';
  ctx.fillText(loc.name, px, py-19);
}

// Initialiser la carte parent au chargement de l'écran
var _origGoTo = goTo;
goTo = function(screen) {
  _origGoTo(screen);
  if (screen === 'parent') {
    // Afficher la tab bar parent, masquer les autres
    document.querySelectorAll('.tab-bar').forEach(function(tb){ tb.classList.remove('visible'); });
    var tp = document.getElementById('tabParent');
    if (tp) tp.classList.add('visible');
    switchParentTab('live');
  }
};

// ── FILTRE CARTE CLIENT ──
var mapFilter = 'tous';
function applyMapFilter(f, el) {
  mapFilter = f;
  document.querySelectorAll('#clientMapFilters .filter-pill').forEach(function(p){ p.classList.remove('active'); });
  if (el) el.classList.add('active');
  document.querySelectorAll('#client .bar-card').forEach(function(card) {
    var idx = parseInt(card.getAttribute('data-idx'));
    if (isNaN(idx)) { card.style.display=''; return; }
    var b = bars[idx];
    var show = f==='tous' ? true
      : f==='top'     ? b.score >= 85
      : f==='warning' ? b.score < 80
      : f==='tours'   ? b.addr.toLowerCase().includes('tours')
      : f==='paris'   ? b.addr.toLowerCase().includes('paris')
      : f==='open'    ? !card.innerHTML.includes('Fermé')
      : true;
    card.style.display = show ? '' : 'none';
  });
}

// ── ANALYTICS ──
var currentPeriod = 30;

// Données simulées pour le graphe historique 12 mois
var scoreHistory = [71, 71, 73, 74, 75, 76, 77, 78, 78, 80, 81, 82];
var scoreMonths  = ['F','M','A','M','J','J','A','S','O','N','D','J'];

function drawScoreHistory() {
  var canvas = document.getElementById('scoreHistoryChart');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width  = rect.width  * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = rect.height;
  var data = scoreHistory;
  var minV = 60, maxV = 100;
  var pad  = {l:22, r:8, t:8, b:14};
  var cw = W - pad.l - pad.r;
  var ch = H - pad.t - pad.b;
  var step = cw / (data.length - 1);

  ctx.clearRect(0,0,W,H);

  // Grille
  ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 0.7;
  [60,70,80,90,100].forEach(function(v){
    var y = pad.t + ch - ((v-minV)/(maxV-minV))*ch;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
    ctx.fillStyle='rgba(85,85,106,0.7)'; ctx.font='7px sans-serif'; ctx.textAlign='right';
    ctx.fillText(v, pad.l-3, y+3);
  });

  // Aire
  var grad = ctx.createLinearGradient(0,pad.t,0,pad.t+ch);
  grad.addColorStop(0,'rgba(232,184,75,0.25)'); grad.addColorStop(1,'rgba(232,184,75,0.02)');
  ctx.beginPath(); ctx.moveTo(pad.l, pad.t+ch);
  data.forEach(function(v,i){
    var x=pad.l+i*step; var y=pad.t+ch-((v-minV)/(maxV-minV))*ch;
    ctx.lineTo(x,y);
  });
  ctx.lineTo(pad.l+(data.length-1)*step, pad.t+ch); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();

  // Ligne
  ctx.beginPath(); ctx.strokeStyle='#E8B84B'; ctx.lineWidth=2; ctx.lineJoin='round';
  data.forEach(function(v,i){
    var x=pad.l+i*step; var y=pad.t+ch-((v-minV)/(maxV-minV))*ch;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  }); ctx.stroke();

  // Point final (aujourd'hui)
  var lx=pad.l+(data.length-1)*step;
  var ly=pad.t+ch-((data[data.length-1]-minV)/(maxV-minV))*ch;
  ctx.beginPath(); ctx.arc(lx,ly,4,0,Math.PI*2);
  ctx.fillStyle='#E8B84B'; ctx.fill();
  ctx.strokeStyle='#07080A'; ctx.lineWidth=2; ctx.stroke();

  // Valeur du dernier point
  ctx.fillStyle='#E8B84B'; ctx.font='bold 8px sans-serif'; ctx.textAlign='center';
  ctx.fillText(data[data.length-1], lx, ly-7);

  // Labels mois
  ctx.fillStyle='rgba(85,85,106,0.8)'; ctx.font='7px sans-serif'; ctx.textAlign='center';
  data.forEach(function(_,i){
    if(i%2===0||i===data.length-1){
      ctx.fillText(scoreMonths[i], pad.l+i*step, H-1);
    }
  });
}

// Appeler drawScoreHistory après drawChart


var visitData = {
  7:  [18,22,15,30,27,19,24],
  30: [12,18,14,22,16,28,20,15,24,19,30,22,18,26,31,24,17,20,28,23,15,19,27,22,34,28,19,24,31,26],
  90: (function(){var d=[];for(var i=0;i<90;i++){d.push(Math.floor(10+Math.random()*30+Math.sin(i/7)*8));}return d;})()
};

function drawChart() {
  var canvas = document.getElementById('analyticsChart');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  canvas.width  = rect.width  * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  var W = rect.width, H = rect.height;
  var data = visitData[currentPeriod];
  var max  = Math.max.apply(null, data);
  var pad  = {l:28, r:8, t:10, b:18};
  var cw   = W - pad.l - pad.r;
  var ch   = H - pad.t - pad.b;
  var step = cw / (data.length - 1);

  ctx.clearRect(0, 0, W, H);

  // Grille horizontale
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 0.8;
  [0, 0.25, 0.5, 0.75, 1].forEach(function(t) {
    var y = pad.t + ch * (1 - t);
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
    ctx.fillStyle = 'rgba(85,85,106,0.8)';
    ctx.font = '8px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(max * t), pad.l - 4, y + 3);
  });

  // Aire sous la courbe (gradient vert)
  var grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + ch);
  grad.addColorStop(0,   'rgba(0,200,120,0.35)');
  grad.addColorStop(1,   'rgba(0,200,120,0.02)');
  ctx.beginPath();
  ctx.moveTo(pad.l, pad.t + ch);
  data.forEach(function(v, i) {
    var x = pad.l + i * step;
    var y = pad.t + ch - (v / max) * ch;
    i === 0 ? ctx.lineTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(pad.l + (data.length - 1) * step, pad.t + ch);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Ligne de la courbe
  ctx.beginPath();
  ctx.strokeStyle = '#00C878';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  data.forEach(function(v, i) {
    var x = pad.l + i * step;
    var y = pad.t + ch - (v / max) * ch;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Point du jour le plus récent
  var lastX = pad.l + (data.length - 1) * step;
  var lastY = pad.t + ch - (data[data.length - 1] / max) * ch;
  ctx.beginPath();
  ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
  ctx.fillStyle = '#00C878';
  ctx.fill();
  ctx.strokeStyle = '#07080A';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Labels axe X
  ctx.fillStyle = 'rgba(85,85,106,0.8)';
  ctx.font = '8px sans-serif';
  ctx.textAlign = 'center';
  var labels = currentPeriod === 7
    ? ['L','M','M','J','V','S','D']
    : currentPeriod === 30
      ? ['J-30','','','','J-25','','','','J-20','','','','J-15','','','','J-10','','','','J-5','','','','','','','','','','Auj']
      : ['J-90','','','','','','','','','J-80','','','','','','','','','J-70','','','','','','','','','J-60','','','','','','','','','J-50','','','','','','','','','J-40','','','','','','','','','J-30','','','','','','','','','J-20','','','','','','','','','J-10','','','','','','','','','Auj'];
  var step2 = Math.max(1, Math.floor(data.length / 6));
  data.forEach(function(v, i) {
    if (i % step2 === 0 || i === data.length - 1) {
      var x = pad.l + i * step;
      var lbl = labels[i] || '';
      if (lbl) ctx.fillText(lbl, x, H - 2);
    }
  });
}

function setPeriod(days) {
  currentPeriod = days;
  [7, 30, 90].forEach(function(d) {
    var el = document.getElementById('period' + d);
    if (!el) return;
    if (d === days) {
      el.style.background = 'rgba(0,200,120,0.15)';
      el.style.border = '1px solid rgba(0,200,120,0.4)';
      el.style.color = 'var(--green)';
      el.style.fontWeight = '700';
    } else {
      el.style.background = 'var(--card)';
      el.style.border = '1px solid var(--border)';
      el.style.color = 'var(--muted)';
      el.style.fontWeight = '';
    }
  });
  drawChart();
  // Mettre à jour le sous-titre période
  var sub = document.querySelector('#ownerAnalytics .section-title + *');
  // Mettre à jour les KPIs selon période
  var kpiVues  = { 7: '198', 30: '847',  90: '2 341' };
  var kpiScans = { 7:  '31', 30: '134',  90:  '389'  };
  var kpiTrend = { 7: '+8%', 30: '+23%', 90: '+67%'  };
  var elVues = document.querySelector('#ownerAnalytics .kpi-vues');
  var elScans = document.querySelector('#ownerAnalytics .kpi-scans');
  if (elVues)  elVues.textContent  = kpiVues[days];
  if (elScans) elScans.textContent = kpiScans[days];
}

// ── CLOCK ──
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  document.getElementById('clock').textContent = h + ':' + m;
}
updateClock();
setInterval(updateClock, 1000);

// ════════════════════════════════════════════
// 🔔 ALERTES SCORE
// ════════════════════════════════════════════
var alertsEnabled = true;
var alertThreshold = 10;
var watchlist = [0, 2, 4]; // indices bars surveillés par défaut

function toggleMasterAlert() {
  alertsEnabled = !alertsEnabled;
  var toggle = document.getElementById('alertMasterToggle');
  var knob   = document.getElementById('alertToggleKnob');
  if (alertsEnabled) {
    toggle.style.background = 'var(--green)';
    knob.style.right = '3px';
    showToast('🔔 Alertes activées');
  } else {
    toggle.style.background = 'var(--muted)';
    knob.style.right = '22px';
    showToast('🔕 Alertes désactivées');
  }
}

function setThreshold(el) {
  document.querySelectorAll('.alert-threshold').forEach(function(b){ b.classList.remove('active'); });
  el.classList.add('active');
  alertThreshold = parseInt(el.dataset.val);
  showToast('✅ Seuil réglé sur ±' + alertThreshold + ' pts');
}

function renderWatchlist() {
  var container = document.getElementById('watchlistContainer');
  if (!container) return;
  if (watchlist.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px;">Aucun établissement surveillé</div>';
    return;
  }
  container.innerHTML = watchlist.map(function(idx) {
    var b = bars[idx];
    var scoreColor = b.score >= 85 ? 'var(--green)' : b.score >= 70 ? '#E8B84B' : '#FF6B6B';
    var scoreBg    = b.score >= 85 ? 'rgba(0,200,120,.12)' : b.score >= 70 ? 'rgba(232,184,75,.12)' : 'rgba(255,107,107,.12)';
    return '<div class="watchlist-item">' +
      '<div class="watchlist-score" style="background:'+scoreBg+';color:'+scoreColor+';">' + b.score + '</div>' +
      '<div style="flex:1;">' +
        '<div style="font-size:13px;font-weight:700;color:var(--text);">' + b.name + '</div>' +
        '<div style="font-size:11px;color:var(--muted);">' + b.address + '</div>' +
      '</div>' +
      '<div onclick="removeFromWatchlist('+idx+')" style="color:var(--muted);font-size:18px;cursor:pointer;padding:4px 8px;" title="Retirer">×</div>' +
    '</div>';
  }).join('');
}

function removeFromWatchlist(idx) {
  watchlist = watchlist.filter(function(i){ return i !== idx; });
  renderWatchlist();
  showToast('🗑 Retiré de la surveillance');
}

// Simuler une notification d'alerte après 8s sur l'écran client
setTimeout(function() {
  var badge = document.getElementById('alertBadge');
  if (badge && currentClientTab !== 'alerts') {
    badge.style.display = 'block';
    badge.textContent = '!';
    badge.style.animation = 'pulse 1.5s ease-in-out 3';
  }
}, 8000);

// ════════════════════════════════════════════
// 📸 SIGNALEMENT CITOYEN
// ════════════════════════════════════════════
var selectedReportBar  = null;
var selectedReportType = 'extincteur';
var reportAnon         = true;
var photoAdded         = false;

function renderReportBarList() {
  var list = document.getElementById('reportBarList');
  if (!list) return;
  list.innerHTML = bars.map(function(b, idx) {
    var scoreColor = b.score >= 85 ? 'var(--green)' : b.score >= 70 ? '#E8B84B' : '#FF6B6B';
    var active = selectedReportBar === idx;
    return '<div onclick="selectReportBar('+idx+')" style="' +
      'background:var(--card);border:' + (active ? '1.5px solid var(--green)' : '1px solid var(--border)') + ';' +
      'border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;' +
      'transition:border-color .15s;">' +
      '<div style="width:36px;height:36px;background:rgba(255,255,255,.05);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:'+scoreColor+';">'+b.score+'</div>' +
      '<div><div style="font-size:13px;font-weight:700;color:var(--text);">' + b.name + '</div>' +
      '<div style="font-size:11px;color:var(--muted);">' + b.address + '</div></div>' +
      (active ? '<div style="margin-left:auto;color:var(--green);font-size:16px;">✓</div>' : '') +
    '</div>';
  }).join('');
}

function filterReportBars(q) {
  var list = document.getElementById('reportBarList');
  if (!list) return;
  var filtered = bars.filter(function(b){ return b.name.toLowerCase().includes(q.toLowerCase()) || b.address.toLowerCase().includes(q.toLowerCase()); });
  if (filtered.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">Aucun résultat</div>';
    return;
  }
  list.innerHTML = filtered.map(function(b) {
    var idx = bars.indexOf(b);
    var scoreColor = b.score >= 85 ? 'var(--green)' : b.score >= 70 ? '#E8B84B' : '#FF6B6B';
    return '<div onclick="selectReportBar('+idx+')" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;">' +
      '<div style="width:36px;height:36px;background:rgba(255,255,255,.05);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:'+scoreColor+';">'+b.score+'</div>' +
      '<div><div style="font-size:13px;font-weight:700;color:var(--text);">' + b.name + '</div>' +
      '<div style="font-size:11px;color:var(--muted);">' + b.address + '</div></div>' +
    '</div>';
  }).join('');
}

function selectReportBar(idx) {
  selectedReportBar = idx;
  renderReportBarList();
  document.getElementById('reportSearch').value = bars[idx].name;
  showToast('📍 ' + bars[idx].name + ' sélectionné');
}

function selectReportType(el) {
  document.querySelectorAll('.report-type-btn').forEach(function(b){ b.classList.remove('active'); });
  el.classList.add('active');
  selectedReportType = el.dataset.type;
}

function simulatePhotoCapture() {
  photoAdded = true;
  document.getElementById('photoZone').style.display = 'none';
  document.getElementById('photoPreview').style.display = 'block';
  showToast('📸 Photo ajoutée');
}

function removePhoto() {
  photoAdded = false;
  document.getElementById('photoZone').style.display = 'block';
  document.getElementById('photoPreview').style.display = 'none';
}

var anonOn = true;
function toggleAnon() {
  anonOn = !anonOn;
  var knob   = document.getElementById('anonKnob');
  var toggle = document.getElementById('anonToggle');
  if (anonOn) {
    toggle.style.background = 'var(--green)';
    knob.style.right = '2px';
  } else {
    toggle.style.background = 'var(--muted)';
    knob.style.right = '18px';
  }
}

var typeLabels = { extincteur:'🧯 Extincteur manquant/expiré', sortie:'🚪 Sortie de secours bloquée', eclairage:'💡 Éclairage défaillant', affichage:'📋 Affichage absent', surcharge:'👥 Surcharge capacité', autre:'⚠️ Autre problème' };

function submitReport() {
  if (!selectedReportBar) { showToast('⚠️ Sélectionnez un établissement'); return; }
  var bar  = bars[selectedReportBar];
  var type = typeLabels[selectedReportType] || selectedReportType;
  var desc = document.getElementById('reportDesc').value.trim();

  // Afficher confirmation
  document.getElementById('reportStep1').style.display = 'none';
  document.getElementById('reportHistory').style.display = 'none';
  document.getElementById('reportStep2').style.display = 'block';

  var summary = '📍 <b>' + bar.name + '</b><br>' +
    '🔍 ' + type + '<br>' +
    (desc ? '💬 ' + desc + '<br>' : '') +
    (photoAdded ? '📸 Photo jointe<br>' : '') +
    '👤 ' + (anonOn ? 'Anonyme' : 'Identifié') + '<br>' +
    '🕐 ' + new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'});
  document.getElementById('reportSummary').innerHTML = summary;

  // Simuler impact score après 3s
  setTimeout(function() {
    showToast('⚡ Certificateur alerté — score en cours de réévaluation');
  }, 3000);
}

function resetReport() {
  selectedReportBar  = null;
  selectedReportType = 'extincteur';
  photoAdded         = false;
  document.getElementById('reportStep1').style.display = '';
  document.getElementById('reportStep2').style.display = 'none';
  document.getElementById('reportHistory').style.display = '';
  document.getElementById('reportDesc').value = '';
  document.getElementById('reportSearch').value = '';
  document.querySelectorAll('.report-type-btn').forEach(function(b,i){ b.classList.toggle('active', i===0); });
  removePhoto();
  renderReportBarList();
}

// ════════════════════════════════════════════
// 🔒 ADMIN DASHBOARD
// ════════════════════════════════════════════
var adminPeriod = '6m';

var revenueData = {
  '6m': { labels:['Sep','Oct','Nov','Dec','Jan','Fev'], values:[12,18,28,38,52,68] },
  '12m': { labels:['Mar','Avr','Mai','Jun','Jul','Aou','Sep','Oct','Nov','Dec','Jan','Fev'], values:[2,4,5,7,8,9,12,18,28,38,52,68] }
};

var geoData = [
  { city:'Tours', erp:412, pct:33, color:'#00C878' },
  { city:'Paris — Pilote', erp:289, pct:23, color:'#3B82F6' },
  { city:'Lyon', erp:187, pct:15, color:'#E8B84B' },
  { city:'Bordeaux', erp:143, pct:11, color:'#A064FF' },
  { city:'Marseille', erp:124, pct:10, color:'#FF6B8A' },
  { city:'Autres', erp:92, pct:8, color:'#55556A' }
];

var contractData = [
  { type:'Bar / Restaurant', count:534, pct:43, icon:'🍺' },
  { type:'Hotel', count:268, pct:21, icon:'🏨' },
  { type:'Salle de spectacle', count:187, pct:15, icon:'🎭' },
  { type:'Commerce', count:149, pct:12, icon:'🏪' },
  { type:'Salle de sport', count:109, pct:9, icon:'💪' }
];

var sysAlertsData = [
  { level:'critical', msg:'Certificateur BV — API timeout depuis 2h', time:'Il y a 2h', color:'#FF3B3B' },
  { level:'critical', msg:'Score anormal détecté · Le Bon Coin Paris 11e', time:'Il y a 4h', color:'#FF3B3B' },
  { level:'warn', msg:'Quota SMS parent atteint à 87%', time:'Il y a 6h', color:'#E8B84B' },
  { level:'info', msg:'Backup base ERP effectué avec succès', time:'Il y a 8h', color:'#00C878' }
];

var activityData = [
  { icon:'🆕', text:'Nouveau contrat Premium · Brasserie des Arts, Lyon', time:'Il y a 18 min' },
  { icon:'📸', text:'Signalement traité · Extincteur, Bar Oberkampf Paris', time:'Il y a 34 min' },
  { icon:'👤', text:'42 nouveaux users inscrits ce matin', time:'Il y a 1h' },
  { icon:'📋', text:'Audit complété · 12 ERP Tours — score moyen 81', time:'Il y a 2h' },
  { icon:'🔔', text:'Alerte score envoyée · 156 users — Le Vieux Murier', time:'Il y a 3h' },
  { icon:'🤝', text:'Nouveau partenaire · Groupama Assurances activé', time:'Il y a 5h' }
];

function initAdminDashboard() {
  renderAdminDate();
  renderGeoList();
  renderContractTypes();
  renderSysAlerts();
  renderAdminActivity();
  drawAdminChart(adminPeriod);
}

function adminAction(action) {
  var msgs = {
    export: '📊 Génération du rapport PDF en cours...',
    notify: '📣 Éditeur de notification push ouvert',
    audit: '🔍 Sélectionnez un ERP à auditer',
    partner: '🤝 Formulaire partenaire ouvert',
    promo: '🎟 Code promo généré : SPOT-2026-FREE',
    logs: '🔒 Ouverture des logs de sécurité...'
  };
  showToast(msgs[action] || 'Action en cours...');
}

// ══════════════════════════════════════════════
// PIN ADMIN — fonctions
// ══════════════════════════════════════════════

function showAdminPin() {
  pinCurrent = ''; pinAttemptCount = 0; pinLocked = false;
  updatePinDots();
  var e = document.getElementById('pinError');
  var a = document.getElementById('pinAttempts');
  if (e) e.textContent = '';
  if (a) a.textContent = '';
  var ov = document.getElementById('adminPinOverlay');
  if (ov) ov.style.display = 'flex';
}
function hidePinOverlay() {
  var ov = document.getElementById('adminPinOverlay');
  if (ov) ov.style.display = 'none';
}
function pinPress(digit) {
  if (pinLocked || pinCurrent.length >= 6) return;
  pinCurrent += digit;
  updatePinDots();
  if (pinCurrent.length === 6) setTimeout(checkPin, 200);
}
function pinDelete() {
  if (pinLocked) return;
  pinCurrent = pinCurrent.slice(0, -1);
  updatePinDots();
}
function pinCancel() { pinCurrent = ''; hidePinOverlay(); }
function updatePinDots() {
  for (var i = 0; i < 6; i++) {
    var d = document.getElementById('pd' + i);
    if (!d) continue;
    d.classList.remove('filled','error');
    if (i < pinCurrent.length) d.classList.add('filled');
  }
}
function checkPin() {
  if (pinCurrent === pinCorrect) {
    adminUnlocked = true;
    hidePinOverlay();
    document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
    document.querySelectorAll('.tab-bar').forEach(function(b){ b.classList.remove('visible'); });
    document.getElementById('admin').classList.add('active');
    document.querySelector('.phone').scrollTop = 0;
    initAdminDashboard();
    showToast('🔓 Accès accordé');
    setTimeout(function(){ adminUnlocked = false; showToast('🔒 Session expirée'); }, 30*60*1000);
  } else {
    pinAttemptCount++;
    var remaining = pinMaxAttempts - pinAttemptCount;
    for (var i = 0; i < 6; i++) { var d=document.getElementById('pd'+i); if(d) d.classList.add('error'); }
    setTimeout(function() {
      for (var i = 0; i < 6; i++) { var d=document.getElementById('pd'+i); if(d) d.classList.remove('error','filled'); }
      pinCurrent = '';
      var errEl = document.getElementById('pinError');
      var attEl = document.getElementById('pinAttempts');
      if (remaining <= 0) {
        pinLocked = true;
        if (errEl) errEl.textContent = '🔒 Bloqué — réessayez dans 5 min';
        setTimeout(function(){ pinLocked=false; pinAttemptCount=0; if(errEl)errEl.textContent=''; if(attEl)attEl.textContent=''; }, 5*60*1000);
      } else {
        if (errEl) errEl.textContent = '✗ Code incorrect';
        if (attEl) attEl.textContent = remaining + ' tentative(s) restante(s)';
        setTimeout(function(){ if(errEl)errEl.textContent=''; if(attEl)attEl.textContent=''; }, 1800);
      }
    }, 400);
  }
}

// ── RENDERERS ADMIN — style institutionnel monospace ──
function renderGeoList() {
  var c = document.getElementById('geoList'); if(!c) return;
  c.innerHTML = geoData.map(function(g){
    return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;">' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:9px;color:rgba(240,240,248,.3);width:80px;flex-shrink:0;letter-spacing:.04em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+ g.city.toUpperCase() +'</div>' +
      '<div style="flex:1;height:1px;background:rgba(255,255,255,.06);position:relative;"><div style="position:absolute;top:-0.5px;left:0;height:2px;width:'+ g.pct +'%;background:'+ g.color +';transition:width .6s;"></div></div>' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:9px;font-weight:700;color:'+ g.color +';width:28px;text-align:right;">'+ g.pct +'%</div>' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:8px;color:rgba(240,240,248,.2);width:32px;text-align:right;">'+ g.erp +'</div></div>';
  }).join('');
}
function renderContractTypes() {
  var c = document.getElementById('contractTypes'); if(!c) return;
  c.innerHTML = contractData.map(function(ct){
    return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;">' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:9px;color:rgba(240,240,248,.3);width:88px;flex-shrink:0;letter-spacing:.03em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+ ct.type.toUpperCase() +'</div>' +
      '<div style="flex:1;height:1px;background:rgba(255,255,255,.06);position:relative;"><div style="position:absolute;top:-0.5px;left:0;height:2px;width:'+ ct.pct +'%;background:#F5C842;"></div></div>' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:9px;font-weight:700;color:#F5C842;width:28px;text-align:right;">'+ ct.pct +'%</div></div>';
  }).join('');
}
function renderSysAlerts() {
  var c = document.getElementById('sysAlerts'); if(!c) return;
  var lc = {critical:'#FF3B3B',warn:'#F5C842',info:'rgba(240,240,248,.3)'};
  var li = {critical:'●',warn:'▲',info:'○'};
  c.innerHTML = sysAlertsData.map(function(a){
    var col = lc[a.level]||'#888';
    return '<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:7px;padding-bottom:7px;border-bottom:1px solid rgba(255,255,255,.04);">' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:9px;color:'+ col +';flex-shrink:0;padding-top:1px;">'+(li[a.level]||'○')+'</div>' +
      '<div><div style="font-family:\'DM Mono\',monospace;font-size:9px;color:'+ col +';font-weight:600;">'+ a.msg +'</div>' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:8px;color:rgba(240,240,248,.2);margin-top:2px;">'+ a.time +'</div></div></div>';
  }).join('');
}
function renderAdminActivity() {
  var c = document.getElementById('adminActivity'); if(!c) return;
  c.innerHTML = activityData.map(function(a){
    return '<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:6px;">' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:8px;color:rgba(240,240,248,.2);white-space:nowrap;flex-shrink:0;width:36px;">'+ a.time +'</div>' +
      '<div style="width:1px;height:10px;background:rgba(255,255,255,.08);flex-shrink:0;align-self:center;"></div>' +
      '<div style="font-family:\'DM Mono\',monospace;font-size:9px;color:rgba(240,240,248,.55);">'+ a.msg +'</div></div>';
  }).join('');
}
function renderAdminDate() {
  var el = document.getElementById('adminDate'); if(!el) return;
  var j=['DIM','LUN','MAR','MER','JEU','VEN','SAM'];
  var m=['JAN','FÉV','MAR','AVR','MAI','JUN','JUL','AOÛ','SEP','OCT','NOV','DÉC'];
  var n=new Date();
  el.textContent = j[n.getDay()]+' '+n.getDate()+' '+m[n.getMonth()]+' '+n.getFullYear();
}
function drawAdminChart(period) {
  var canvas = document.getElementById('adminRevenueChart'); if(!canvas) return;
  var data = revenueData[period];
  var vals = data.values; var labs = data.labels;
  var ctx = canvas.getContext('2d');
  var W = canvas.offsetWidth*2, H=(canvas.height||80)*2;
  canvas.width=W; canvas.height=H; ctx.clearRect(0,0,W,H);
  var mx=Math.max.apply(null,vals)*1.15;
  var pL=36,pR=8,pT=12,pB=20, w=W-pL-pR, h=H-pT-pB, n=vals.length;
  for(var g=0;g<=3;g++){var gy=pT+h-(h*g/3);ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pL,gy);ctx.lineTo(pL+w,gy);ctx.stroke();ctx.fillStyle='rgba(240,240,248,.15)';ctx.font='14px monospace';ctx.textAlign='right';ctx.fillText(Math.round(mx*g/3)+'k',pL-3,gy+4);}
  var pts=vals.map(function(v,i){return{x:pL+(i/(n-1))*w,y:pT+h-(v/mx)*h};});
  var grad=ctx.createLinearGradient(0,pT,0,pT+h);grad.addColorStop(0,'rgba(0,232,122,.18)');grad.addColorStop(1,'rgba(0,232,122,0)');
  ctx.beginPath();ctx.moveTo(pts[0].x,pT+h);pts.forEach(function(p){ctx.lineTo(p.x,p.y);});ctx.lineTo(pts[pts.length-1].x,pT+h);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);pts.forEach(function(p){ctx.lineTo(p.x,p.y);});ctx.strokeStyle='#00E87A';ctx.lineWidth=2.5;ctx.stroke();
  var lp=pts[pts.length-1];ctx.beginPath();ctx.arc(lp.x,lp.y,5,0,Math.PI*2);ctx.fillStyle='#00E87A';ctx.fill();
  var le=document.getElementById('adminChartLabels');
  if(le) le.innerHTML=labs.map(function(l){return '<span style="font-family:\'DM Mono\',monospace;font-size:8px;letter-spacing:.04em;">'+l+'</span>';}).join('');
}
function setAdminPeriod(el,period){
  document.querySelectorAll('.admin-period').forEach(function(b){b.style.background='transparent';b.style.color='rgba(240,240,248,.25)';b.style.borderColor='rgba(255,255,255,.07)';});
  el.style.background='rgba(0,232,122,.12)';el.style.color='#00E87A';el.style.borderColor='rgba(0,232,122,.25)';
  adminPeriod=period; drawAdminChart(period);
}

// ══════════════════════════════════════════════
// 🌙 MODE SOIRÉE — variables & données
// ══════════════════════════════════════════════
var soireeZoneSel  = 'tours';
var soireeVibeSel  = 'detente';
var soireeMinScore = 80;

var soireePools = {
  tours:      [0, 2, 3, 5],
  marais:     [4, 5, 6],
  oberkampf:  [1, 4, 6],
  bastille:   [1, 3, 5, 6]
};

var vibeTexts = {
  detente:  { label:'Détendu',    emoji:'🍷', tag:'Chill & talk'   },
  festif:   { label:'On se lâche',emoji:'🎉', tag:'Full energy'    },
  cocktail: { label:'Cocktails',  emoji:'🍸', tag:'Classy vibes'   },
  live:     { label:'Live music', emoji:'🎵', tag:'Son à fond'     }
};

var zoneLabels = { tours:'Tours Centre', marais:'Le Marais', oberkampf:'Oberkampf', bastille:'Bastille' };

// Historique en mémoire (2 exemples)
var soireeHistoryData = [
  { zone:'tours',    barNames:['Le Vieux Murier','Le Piano','Café Promenade'], avgScore:86, daysAgo:5,  emoji:'🎉' },
  { zone:'marais',   barNames:['L\'Entrepôt','Bar Oberkampf','Le Labo','Chez Paul'], avgScore:91, daysAgo:12, emoji:'🍷' }
];

function openSoireeMode() {
  document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('.tab-bar').forEach(function(b){ b.classList.remove('visible'); });
  document.getElementById('soiree').classList.add('active');
  document.querySelector('.phone').scrollTop = 0;
  // Cacher résultats à l'ouverture
  var res = document.getElementById('soireeResults');
  if (res) res.style.display = 'none';
}

function selectSoireeZone(el) {
  document.querySelectorAll('#soireeZones .s-zone').forEach(function(z){ z.classList.remove('active'); });
  el.classList.add('active');
  soireeZoneSel = el.dataset.zone;
  // Masquer résultats au changement
  var res = document.getElementById('soireeResults');
  if (res) res.style.display = 'none';
}

function selectVibe(el) {
  document.querySelectorAll('#soireeVibes .s-vibe').forEach(function(v){ v.classList.remove('active'); });
  el.classList.add('active');
  soireeVibeSel = el.dataset.vibe;
}

function selectSoireeScore(el) {
  document.querySelectorAll('#soireeScores .s-score').forEach(function(s){
    s.classList.remove('active');
  });
  el.classList.add('active');
  soireeMinScore = parseInt(el.dataset.min);
}

function generateItinerary() {
  var pool = soireePools[soireeZoneSel] || [0,1,2];

  // Filtrer par score minimum
  var eligible = pool.filter(function(i){ return bars[i] && bars[i].score >= soireeMinScore; });
  if (eligible.length < 2) eligible = pool.slice(); // fallback : tous les bars du pool

  // Shuffle Fisher-Yates
  for (var i = eligible.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = eligible[i]; eligible[i] = eligible[j]; eligible[j] = tmp;
  }

  // Prendre 3 à 4 bars
  var nbPicks = Math.min(eligible.length, 3 + Math.floor(Math.random() * 2));
  var picks = eligible.slice(0, nbPicks);

  // Calcul score moyen
  var avgScore = Math.round(picks.reduce(function(s, i){ return s + (bars[i] ? bars[i].score : 80); }, 0) / picks.length);

  // Vibe courant
  var vibe = vibeTexts[soireeVibeSel] || vibeTexts.detente;

  // Titres dynamiques selon zone & vibe
  var titleOptions = {
    festif:   ['Soirée de folie 🔥', 'Ce soir ça déchire !', 'On va tout défoncer 🎉'],
    detente:  ['Soirée tranquille 🍷', 'Le bon plan ce soir', 'Chill guaranteed ✌️'],
    cocktail: ['La soirée cocktail 🍸', 'Shaker en main 🍹', 'Classy as always'],
    live:     ['Son à donf ce soir 🎵', 'La soirée live !', 'Musique & bonne humeur 🎸']
  };
  var titles = titleOptions[soireeVibeSel] || titleOptions.detente;
  var chosenTitle = titles[Math.floor(Math.random() * titles.length)];

  // Afficher headline
  var titleEl = document.getElementById('soireeResultTitle');
  var subEl   = document.getElementById('soireeResultSub');
  if (titleEl) titleEl.textContent = chosenTitle;
  if (subEl)   subEl.textContent   = picks.length + ' spots validés · Score moyen ' + avgScore + '/100';

  // Générer les stops
  var itinEl = document.getElementById('soireeItinerary');
  if (itinEl) {
    var stopColors = ['rgba(0,200,120,.2)','rgba(160,40,255,.2)','rgba(255,60,180,.2)','rgba(255,180,0,.2)'];
    var stopTxtColors = ['#00C878','#C060FF','#FF60C0','#FFB400'];
    var estHeures = ['21h30','22h45','00h00','01h30'];

    itinEl.innerHTML = picks.map(function(barIdx, idx) {
      var bar = bars[barIdx] || { name:'Bar', address:'', score:80 };
      var isLast = idx === picks.length - 1;
      var scoreColor = bar.score >= 85 ? '#00C878' : bar.score >= 70 ? '#E8B84B' : '#FF6B6B';

      return '<div class="s-stop">' +
        // Numéro + connecteur vertical
        '<div style="display:flex;flex-direction:column;align-items:center;gap:0;flex-shrink:0;">' +
          '<div class="s-stop-num" style="background:' + stopColors[idx%4] + ';color:' + stopTxtColors[idx%4] + ';">' + (idx+1) + '</div>' +
          (!isLast ? '<div style="width:1px;flex:1;min-height:16px;background:linear-gradient(to bottom,'+stopTxtColors[idx%4]+'40,transparent);margin-top:4px;"></div>' : '') +
        '</div>' +
        // Contenu
        '<div style="flex:1;padding-bottom:' + (isLast ? '0' : '4px') + ';">' +
          '<div style="font-size:14px;font-weight:800;color:#fff;margin-bottom:3px;">' + bar.name + '</div>' +
          '<div style="font-size:11px;color:rgba(255,255,255,.4);margin-bottom:6px;">' + (bar.address || bar.type || '') + '</div>' +
          '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">' +
            '<div style="background:rgba(0,0,0,.3);border:1px solid ' + scoreColor + '40;border-radius:8px;padding:3px 8px;font-size:11px;font-weight:700;color:' + scoreColor + ';">' + bar.score + '/100</div>' +
            '<div style="background:rgba(160,40,255,.15);border:1px solid rgba(160,40,255,.25);border-radius:8px;padding:3px 8px;font-size:10px;color:#C060FF;">' + vibe.emoji + ' ' + vibe.tag + '</div>' +
            '<div style="font-size:10px;color:rgba(255,255,255,.3);">≈ ' + (estHeures[idx] || '') + '</div>' +
          '</div>' +
        '</div>' +
        // Bouton voir
        '<div onclick="openModal(' + barIdx + ')" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px 10px;font-size:11px;color:rgba(255,255,255,.5);cursor:pointer;flex-shrink:0;margin-top:2px;font-weight:700;">Voir ›</div>' +
      '</div>';
    }).join('');
  }

  // Afficher les résultats avec animation
  var res = document.getElementById('soireeResults');
  if (res) {
    res.style.display = 'block';
    res.style.opacity = '0';
    res.style.transform = 'translateY(12px)';
    setTimeout(function(){
      res.style.transition = 'opacity .35s ease, transform .35s ease';
      res.style.opacity = '1';
      res.style.transform = 'translateY(0)';
    }, 20);
    setTimeout(function(){ res.scrollIntoView({ behavior:'smooth', block:'start' }); }, 100);
  }

  showToast('✨ ' + picks.length + ' spots trouvés — bonne soirée ! 🎉');
}

function shareItinerary() {
  showToast('📤 Lien copié ! Envoie ça à tes potes 🔥');
}

function replaySoiree(idx) {
  var h = soireeHistoryData[idx];
  if (!h) return;
  // Restaurer la zone
  soireeZoneSel = h.zone;
  document.querySelectorAll('#soireeZones .s-zone').forEach(function(z){
    z.classList.toggle('active', z.dataset.zone === h.zone);
  });
  // Rebuild itinéraire depuis l'historique
  var titleEl = document.getElementById('soireeResultTitle');
  var subEl   = document.getElementById('soireeResultSub');
  if (titleEl) titleEl.textContent = 'Soirée ' + zoneLabels[h.zone];
  if (subEl)   subEl.textContent   = h.barNames.length + ' bars · Score moyen ' + h.avgScore + '/100';

  var itinEl = document.getElementById('soireeItinerary');
  var stopColors = ['rgba(0,200,120,.2)','rgba(160,40,255,.2)','rgba(255,60,180,.2)','rgba(255,180,0,.2)'];
  var stopTxt    = ['#00C878','#C060FF','#FF60C0','#FFB400'];
  var estH = ['21h30','22h45','00h00','01h30'];
  if (itinEl) {
    itinEl.innerHTML = h.barNames.map(function(name, i){
      return '<div class="s-stop">' +
        '<div class="s-stop-num" style="background:'+stopColors[i%4]+';color:'+stopTxt[i%4]+';">'+(i+1)+'</div>' +
        '<div style="flex:1;"><div style="font-size:14px;font-weight:800;color:#fff;margin-bottom:3px;">'+name+'</div>' +
        '<div style="font-size:10px;color:rgba(255,255,255,.3);">≈ '+estH[i]+'</div></div>' +
      '</div>';
    }).join('');
  }
  var res = document.getElementById('soireeResults');
  if (res) { res.style.display='block'; res.style.opacity='1'; res.style.transform='none'; }
  document.querySelector('.phone').scrollTop = 0;
  showToast('📅 Soirée du ' + h.daysAgo + ' jours chargée !');
}
</script>

  <!-- ════════ PIN ADMIN OVERLAY ════════ -->
  <div id="adminPinOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(7,8,15,0.97);backdrop-filter:blur(20px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:0;">

    <!-- Logo clé -->
    <div style="background:linear-gradient(135deg,#3d0000,#600000);border-radius:20px;width:64px;height:64px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 0 40px rgba(255,59,59,0.2);">
      <svg width="32" height="32" viewBox="0 0 28 28" fill="none">
        <circle cx="10" cy="13" r="5.5" fill="rgba(255,59,59,.18)" stroke="#FF3B3B" stroke-width="1.8"/>
        <circle cx="10" cy="13" r="2.2" fill="#FF3B3B"/>
        <path d="M14 15.5L24 21" stroke="#FF3B3B" stroke-width="2" stroke-linecap="round"/>
        <path d="M20 19.5v3.5M23 18v3.5" stroke="#FF3B3B" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
    </div>

    <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#F0F0F8;margin-bottom:4px;">Accès Administration</div>
    <div style="font-size:12px;color:rgba(240,240,248,0.4);margin-bottom:32px;">Code PIN requis</div>

    <!-- Affichage points PIN -->
    <div style="display:flex;gap:14px;margin-bottom:28px;" id="pinDots">
      <div class="pin-dot" id="pd0"></div>
      <div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div>
      <div class="pin-dot" id="pd3"></div>
      <div class="pin-dot" id="pd4"></div>
      <div class="pin-dot" id="pd5"></div>
    </div>

    <!-- Message erreur -->
    <div id="pinError" style="font-size:12px;color:#FF3B3B;margin-bottom:16px;height:16px;text-align:center;"></div>
    <!-- Tentatives restantes -->
    <div id="pinAttempts" style="font-size:11px;color:rgba(240,240,248,0.3);margin-bottom:24px;height:14px;"></div>

    <!-- Clavier numérique -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:240px;">
      <div class="pin-key" onclick="pinPress('1')">1</div>
      <div class="pin-key" onclick="pinPress('2')">2</div>
      <div class="pin-key" onclick="pinPress('3')">3</div>
      <div class="pin-key" onclick="pinPress('4')">4</div>
      <div class="pin-key" onclick="pinPress('5')">5</div>
      <div class="pin-key" onclick="pinPress('6')">6</div>
      <div class="pin-key" onclick="pinPress('7')">7</div>
      <div class="pin-key" onclick="pinPress('8')">8</div>
      <div class="pin-key" onclick="pinPress('9')">9</div>
      <div class="pin-key pin-key-action" onclick="pinCancel()" style="font-size:12px;color:rgba(240,240,248,0.4);">Annuler</div>
      <div class="pin-key" onclick="pinPress('0')">0</div>
      <div class="pin-key pin-key-action" onclick="pinDelete()">⌫</div>
    </div>

    <!-- Indicateur sécurité -->
    <div style="display:flex;align-items:center;gap:6px;margin-top:28px;opacity:.4;">
      <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
        <path d="M8 1L2 4v4c0 3.5 2.5 6.8 6 7.5C11.5 14.8 14 11.5 14 8V4z" stroke="#FF3B3B" stroke-width="1.4"/>
      </svg>
      <span style="font-size:10px;color:rgba(240,240,248,0.5);">Connexion chiffrée · Session 30 min</span>
    </div>
  </div>

  <!-- ════════ MODE SOIRÉE SÉCURISÉE ════════ -->
</body>
</html>
